This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.gitignore
api/analyze.ts
api/checkout.ts
api/webhooks/polar.ts
App.tsx
components/AIAttention.tsx
components/AIOptimizedIndicator.tsx
components/AIOrb.tsx
components/AIWhisper.tsx
components/AuthModal.tsx
components/Background.tsx
components/CosmicParticles.tsx
components/CountdownNotification.tsx
components/ExerciseCard.tsx
components/ExerciseModal.tsx
components/FocusTimer.tsx
components/GoldVault.tsx
components/Header.tsx
components/ImmersiveJourney.tsx
components/LandingPage.tsx
components/PricingModal.tsx
components/QuantumRippleBackground.tsx
components/RelaxTimer.tsx
components/Sidebar.tsx
components/StatsView.tsx
components/TaskList.tsx
components/TopBar.tsx
components/TopNav.tsx
deploy.md
fix_database.sql
ghost_migration.sql
hooks/useQuantumRipple.ts
hooks/useSubscription.ts
index.html
index.tsx
metadata.json
package.json
polar_sync.sql
README.md
reset_database_completely.sql
services/ambientSound.ts
services/authService.ts
services/databaseService.ts
services/fatigueService.ts
services/geminiService.ts
services/ollamaService.ts
services/supabase.ts
supabase_migration_monetization.sql
supabase_migration.sql
SUPABASE_SETUP.md
tsconfig.json
types.ts
vercel.json
verify_database.sql
vite-env.d.ts
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="api/webhooks/polar.ts">
import { createClient } from "@supabase/supabase-js";

export const config = {
    runtime: "edge",
};

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export default async function handler(req: Request) {
    if (req.method !== "POST") {
        return new Response(JSON.stringify({ error: "Method not allowed" }), {
            status: 405,
            headers: { "Content-Type": "application/json" },
        });
    }

    try {
        const body = await req.json();
        const { type, data } = body;

        console.log(`[POLAR WEBHOOK] Received event: ${type}`);

        switch (type) {
            case "checkout.created":
                console.log(`[POLAR WEBHOOK] Checkout created: ${data.id}`);
                break;

            case "subscription.active":
            case "subscription.updated":
            case "subscription.revoked":
                const subscription = data;
                const userId = subscription.customer_metadata?.supabase_user_id || subscription.user_id;

                console.log(`[POLAR WEBHOOK] Syncing subscription ${subscription.id} for user ${userId}`);

                const { error } = await supabaseAdmin
                    .from("profiles")
                    .update({
                        is_premium: subscription.status === 'active',
                        subscription_id: subscription.id
                    })
                    .eq("id", userId);

                if (error) {
                    console.error(`[POLAR WEBHOOK] Sync error: ${error.message}`);
                    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
                }
                break;

            default:
                console.log(`[POLAR WEBHOOK] Unhandled event type: ${type}`);
        }

        return new Response(JSON.stringify({ received: true }), {
            status: 200,
            headers: { "Content-Type": "application/json" },
        });

    } catch (error: any) {
        console.error("[POLAR WEBHOOK] Error:", error.message);
        return new Response(JSON.stringify({ error: error.message }), {
            status: 400,
            headers: { "Content-Type": "application/json" },
        });
    }
}
</file>

<file path="components/AIAttention.tsx">
import React from 'react';
import { motion } from 'framer-motion';

const MotionDiv = motion.div as any;

interface AIAttentionProps {
  children: React.ReactNode;
  className?: string;
  onClick?: () => void;
}

export const AIAttention: React.FC<AIAttentionProps> = ({ children, className = "", onClick }) => {
  return (
    <MotionDiv
      className={`relative group ${className}`}
      onClick={onClick}
      whileHover="hover"
      initial="initial"
    >
      {/* The Attention Field - Soft Radial Ripple */}
      <MotionDiv
        variants={{
          initial: { opacity: 0, scale: 0.8 },
          hover: { opacity: 0.15, scale: 1.4 }
        }}
        transition={{ duration: 0.4, ease: "easeOut" }}
        className="absolute inset-0 bg-radial-gradient from-indigo-400 to-transparent rounded-xl blur-md -z-10 bg-indigo-400"
      />

      {/* Scanning Line Effect */}
      <MotionDiv
        variants={{
          initial: { opacity: 0, x: '-100%' },
          hover: { opacity: 0.5, x: '200%' }
        }}
        transition={{ duration: 1.5, repeat: Infinity, ease: "linear" }}
        className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent skew-x-12 pointer-events-none -z-10"
      />

      {children}
    </MotionDiv>
  );
};
</file>

<file path="components/AIOrb.tsx">
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { BrainCircuit, Coffee, Activity, Sparkles, X, Zap } from 'lucide-react';
import { AppMode, SessionStatus } from '../types';

const MotionDiv = motion.div as any;
const MotionButton = motion.button as any;

interface AIOrbProps {
  currentMode: AppMode;
  setMode: (mode: AppMode) => void;
  status: SessionStatus;
  fatigueScore: number;
}

export const AIOrb: React.FC<AIOrbProps> = ({ currentMode, setMode, status, fatigueScore }) => {
  const [isOpen, setIsOpen] = useState(false);

  // Determine Orb Color based on State & Fatigue
  const getOrbColor = () => {
    if (status === SessionStatus.RUNNING) {
      if (fatigueScore > 70) return 'bg-rose-500 shadow-rose-500/50';
      if (fatigueScore > 40) return 'bg-amber-400 shadow-amber-400/50';
      return 'bg-blue-500 shadow-blue-500/50';
    }
    if (currentMode === AppMode.RELAX) return 'bg-emerald-500 shadow-emerald-500/50';
    return 'bg-violet-600 shadow-violet-600/50';
  };

  const orbColorClass = getOrbColor();

  const menuItems = [
    { mode: AppMode.FOCUS, icon: BrainCircuit, label: 'Focus Mode', color: 'text-blue-400' },
    { mode: AppMode.RELAX, icon: Coffee, label: 'Relaxation', color: 'text-emerald-400' },
    { mode: AppMode.STATS, icon: Activity, label: 'Insights', color: 'text-rose-400' },
  ];

  return (
    <div className="fixed bottom-8 right-8 z-50 flex flex-col items-end">
      
      {/* Expandable Menu */}
      <AnimatePresence>
        {isOpen && (
          <MotionDiv
            initial={{ opacity: 0, scale: 0.8, y: 20 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.8, y: 20 }}
            transition={{ type: "spring", stiffness: 300, damping: 20 }}
            className="mb-6 flex flex-col items-end gap-3"
          >
            {menuItems.map((item) => (
              <MotionButton
                key={item.mode}
                whileHover={{ scale: 1.05, x: -4 }}
                whileTap={{ scale: 0.95 }}
                onClick={() => {
                  setMode(item.mode);
                  setIsOpen(false);
                }}
                className={`group flex items-center gap-3 px-4 py-3 rounded-2xl backdrop-blur-xl border border-white/10 shadow-2xl ${currentMode === item.mode ? 'bg-white/10' : 'bg-black/60 hover:bg-black/80'}`}
              >
                <span className="text-sm font-medium text-gray-200">{item.label}</span>
                <div className={`p-2 rounded-xl bg-white/5 ${item.color}`}>
                  <item.icon className="w-5 h-5" />
                </div>
              </MotionButton>
            ))}
            
            <div className="h-px w-full bg-gradient-to-r from-transparent via-white/10 to-transparent my-2" />
            
            {/* Status Indicator */}
            <div className="px-4 py-2 bg-black/40 backdrop-blur-md rounded-lg border border-white/5 flex items-center gap-2">
                <div className="flex flex-col items-end">
                    <span className="text-[10px] uppercase tracking-wider text-gray-500">Fatigue Level</span>
                    <span className={`text-xs font-bold ${fatigueScore > 50 ? 'text-amber-400' : 'text-emerald-400'}`}>{fatigueScore}%</span>
                </div>
                <Zap className={`w-4 h-4 ${fatigueScore > 50 ? 'text-amber-400' : 'text-emerald-400'}`} />
            </div>
          </MotionDiv>
        )}
      </AnimatePresence>

      {/* Main Orb Button */}
      <MotionButton
        onClick={() => setIsOpen(!isOpen)}
        className={`relative w-14 h-14 rounded-full flex items-center justify-center text-white ${orbColorClass} backdrop-blur-sm border border-white/20 transition-colors duration-500`}
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.9 }}
        animate={{
            boxShadow: isOpen 
                ? "0 0 0 0 rgba(0,0,0,0)" 
                : [
                    "0 0 20px -5px currentColor",
                    "0 0 30px -2px currentColor",
                    "0 0 20px -5px currentColor"
                ]
        }}
        transition={{
            boxShadow: {
                duration: 3,
                repeat: Infinity,
                ease: "easeInOut"
            }
        }}
        style={{ boxShadow: "0 10px 30px -10px rgba(0,0,0,0.5)" }}
      >
        <AnimatePresence mode="wait">
            {isOpen ? (
                <MotionDiv
                    key="close"
                    initial={{ rotate: -90, opacity: 0 }}
                    animate={{ rotate: 0, opacity: 1 }}
                    exit={{ rotate: 90, opacity: 0 }}
                >
                    <X className="w-6 h-6" />
                </MotionDiv>
            ) : (
                <MotionDiv
                    key="open"
                    initial={{ scale: 0, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0, opacity: 0 }}
                >
                    <Sparkles className="w-6 h-6 fill-white/20" />
                </MotionDiv>
            )}
        </AnimatePresence>
        
        {/* Ambient Ring */}
        <div className="absolute inset-0 rounded-full border border-white/30 opacity-50 animate-ping-slow pointer-events-none" />
      </MotionButton>
    </div>
  );
};
</file>

<file path="components/AIWhisper.tsx">
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

const MotionDiv = motion.div as any;

const MESSAGES = [
  'Stability increasing...',
  'Cognitive load leveling...',
  'Neural flow optimal.',
  'Interference low.',
  'Biometric sync established.',
  'Entropy reducing...',
  'Waveform steady.',
  'Pattern recognition active.',
  'Mental state: coherent.',
  'System optimal.',
  'Focus depth: nominal.'
];

export const AIWhisper: React.FC = () => {
  const [message, setMessage] = useState<string | null>(null);

  useEffect(() => {
    let timeoutId: number;

    const triggerMessage = () => {
      const msg = MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
      setMessage(msg);

      // Hide message after 5 seconds
      window.setTimeout(() => setMessage(null), 5000);

      // Schedule next message: 5 to 10 minutes (300,000ms - 600,000ms)
      const nextDelay = 300000 + Math.random() * 300000;
      timeoutId = window.setTimeout(triggerMessage, nextDelay);
    };

    // Initial trigger shortly after mount
    timeoutId = window.setTimeout(triggerMessage, 15000);

    return () => window.clearTimeout(timeoutId);
  }, []);

  return (
    <div className="fixed bottom-8 right-8 z-40 pointer-events-none mix-blend-plus-lighter">
      <AnimatePresence>
        {message && (
          <MotionDiv
            initial={{ opacity: 0, x: 20, filter: 'blur(8px)' }}
            animate={{ opacity: 1, x: 0, filter: 'blur(0px)' }}
            exit={{ opacity: 0, x: 10, filter: 'blur(8px)' }}
            transition={{ duration: 1.2, ease: [0.16, 1, 0.3, 1] }}
            className="flex flex-col items-end gap-1"
          >
            {/* Decorative Line */}
            <div className="h-px w-12 bg-gradient-to-l from-indigo-400/40 to-transparent" />
            
            <div className="flex items-center gap-3">
              <span className="font-mono text-[9px] tracking-[0.3em] text-indigo-200/50 uppercase select-none">
                SYS :: {message}
              </span>
              <div className="w-1 h-1 bg-indigo-500/50 rounded-full animate-pulse" />
            </div>
          </MotionDiv>
        )}
      </AnimatePresence>
    </div>
  );
};
</file>

<file path="components/Background.tsx">
import React, { useEffect, useState, useCallback } from 'react';
import { motion, useSpring, useMotionValue, useTransform, AnimatePresence, useMotionTemplate } from 'framer-motion';

const MotionDiv = motion.div as any;

// Types for the neural pulses
interface NeuralPulse {
  id: number;
  x: number;
  y: number;
  direction: 'horizontal' | 'vertical';
  distance: number;
  duration: number;
  delay: number;
}

export const Background: React.FC = () => {
  // Parallax Values (Normalized -1 to 1)
  const mouseX = useMotionValue(0);
  const mouseY = useMotionValue(0);

  // Raw Pixel Values for Dimensional Cursor
  const mouseXPixels = useMotionValue(0);
  const mouseYPixels = useMotionValue(0);

  // Smooth out mouse movements for parallax
  const springConfig = { damping: 50, stiffness: 400 };
  const x = useSpring(useTransform(mouseX, [-1, 1], [-15, 15]), springConfig);
  const y = useSpring(useTransform(mouseY, [-1, 1], [-15, 15]), springConfig);

  const [pulses, setPulses] = useState<NeuralPulse[]>([]);

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      const { innerWidth, innerHeight } = window;
      // Normalize mouse coordinates to -1 to 1 for parallax
      mouseX.set((e.clientX / innerWidth) * 2 - 1);
      mouseY.set((e.clientY / innerHeight) * 2 - 1);

      // Update raw pixels for local distortion
      mouseXPixels.set(e.clientX);
      mouseYPixels.set(e.clientY);
    };

    window.addEventListener('mousemove', handleMouseMove);
    return () => window.removeEventListener('mousemove', handleMouseMove);
  }, [mouseX, mouseY, mouseXPixels, mouseYPixels]);

  // Create dynamic mask for the dimensional warp
  // Slightly reduced radius for tighter "force field" feel
  const warpMask = useMotionTemplate`radial-gradient(circle 100px at ${mouseXPixels}px ${mouseYPixels}px, black, transparent)`;

  // Neural Pulse Logic
  useEffect(() => {
    let timeoutId: number;
    let pulseCount = 0;

    const spawnPulse = () => {
      // Grid size is roughly 60px based on CSS below. Snap to grid-ish coordinates.
      const gridSize = 60;
      const isVertical = Math.random() > 0.5;

      const pulse: NeuralPulse = {
        id: Date.now() + pulseCount++,
        // Snap to grid lines roughly
        x: Math.round((Math.random() * window.innerWidth) / gridSize) * gridSize,
        y: Math.round((Math.random() * window.innerHeight) / gridSize) * gridSize,
        direction: isVertical ? 'vertical' : 'horizontal',
        distance: 200 + Math.random() * 300, // Length of travel
        duration: 3 + Math.random() * 4, // Slow travel speed
        delay: 0
      };

      setPulses(prev => [...prev, pulse]);

      // Cleanup pulse after animation
      setTimeout(() => {
        setPulses(prev => prev.filter(p => p.id !== pulse.id));
      }, (pulse.duration * 1000) + 100);

      // Schedule next pulse (20s to 40s)
      const nextInterval = (20000 + Math.random() * 20000);
      timeoutId = window.setTimeout(spawnPulse, nextInterval);
    };

    // Initial delay before first pulse
    timeoutId = window.setTimeout(spawnPulse, 5000);

    return () => clearTimeout(timeoutId);
  }, []);

  return (
    <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden select-none bg-[#09090b]">

      {/* Container for Grid + Parallax */}
      <MotionDiv
        style={{ x, y }}
        className="absolute inset-[-50px] opacity-[0.15] transition-opacity duration-1000" // Brightened from 0.07 to 0.15
        animate={{
          x: [0, 5, 0], // Slow drift
          y: [0, -5, 0]
        }}
        transition={{
          duration: 20,
          repeat: Infinity,
          ease: "linear"
        }}
      >
        {/* Base Grid Layer */}
        <div
          className="absolute inset-0 w-full h-full"
          style={{
            backgroundImage: `
              linear-gradient(to right, #e4e4e7 1px, transparent 1px),
              linear-gradient(to bottom, #e4e4e7 1px, transparent 1px)
            `,
            backgroundSize: '60px 60px',
            maskImage: 'radial-gradient(circle at 50% 50%, black 40%, transparent 100%)',
            WebkitMaskImage: 'radial-gradient(circle at 50% 50%, black 40%, transparent 100%)'
          }}
        />

        {/* Glowing Nodes / Stars - Randomly placed */}
        {Array.from({ length: 8 }).map((_, i) => (
          <MotionDiv
            key={i}
            className="absolute w-[3px] h-[3px] bg-white rounded-full shadow-[0_0_8px_white]"
            style={{
              left: `${Math.random() * 100}%`,
              top: `${Math.random() * 100}%`,
            }}
            animate={{
              opacity: [0, 0.8, 0],
              scale: [0.5, 1.5, 0.5]
            }}
            transition={{
              duration: 3 + Math.random() * 4,
              repeat: Infinity,
              delay: Math.random() * 5
            }}
          />
        ))}

        {/* Subtle Drifting Particles - Extra layer for depth */}
        {Array.from({ length: 15 }).map((_, i) => (
          <MotionDiv
            key={`particle-${i}`}
            className="absolute w-[1px] h-[1px] bg-indigo-300 rounded-full"
            style={{
              left: `${Math.random() * 100}%`,
              top: `${Math.random() * 100}%`,
            }}
            animate={{
              y: [0, -20 - Math.random() * 30],
              opacity: [0, 0.3, 0],
            }}
            transition={{
              duration: 10 + Math.random() * 10,
              repeat: Infinity,
              delay: Math.random() * 10,
              ease: "linear"
            }}
          />
        ))}

        {/* Dimensional Warp Layer (Cursor Distortion) */}
        {/* Scale reduced to 1.005 for a subtle 1-2px shift at edges of the lens */}
        <MotionDiv
          className="absolute inset-0 w-full h-full opacity-60 mix-blend-overlay"
          style={{
            backgroundImage: `
              linear-gradient(to right, #a1a1aa 1px, transparent 1px),
              linear-gradient(to bottom, #a1a1aa 1px, transparent 1px)
            `,
            backgroundSize: '60px 60px',
            scale: 1.005, // Very subtle scale for 1px warp
            maskImage: warpMask,
            WebkitMaskImage: warpMask,
          }}
        />

        {/* Neural Pulse Lines Layer */}
        <AnimatePresence>
          {pulses.map(pulse => (
            <MotionDiv
              key={pulse.id}
              initial={{
                opacity: 0,
                left: pulse.x,
                top: pulse.y,
                width: pulse.direction === 'horizontal' ? 0 : 1,
                height: pulse.direction === 'vertical' ? 0 : 1
              }}
              animate={{
                opacity: [0, 0.2, 0], // Reduced max opacity for faintness
                width: pulse.direction === 'horizontal' ? pulse.distance : 1,
                height: pulse.direction === 'vertical' ? pulse.distance : 1,
              }}
              transition={{
                duration: pulse.duration,
                ease: "linear"
              }}
              className="absolute bg-indigo-400/20 shadow-[0_0_8px_rgba(129,140,248,0.2)]"
              style={{
                // Gradient to look like a signal trail
                background: pulse.direction === 'horizontal'
                  ? 'linear-gradient(90deg, transparent, rgba(129,140,248,0.3), transparent)'
                  : 'linear-gradient(180deg, transparent, rgba(129,140,248,0.3), transparent)'
              }}
            />
          ))}
        </AnimatePresence>
      </MotionDiv>

      {/* Floating Ambient Orbs - Endel Style */}
      <MotionDiv
        animate={{
          x: [0, 30, -20, 0],
          y: [0, -40, 20, 0],
          scale: [1, 1.1, 0.9, 1]
        }}
        transition={{ duration: 25, repeat: Infinity, ease: "easeInOut" }}
        className="absolute top-[-20%] left-[-10%] w-[50vw] h-[50vw] bg-indigo-500/10 rounded-full blur-[120px] mix-blend-screen"
      />
      <MotionDiv
        animate={{
          x: [0, -40, 30, 0],
          y: [0, 30, -50, 0],
          scale: [1, 1.2, 0.95, 1]
        }}
        transition={{ duration: 30, repeat: Infinity, ease: "easeInOut", delay: 2 }}
        className="absolute top-[20%] right-[-10%] w-[40vw] h-[40vw] bg-violet-500/10 rounded-full blur-[100px] mix-blend-screen"
      />
      <MotionDiv
        animate={{
          x: [0, 20, -30, 0],
          y: [0, -20, 40, 0],
          scale: [1, 0.9, 1.1, 1]
        }}
        transition={{ duration: 28, repeat: Infinity, ease: "easeInOut", delay: 5 }}
        className="absolute bottom-[-10%] left-[20%] w-[45vw] h-[45vw] bg-blue-500/5 rounded-full blur-[140px] mix-blend-screen"
      />

      {/* Top Gradient Overlay for Depth */}
      <div className="absolute top-0 inset-x-0 h-64 bg-gradient-to-b from-[#09090b] to-transparent opacity-80" />

      {/* Vignette */}
      <div className="absolute inset-0 bg-radial-gradient from-transparent to-[#09090b]/80" />
    </div>
  );
};
</file>

<file path="components/CosmicParticles.tsx">
import React, { useMemo } from 'react';
import { motion } from 'framer-motion';

const MotionDiv = motion.div as any;

export const CosmicParticles: React.FC = () => {
  // Generate stable random positions for particles
  const particles = useMemo(() => {
    return Array.from({ length: 40 }).map((_, i) => ({
      id: i,
      x: Math.random() * 100, // %
      y: Math.random() * 100, // %
      size: Math.random() > 0.8 ? 2 : 1, // 1px or 2px
      opacity: 0.1 + Math.random() * 0.2, // Low opacity
      duration: 20 + Math.random() * 40, // Very slow movement
      delay: Math.random() * -20,
    }));
  }, []);

  return (
    <div className="fixed inset-0 z-[1] pointer-events-none overflow-hidden">
      {particles.map((p) => (
        <MotionDiv
          key={p.id}
          className="absolute bg-white rounded-full mix-blend-screen"
          style={{
            left: `${p.x}%`,
            top: `${p.y}%`,
            width: p.size,
            height: p.size,
          }}
          initial={{ opacity: 0 }}
          animate={{
            y: [0, -30, 0], // Slow vertical drift
            x: [0, 15, 0], // Slight horizontal drift
            opacity: [0, p.opacity, 0], // Twinkle in and out
          }}
          transition={{
            duration: p.duration,
            repeat: Infinity,
            ease: "linear",
            delay: p.delay,
          }}
        />
      ))}
      
      {/* Subtle Dust Texture Overlay */}
      <div 
        className="absolute inset-0 opacity-[0.03] mix-blend-overlay pointer-events-none"
        style={{
          backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E")`,
        }}
      />
    </div>
  );
};
</file>

<file path="components/ExerciseModal.tsx">
import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X } from 'lucide-react';

interface Exercise {
    emoji: string;
    label: string;
    description: string;
    duration: number;
    animationType: 'breathing' | 'eye' | 'posture' | 'stretch' | 'sunlight' | 'neck' | 'silence';
}

interface ExerciseModalProps {
    exercise: Exercise;
    onClose: () => void;
}

const MotionDiv = motion.div as any;

export const ExerciseModal: React.FC<ExerciseModalProps> = ({ exercise, onClose }) => {
    const [timeLeft, setTimeLeft] = useState(exercise.duration);
    const [phase, setPhase] = useState<'inhale' | 'hold' | 'exhale'>('inhale');

    useEffect(() => {
        if (timeLeft <= 0) {
            onClose();
            return;
        }
        const timer = setInterval(() => setTimeLeft((p) => p - 1), 1000);
        return () => clearInterval(timer);
    }, [timeLeft, onClose]);

    // Breathing cycle for breathing exercise
    useEffect(() => {
        if (exercise.animationType === 'breathing') {
            const cycle = setInterval(() => {
                setPhase(p => p === 'inhale' ? 'hold' : p === 'hold' ? 'exhale' : 'inhale');
            }, 4000);
            return () => clearInterval(cycle);
        }
    }, [exercise.animationType]);

    const renderAnimation = () => {
        switch (exercise.animationType) {
            case 'breathing':
                return (
                    <div className="relative mb-8 flex items-center justify-center">
                        <MotionDiv
                            className={`w-48 h-48 rounded-full border-2 border-indigo-500/30 flex items-center justify-center transition-all duration-[4000ms] ease-in-out ${phase === 'inhale' ? 'scale-110 bg-indigo-900/20' :
                                    phase === 'exhale' ? 'scale-90 bg-transparent' :
                                        'scale-100 bg-indigo-900/10'
                                }`}
                        >
                            <MotionDiv
                                className={`w-24 h-24 rounded-full bg-indigo-500/20 blur-xl transition-all duration-[4000ms] ${phase === 'inhale' ? 'scale-150 opacity-80' : 'scale-100 opacity-40'
                                    }`}
                            />
                            <span className="absolute text-indigo-200 font-medium text-lg tracking-widest uppercase">
                                {phase}
                            </span>
                        </MotionDiv>
                    </div>
                );

            case 'eye':
                return (
                    <div className="relative mb-8 w-64 h-64 mx-auto border-2 border-indigo-500/20 rounded-lg flex items-center justify-center">
                        <MotionDiv
                            className="w-4 h-4 bg-indigo-500 rounded-full"
                            animate={{
                                x: [0, 80, 80, -80, -80, 0],
                                y: [0, 0, 60, 60, -60, 0]
                            }}
                            transition={{
                                duration: 8,
                                repeat: Infinity,
                                ease: "easeInOut"
                            }}
                        />
                    </div>
                );

            case 'posture':
                return (
                    <div className="relative mb-8 flex items-center justify-center">
                        <MotionDiv
                            className="w-32 h-48 border-2 border-indigo-500/30 rounded-full relative"
                            animate={{ rotate: [0, 2, -2, 0] }}
                            transition={{ duration: 4, repeat: Infinity }}
                        >
                            <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-8 h-8 bg-indigo-500/20 rounded-full" />
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 w-12 h-16 bg-indigo-500/10 rounded-lg" />
                        </MotionDiv>
                    </div>
                );

            case 'stretch':
                return (
                    <div className="relative mb-8 flex items-center justify-center h-48">
                        {[1, 2, 3].map((i) => (
                            <MotionDiv
                                key={i}
                                className="absolute w-32 h-32 border-2 border-indigo-500/30 rounded-full"
                                animate={{
                                    scale: [1, 1.5, 1],
                                    opacity: [0.5, 0, 0.5]
                                }}
                                transition={{
                                    duration: 3,
                                    repeat: Infinity,
                                    delay: i * 1
                                }}
                            />
                        ))}
                    </div>
                );

            case 'sunlight':
                return (
                    <div className="relative mb-8 flex items-center justify-center h-48">
                        <MotionDiv
                            className="w-32 h-32 bg-yellow-500/20 rounded-full blur-2xl"
                            animate={{
                                scale: [1, 1.2, 1],
                                opacity: [0.5, 0.8, 0.5]
                            }}
                            transition={{
                                duration: 3,
                                repeat: Infinity
                            }}
                        />
                        <div className="absolute text-6xl">☀️</div>
                    </div>
                );

            case 'neck':
                return (
                    <div className="relative mb-8 flex items-center justify-center h-48">
                        <MotionDiv
                            className="w-24 h-24 border-4 border-indigo-500/30 rounded-full"
                            animate={{ rotate: 360 }}
                            transition={{
                                duration: 8,
                                repeat: Infinity,
                                ease: "linear"
                            }}
                        >
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-2 h-2 bg-indigo-500 rounded-full" />
                        </MotionDiv>
                    </div>
                );

            case 'silence':
                return (
                    <div className="relative mb-8 flex items-center justify-center h-48 gap-1">
                        {[1, 2, 3, 4, 5].map((bar) => (
                            <MotionDiv
                                key={bar}
                                className="w-2 bg-indigo-500/60 rounded-full"
                                animate={{
                                    height: [20, 60, 20],
                                    opacity: [0.4, 0.9, 0.4]
                                }}
                                transition={{
                                    duration: 1 + Math.random(),
                                    repeat: Infinity,
                                    delay: bar * 0.1
                                }}
                            />
                        ))}
                    </div>
                );

            default:
                return null;
        }
    };

    return (
        <AnimatePresence>
            <MotionDiv
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-50 flex items-center justify-center p-4"
                onClick={onClose}
            >
                {/* Backdrop */}
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" />

                {/* Modal Card */}
                <MotionDiv
                    initial={{ scale: 0.9, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0.9, opacity: 0 }}
                    transition={{ type: 'spring', stiffness: 300, damping: 25 }}
                    onClick={(e: React.MouseEvent) => e.stopPropagation()}
                    className="relative max-w-2xl w-full bg-white/90 dark:bg-zinc-900/90 backdrop-blur-md border border-white/10 rounded-2xl shadow-2xl p-8"
                >
                    {/* Close Button */}
                    <button
                        onClick={onClose}
                        className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>

                    {/* Emoji */}
                    <div className="text-6xl text-center mb-4">
                        {exercise.emoji}
                    </div>

                    {/* Title */}
                    <h2 className="text-2xl font-semibold text-center text-gray-800 dark:text-gray-100 mb-2">
                        {exercise.label}
                    </h2>

                    {/* Description */}
                    <p className="text-center text-gray-600 dark:text-gray-400 mb-8 max-w-md mx-auto">
                        {exercise.description}
                    </p>

                    {/* Animation */}
                    {renderAnimation()}

                    {/* Timer */}
                    <div className="text-4xl font-light text-indigo-400 font-mono text-center mb-8">
                        {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                    </div>

                    {/* Resume Focus Button */}
                    <button
                        onClick={onClose}
                        className="w-full max-w-xs mx-auto block bg-gray-100 hover:bg-white dark:bg-zinc-800 dark:hover:bg-zinc-700 text-gray-800 dark:text-gray-200 font-medium py-3 px-6 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg"
                    >
                        Resume Focus
                    </button>
                </MotionDiv>
            </MotionDiv>
        </AnimatePresence>
    );
};
</file>

<file path="components/Header.tsx">
import React from 'react';
import { motion } from 'framer-motion';

interface HeaderProps {
    onGetStartedClick: () => void;
    onLoginClick: () => void;
    isDashboard?: boolean;
}

export const Header: React.FC<HeaderProps> = ({ onGetStartedClick, onLoginClick, isDashboard = false }) => {
    return (
        <motion.header
            initial={{ y: -20, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            transition={{ duration: 0.6, ease: [0.22, 1, 0.36, 1] }}
            className="fixed top-0 left-0 right-0 z-[200] border-b border-zinc-800 bg-zinc-950/70 backdrop-blur-md"
        >
            <div className="max-w-6xl mx-auto h-full flex items-center justify-between px-4 md:px-0">
                {/* Logo Section */}
                <div className="md:px-8 md:border-r border-zinc-800 h-full flex items-center">
                    <div className="flex items-center gap-2">
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 28 28"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            className="text-zinc-50"
                        >
                            <circle cx="14" cy="14" r="12" stroke="currentColor" strokeWidth="1.5" opacity="0.6" />
                            <circle cx="14" cy="14" r="6" fill="currentColor" opacity="0.9" />
                            <circle cx="14" cy="14" r="3" fill="currentColor" />
                        </svg>
                        <span className="text-zinc-50 font-semibold text-base tracking-tight">Ytterbium</span>
                    </div>
                </div>

                {/* Navigation / Breadcrumb Section */}
                <div className="hidden md:flex flex-1 px-10 items-center gap-2 h-full border-r border-zinc-800">
                    {isDashboard ? (
                        <div className="flex items-center gap-2 text-[11px] uppercase tracking-[0.03em] font-normal">
                            <span className="text-zinc-500">Workspace</span>
                            <span className="text-zinc-700">/</span>
                            <span className="text-zinc-200">Focus Session</span>
                        </div>
                    ) : (
                        <a
                            href="#pricing"
                            className="text-zinc-200 hover:text-white transition-colors duration-200 text-[11px] uppercase tracking-[0.03em] font-normal"
                        >
                            Pricing
                        </a>
                    )}
                </div>

                {/* Right Section: Auth / Profile */}
                <div className="flex items-center h-full">
                    {isDashboard ? (
                        <div className="px-0 md:px-8 flex items-center gap-4">
                            <div className="flex items-center gap-3">
                                <span className="text-[10px] text-zinc-500 uppercase tracking-widest font-medium hidden md:block">Settings</span>
                                <div className="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center text-zinc-400 hover:border-zinc-700 transition-colors cursor-pointer group">
                                    <span className="text-[10px] font-bold group-hover:text-zinc-200 transition-colors">JD</span>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <>
                            <div className="hidden md:flex px-10 border-r border-zinc-800 h-full items-center">
                                <button
                                    onClick={onLoginClick}
                                    className="text-zinc-200 hover:text-white transition-colors duration-200 text-[11px] uppercase tracking-[0.03em] font-normal"
                                >
                                    Log in
                                </button>
                            </div>

                            <div className="pl-4 md:px-10 h-full flex items-center">
                                <motion.button
                                    onClick={onGetStartedClick}
                                    whileHover={{ scale: 1.02 }}
                                    whileTap={{ scale: 0.98 }}
                                    className="bg-zinc-50 text-zinc-950 px-4 md:px-6 py-2 rounded-sm font-black text-[10px] uppercase tracking-[0.15em] hover:bg-white transition-all duration-200"
                                >
                                    Get Started
                                </motion.button>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </motion.header>
    );
};
</file>

<file path="components/PricingModal.tsx">
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface PricingModalProps {
    isOpen: boolean;
    onClose: () => void;
}

export const PricingModal: React.FC<PricingModalProps> = ({ isOpen, onClose }) => {
    const [isAnnual, setIsAnnual] = useState(false);

    if (!isOpen) return null;

    return (
        <AnimatePresence>
            <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-black/80 backdrop-blur-md"
                onClick={onClose}
            >
                <motion.div
                    initial={{ scale: 0.95, opacity: 0, y: 20 }}
                    animate={{ scale: 1, opacity: 1, y: 0 }}
                    exit={{ scale: 0.95, opacity: 0, y: 20 }}
                    onClick={(e) => e.stopPropagation()}
                    className="w-full max-w-lg relative bg-[#09090b] border border-zinc-800 md:rounded-3xl rounded-2xl overflow-hidden shadow-2xl"
                >
                    {/* Header Image / Gradient */}
                    <div className="h-32 bg-gradient-to-br from-zinc-800/50 via-zinc-900/30 to-black relative">
                        <div className="absolute inset-0 bg-[url('/noise.png')] opacity-10 mix-blend-overlay" />
                        <div className="absolute bottom-6 left-8">
                            <div className="px-3 py-1 rounded-full bg-zinc-800/50 border border-zinc-700/50 backdrop-blur-md text-xs font-medium text-zinc-50 inline-block mb-2">
                                Limit Reached
                            </div>
                            <h2 className="text-2xl font-bold text-zinc-50">Unlock Ytterbium</h2>
                        </div>
                    </div>

                    <div className="p-6 md:p-8">
                        <p className="text-zinc-500 text-sm leading-relaxed mb-8">
                            You've completed your 3 free focus sessions. To continue optimizing your cognitive performance with AI, upgrade to Pro.
                        </p>

                        {/* Toggle */}
                        <div className="flex items-center justify-center gap-4 mb-8">
                            <span className={`text-sm font-medium ${!isAnnual ? 'text-zinc-50' : 'text-zinc-500'}`}>Monthly</span>
                            <button
                                onClick={() => setIsAnnual(!isAnnual)}
                                className="w-12 h-6 rounded-full bg-zinc-900 border border-zinc-800 relative transition-colors duration-200"
                            >
                                <motion.div
                                    className="w-4 h-4 rounded-full bg-zinc-50 absolute top-1 left-1"
                                    animate={{ x: isAnnual ? 24 : 0 }}
                                    transition={{ type: "spring", stiffness: 500, damping: 30 }}
                                />
                            </button>
                            <span className={`text-sm font-medium ${isAnnual ? 'text-zinc-50' : 'text-zinc-500'}`}>Yearly</span>
                            {isAnnual && (
                                <span className="text-xs text-emerald-400 font-medium bg-emerald-400/10 px-2 py-0.5 rounded-full">
                                    Save 33%
                                </span>
                            )}
                        </div>

                        {/* Price Display */}
                        <div className="text-center mb-8">
                            <div className="flex items-baseline justify-center gap-1">
                                <span className="text-4xl font-black text-zinc-50">
                                    ${isAnnual ? '120' : '15'}
                                </span>
                                <span className="text-zinc-500 text-lg">
                                    / {isAnnual ? 'year' : 'month'}
                                </span>
                            </div>
                            <p className="text-zinc-500 text-xs mt-2">
                                First 3 sessions included. Cancel anytime.
                            </p>
                        </div>

                        {/* Features */}
                        <div className="space-y-3 mb-8">
                            {['Unlimited AI Focus Sessions', 'Advanced Cognitive Analytics', 'Cloud Sync & History'].map((feature, i) => (
                                <div key={i} className="flex items-center gap-3">
                                    <div className="w-5 h-5 rounded-full bg-zinc-800 flex items-center justify-center">
                                        <svg className="w-3 h-3 text-zinc-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <span className="text-zinc-400 text-sm">{feature}</span>
                                </div>
                            ))}
                        </div>

                        {/* CTA */}
                        <button
                            className="w-full py-4 rounded-xl bg-zinc-50 text-zinc-950 font-bold text-lg hover:scale-[1.01] active:scale-[0.99] transition-all shadow-xl"
                        >
                            Subscribe Now
                        </button>
                        <p className="text-center text-zinc-600 text-xs mt-4">
                            Secure payment via Stripe.
                        </p>
                    </div>
                </motion.div>
            </motion.div>
        </AnimatePresence>
    );
};
</file>

<file path="components/QuantumRippleBackground.tsx">
import React, { useEffect, useState, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { RIPPLE_EVENT_NAME, RippleEventDetail, RIPPLE_CONFIG } from '../hooks/useQuantumRipple';

const MotionDiv = motion.div as any;

interface QuantumRippleBackgroundProps {
  zIndex?: number;
}

export const QuantumRippleBackground: React.FC<QuantumRippleBackgroundProps> = ({ 
  zIndex = 0 
}) => {
  const [ripples, setRipples] = useState<RippleEventDetail[]>([]);
  const containerRef = useRef<HTMLDivElement>(null);
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(false);

  // Check accessibility settings
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    setPrefersReducedMotion(mediaQuery.matches);
    
    const handler = () => setPrefersReducedMotion(mediaQuery.matches);
    mediaQuery.addEventListener('change', handler);
    return () => mediaQuery.removeEventListener('change', handler);
  }, []);

  // Listen for trigger events
  useEffect(() => {
    const handleRippleTrigger = (e: CustomEvent<RippleEventDetail>) => {
      const { detail } = e;
      
      // Calculate coordinates if not provided (default to center of screen)
      if (detail.x === undefined || detail.y === undefined) {
          detail.x = window.innerWidth / 2;
          detail.y = window.innerHeight / 2;
      }

      setRipples((prev) => [...prev, detail]);
      
      // Safety cleanup
      if (ripples.length > 20) {
        setRipples(prev => prev.slice(1));
      }
    };

    window.addEventListener(RIPPLE_EVENT_NAME as any, handleRippleTrigger);
    return () => {
      window.removeEventListener(RIPPLE_EVENT_NAME as any, handleRippleTrigger);
    };
  }, [ripples.length]);

  const handleAnimationComplete = (id: string) => {
    setRipples((prev) => prev.filter((r) => r.id !== id));
  };

  if (prefersReducedMotion) return null;

  return (
    <div 
      ref={containerRef}
      className="fixed inset-0 pointer-events-none overflow-hidden"
      style={{ zIndex }}
    >
      <AnimatePresence>
        {ripples.map((ripple) => {
          const config = RIPPLE_CONFIG[ripple.intensity];
          
          return (
            <MotionDiv
              key={ripple.id}
              initial={{ 
                opacity: 0, 
                scale: 0.2,
                x: ripple.x, 
                y: ripple.y,
              }}
              animate={{ 
                opacity: [0, config.opacity, 0], 
                scale: 1,
              }}
              transition={{ 
                duration: config.duration, 
                ease: RIPPLE_CONFIG.easing 
              }}
              onAnimationComplete={() => handleAnimationComplete(ripple.id)}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: config.endRadius * 2,
                height: config.endRadius * 2,
                marginLeft: -config.endRadius,
                marginTop: -config.endRadius,
                borderRadius: '50%',
                // Visual warping effect using borders and blending
                // Thin, subtle border
                border: '1px solid rgba(255, 255, 255, 0.3)',
                boxShadow: '0 0 10px rgba(255,255,255,0.05), inset 0 0 5px rgba(255,255,255,0.02)',
                mixBlendMode: 'overlay', // Creates the "distortion" look against dark bg
                willChange: 'transform, opacity',
              }}
            />
          );
        })}
      </AnimatePresence>
    </div>
  );
};
</file>

<file path="components/TopBar.tsx">
import React from 'react';
import { Battery, Zap } from 'lucide-react';

interface TopBarProps {
  fqs: number;
  fatigueScore: number;
  userName?: string;
}

export const TopBar: React.FC<TopBarProps> = ({ fqs, fatigueScore, userName = "User" }) => {
  // Determine color based on FQS
  const fqsColor = fqs > 80 ? 'text-emerald-400' : fqs > 50 ? 'text-yellow-400' : 'text-rose-400';
  const fatigueColor = fatigueScore < 30 ? 'text-emerald-400' : fatigueScore < 70 ? 'text-yellow-400' : 'text-rose-400';

  return (
    <div className="h-14 border-b border-border bg-background/50 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-10">
      <div className="flex items-center gap-4">
        <span className="text-sm font-medium text-gray-400">Welcome back, {userName}</span>
      </div>

      <div className="flex items-center gap-6">
        {/* FQS Metric */}
        <div className="flex items-center gap-2" title="Focus Quality Score">
            <Zap className={`w-4 h-4 ${fqsColor}`} />
            <div className="flex flex-col items-end leading-none">
                <span className={`text-sm font-bold ${fqsColor}`}>{fqs}</span>
                <span className="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">FQS</span>
            </div>
        </div>

        {/* Fatigue Metric */}
        <div className="flex items-center gap-2" title="Fatigue Level">
            <Battery className={`w-4 h-4 ${fatigueColor}`} />
             <div className="flex flex-col items-end leading-none">
                <span className={`text-sm font-bold ${fatigueColor}`}>{fatigueScore}%</span>
                <span className="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">Load</span>
            </div>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="deploy.md">
# Deployment Guide: Ytterbium

Your app is built with Vite and is ready for high-performance hosting. Here is how to get it live.

## 1. Environment Variables
Ensure the following variables are set in your hosting provider's dashboard:
- `VITE_SUPABASE_URL`: `https://ocgsabgeikikddgutthh.supabase.co`
- `VITE_SUPABASE_ANON_KEY`: (Your project's secret anonymous key)

## 2. Recommended Hosting (Vercel)
Vercel is the most seamless for Vite projects:
1. Push your code to a GitHub repository.
2. Import the project into [Vercel](https://vercel.com).
3. Vercel will auto-detect the Vite framework.
4. Add the environment variables above.
5. Click **Deploy**.

## 3. Supabase Production Settings
Before going live, ensure you have:
1. Applied `supabase_migration.sql` for the initial schema.
2. Applied `ghost_migration.sql` for the anonymous session logic.
3. Updated the **Auth Redirect URL** in the Supabase dashboard (`Authentication > URL Configuration`) to your new production domain.

## 4. Final Verification
Once hosted, verify:
- [ ] Users can enter as a "Ghost" without seeing branding.
- [ ] AI classification works on the landing page.
- [ ] The "Auth Wall" appears when pausing or during fatigue detection.
- [ ] Data correctly syncs to Supabase.
</file>

<file path="fix_database.sql">
-- FIX SCRIPT: Run this if tables exist but have 406 errors
-- This will properly configure the database without recreating everything

-- 1. Make sure RLS is enabled on all tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE fatigue_metrics ENABLE ROW LEVEL SECURITY;

-- 2. Drop existing policies (in case they're malformed)
DROP POLICY IF EXISTS "Users can view their own profile" ON profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON profiles;
DROP POLICY IF EXISTS "Users can view their own sessions" ON sessions;
DROP POLICY IF EXISTS "Users can create sessions" ON sessions;
DROP POLICY IF EXISTS "Users can update their own sessions" ON sessions;
DROP POLICY IF EXISTS "Users can view their own tasks" ON tasks;
DROP POLICY IF EXISTS "Users can create their own tasks" ON tasks;
DROP POLICY IF EXISTS "Users can update their own tasks" ON tasks;
DROP POLICY IF EXISTS "Users can delete their own tasks" ON tasks;
DROP POLICY IF EXISTS "Users can view their own metrics" ON fatigue_metrics;
DROP POLICY IF EXISTS "Users can create their own metrics" ON fatigue_metrics;

-- 3. Recreate policies correctly
-- Profiles
CREATE POLICY "Users can view their own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert their own profile" ON profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

-- Sessions  
CREATE POLICY "Users can view their own sessions" ON sessions
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create sessions" ON sessions
  FOR INSERT WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can update their own sessions" ON sessions
  FOR UPDATE USING (auth.uid() = user_id OR user_id IS NULL);

-- Tasks
CREATE POLICY "Users can view their own tasks" ON tasks
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own tasks" ON tasks
  FOR INSERT WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can update their own tasks" ON tasks
  FOR UPDATE USING (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can delete their own tasks" ON tasks
  FOR DELETE USING (auth.uid() = user_id OR user_id IS NULL);

-- Fatigue Metrics
CREATE POLICY "Users can view their own metrics" ON fatigue_metrics
  FOR SELECT USING (
    auth.uid() = (SELECT user_id FROM sessions WHERE id = session_id)
  );

CREATE POLICY "Users can create their own metrics" ON fatigue_metrics
  FOR INSERT WITH CHECK (
    auth.uid() = (SELECT user_id FROM sessions WHERE id = session_id) OR
    (SELECT user_id FROM sessions WHERE id = session_id) IS NULL
  );

-- 4. Grant necessary permissions
GRANT ALL ON profiles TO authenticated;
GRANT ALL ON sessions TO authenticated;
GRANT ALL ON tasks TO authenticated;
GRANT ALL ON fatigue_metrics TO authenticated;

GRANT ALL ON profiles TO anon;
GRANT ALL ON sessions TO anon;
GRANT ALL ON tasks TO anon;
GRANT ALL ON fatigue_metrics TO anon;
</file>

<file path="ghost_migration.sql">
-- ========================================================
-- GHOST SESSION MIGRATION
-- ========================================================

-- 1. Make user_id nullable in sessions and tasks
ALTER TABLE sessions ALTER COLUMN user_id DROP NOT NULL;
ALTER TABLE tasks ALTER COLUMN user_id DROP NOT NULL;

-- 2. Update RLS policies for anonymous (logged out) access
-- Note: auth.uid() is NULL when not logged in.

-- Sessions: Allow anonymous inserts
CREATE POLICY "Allow anonymous session creation"
  ON sessions FOR INSERT
  WITH CHECK (auth.uid() IS NULL OR auth.uid() = user_id);

-- Sessions: Allow anonymous selection and updates if sessionId matches (via frontend cookie/localstorage)
-- In a production app, you might use a 'ghost_token' or restricted access, 
-- but for this "Pro" implementation, we'll allow public access to rows without user_id
-- for the duration of the ghost session.
CREATE POLICY "Allow anonymous session viewing"
  ON sessions FOR SELECT
  USING (user_id IS NULL OR auth.uid() = user_id);

CREATE POLICY "Allow anonymous session updates"
  ON sessions FOR UPDATE
  USING (user_id IS NULL OR auth.uid() = user_id);

-- Tasks: Allow anonymous inserts/updates
CREATE POLICY "Allow anonymous task creation"
  ON tasks FOR INSERT
  WITH CHECK (auth.uid() IS NULL OR auth.uid() = user_id);

CREATE POLICY "Allow anonymous task viewing"
  ON tasks FOR SELECT
  USING (user_id IS NULL OR auth.uid() = user_id);

CREATE POLICY "Allow anonymous task updates"
  ON tasks FOR UPDATE
  USING (user_id IS NULL OR auth.uid() = user_id);

-- 3. Cleanup old policies if necessary (optional, Supabase might conflict)
-- DROP POLICY IF EXISTS "Users can create their own sessions" ON sessions;
-- ... but the new policies above are additive or can be refined.
</file>

<file path="hooks/useQuantumRipple.ts">
import { useRef, useCallback } from 'react';

// Configuration types
export type RippleIntensity = 'small' | 'medium' | 'large';

export interface RippleEventDetail {
  id: string;
  x?: number;
  y?: number;
  intensity: RippleIntensity;
}

export const RIPPLE_EVENT_NAME = 'quantum-ripple-trigger';

// Configuration constants for physics/visuals
// Opacity drastically reduced for "almost invisible" feel
export const RIPPLE_CONFIG = {
  small: { endRadius: 60, opacity: 0.02, duration: 0.6 },
  medium: { endRadius: 120, opacity: 0.04, duration: 0.8 },
  large: { endRadius: 200, opacity: 0.06, duration: 1.0 },
  easing: [0.22, 1, 0.36, 1] as const, // cubic-bezier
};

export const useQuantumRipple = () => {
  // Throttling to prevent performance degradation on high-frequency triggers
  const lastTriggerTime = useRef<number>(0);

  const triggerRipple = useCallback((
    params: { 
      x?: number; 
      y?: number; 
      intensity: RippleIntensity;
      force?: boolean; // Bypass throttle
    }
  ) => {
    const now = performance.now();
    
    // Throttle small ripples (e.g., timer ticks) to max 10 per second
    if (params.intensity === 'small' && !params.force && now - lastTriggerTime.current < 100) {
      return;
    }
    lastTriggerTime.current = now;

    // Dispatch event to decoupling the render layer
    const event = new CustomEvent<RippleEventDetail>(RIPPLE_EVENT_NAME, {
      detail: {
        id: crypto.randomUUID(),
        x: params.x,
        y: params.y,
        intensity: params.intensity,
      },
    });
    window.dispatchEvent(event);
  }, []);

  return { triggerRipple };
};
</file>

<file path="index.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path="metadata.json">
{
  "name": "Ytterbium",
  "description": "A minimalist, AI-powered productivity and well-being platform inspired by Linear. It features dual-mode sessions, fatigue detection via input dynamics, and adaptive pacing.",
  "requestFramePermissions": []
}
</file>

<file path="polar_sync.sql">
-- 1. Create Tables for Polar Sync Data
-- These will be populated by the Polar Supabase Adapter

CREATE TABLE IF NOT EXISTS public.polar_products (
    id UUID PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    is_recurring BOOLEAN DEFAULT FALSE,
    price_amount INTEGER,
    price_currency TEXT,
    organization_id UUID NOT NULL,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.polar_subscriptions (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    product_id UUID REFERENCES public.polar_products(id),
    status TEXT NOT NULL, -- 'active', 'canceled', 'incomplete', etc.
    current_period_start TIMESTAMP WITH TIME ZONE,
    current_period_end TIMESTAMP WITH TIME ZONE,
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    started_at TIMESTAMP WITH TIME ZONE,
    ended_at TIMESTAMP WITH TIME ZONE,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Enable RLS on all tables
ALTER TABLE public.polar_products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.polar_subscriptions ENABLE ROW LEVEL SECURITY;

-- 3. RLS Policies: Security First Principle
-- Products are public (so users can see what they are buying)
CREATE POLICY "Products are viewable by everyone" 
ON public.polar_products FOR SELECT 
USING (true);

-- Subscriptions are strictly private
CREATE POLICY "Users can only view their own subscriptions" 
ON public.polar_subscriptions FOR SELECT 
USING (auth.uid() = user_id);

-- 4. Update Trigger for Timestamps
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_updated_at_polar_products
    BEFORE UPDATE ON public.polar_products
    FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER set_updated_at_polar_subscriptions
    BEFORE UPDATE ON public.polar_subscriptions
    FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

-- 5. Helper View for Active Subscriptions
CREATE OR REPLACE VIEW public.user_subscriptions AS
SELECT 
    s.*,
    p.name as product_name,
    p.is_recurring
FROM public.polar_subscriptions s
JOIN public.polar_products p ON s.product_id = p.id
WHERE s.status = 'active';

COMMENT ON TABLE public.polar_subscriptions IS 'Synced subscriptions from Polar.sh';
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1yeMpGLzaSwREApUkMY39igF9qSdso1bp

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`
</file>

<file path="reset_database_completely.sql">
-- COMPLETE DATABASE RESET AND SETUP SCRIPT
-- WARNING: THIS WILL DELETE ALL DATA IN THESE TABLES

-- 1. Drop existing objects to ensure a clean slate
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();

DROP TABLE IF EXISTS public.fatigue_metrics;
DROP TABLE IF EXISTS public.tasks;
DROP TABLE IF EXISTS public.sessions;
DROP TABLE IF EXISTS public.profiles;

-- 2. Create the tables

-- A. Profiles (One-to-one with auth.users)
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL PRIMARY KEY,
  full_name TEXT,
  avatar_url TEXT,
  subscription_tier TEXT DEFAULT 'free',
  total_reserve INTEGER DEFAULT 0,
  free_sessions_used INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- B. Sessions
CREATE TABLE public.sessions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Can be null for ghost sessions initially
  start_time TIMESTAMPTZ DEFAULT NOW(),
  end_time TIMESTAMPTZ,
  duration_seconds INTEGER NOT NULL,
  elapsed_seconds INTEGER DEFAULT 0,
  type TEXT CHECK (type IN ('FOCUS', 'RELAX', 'INSIGHT')),
  focus_intensity INTEGER, -- 1-10
  fqs INTEGER DEFAULT 0, -- Focus Quality Score
  status TEXT DEFAULT 'IDLE',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- C. Tasks
CREATE TABLE public.tasks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id UUID REFERENCES public.sessions(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  completed BOOLEAN DEFAULT FALSE,
  priority TEXT CHECK (priority IN ('low', 'medium', 'high')) DEFAULT 'medium',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- D. Fatigue Metrics
CREATE TABLE public.fatigue_metrics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id UUID REFERENCES public.sessions(id) ON DELETE CASCADE,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  keystroke_latency_ms FLOAT,
  typing_speed_wpm FLOAT,
  mouse_distance_px FLOAT,
  mouse_velocity_px_per_sec FLOAT,
  erratic_mouse_movement FLOAT,
  fatigue_score FLOAT, -- 0-100
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Enable Row Level Security (RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fatigue_metrics ENABLE ROW LEVEL SECURITY;

-- 4. Create Policies (Permissive to fix 406 errors)

-- Profiles
CREATE POLICY "Users can view own profile" ON public.profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON public.profiles
  FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile" ON public.profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

-- Sessions
CREATE POLICY "Users can view own sessions" ON public.sessions
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create sessions" ON public.sessions
  FOR INSERT WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can update own sessions" ON public.sessions
  FOR UPDATE USING (auth.uid() = user_id OR user_id IS NULL);

-- Tasks
CREATE POLICY "Users can view own tasks" ON public.tasks
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create tasks" ON public.tasks
  FOR INSERT WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can update own tasks" ON public.tasks
  FOR UPDATE USING (auth.uid() = user_id OR user_id IS NULL);

CREATE POLICY "Users can delete own tasks" ON public.tasks
  FOR DELETE USING (auth.uid() = user_id OR user_id IS NULL);

-- Fatigue Metrics
CREATE POLICY "Users can view own metrics" ON public.fatigue_metrics
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.sessions s WHERE s.id = session_id AND (s.user_id = auth.uid() OR s.user_id IS NULL))
  );

CREATE POLICY "Users can insert metrics" ON public.fatigue_metrics
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.sessions s WHERE s.id = session_id AND (s.user_id = auth.uid() OR s.user_id IS NULL))
  );

-- 5. Auto-create Profile Trigger
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, avatar_url)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- 6. Grant Permissions (Fixes 406 Not Acceptable permissions issues)
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL ROUTINES IN SCHEMA public TO anon, authenticated;
</file>

<file path="services/ambientSound.ts">
/**
 * Heavenly Ambient Soundscape Service (Endel-inspired)
 * Generates a multi-layered atmospheric pad centered around 475Hz.
 */
class AmbientSoundService {
    private audioCtx: AudioContext | null = null;
    private nodes: AudioNode[] = [];
    private masterGain: GainNode | null = null;
    private isRunning: boolean = false;

    private init() {
        if (this.audioCtx) return;
        this.audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
    }

    private createLayer(freq: number, type: OscillatorType, volume: number, lfoFreq: number) {
        if (!this.audioCtx) return;
        const now = this.audioCtx.currentTime;

        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();
        const filter = this.audioCtx.createBiquadFilter();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, now);

        // Soft low-pass to remove "beepy" edges
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(600, now);
        filter.Q.setValueAtTime(0.7, now);

        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(volume, now + 5);

        // LFO for organic "breathing"
        const lfo = this.audioCtx.createOscillator();
        const lfoGain = this.audioCtx.createGain();
        lfo.type = 'sine';
        lfo.frequency.setValueAtTime(lfoFreq, now);
        lfoGain.gain.setValueAtTime(volume * 0.3, now);

        lfo.connect(lfoGain);
        lfoGain.connect(gain.gain);

        osc.connect(filter);
        filter.connect(gain);

        osc.start();
        lfo.start();

        this.nodes.push(osc, lfo);
        return gain;
    }

    private createAtmosphere() {
        if (!this.audioCtx) return;
        const now = this.audioCtx.currentTime;

        // Brown noise for warmth/ocean feel
        const bufferSize = 2 * this.audioCtx.sampleRate;
        const noiseBuffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        let lastOut = 0.0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            output[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = output[i];
            output[i] *= 3.5; // balance
        }

        const noise = this.audioCtx.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;

        const noiseFilter = this.audioCtx.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.setValueAtTime(400, now);

        const noiseGain = this.audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0, now);
        noiseGain.gain.linearRampToValueAtTime(0.04, now + 8);

        noise.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noise.start();

        this.nodes.push(noise);
        return noiseGain;
    }

    async start() {
        if (this.isRunning) return;
        this.init();
        if (!this.audioCtx) return;

        if (this.audioCtx.state === 'suspended') {
            try { await this.audioCtx.resume(); } catch (e) { return; }
        }

        const now = this.audioCtx.currentTime;
        this.masterGain = this.audioCtx.createGain();
        this.masterGain.gain.setValueAtTime(0, now);
        this.masterGain.gain.linearRampToValueAtTime(1.0, now + 4);

        // Create Space (Delay/Reverb simulation)
        const delay = this.audioCtx.createDelay();
        const feedback = this.audioCtx.createGain();
        delay.delayTime.setValueAtTime(0.8, now);
        feedback.gain.setValueAtTime(0.4, now);

        delay.connect(feedback);
        feedback.connect(delay);

        // Layers
        const root = this.createLayer(475, 'sine', 0.08, 0.1); // Main
        const sub = this.createLayer(237.5, 'sine', 0.05, 0.07); // Octave Down (Warmth)
        const fifth = this.createLayer(712.5, 'sine', 0.03, 0.13); // Perfect Fifth
        const noise = this.createAtmosphere();

        [root, sub, fifth, noise].forEach(g => {
            if (g) {
                g.connect(this.masterGain!);
                g.connect(delay);
            }
        });

        delay.connect(this.masterGain);
        this.masterGain.connect(this.audioCtx.destination);

        this.isRunning = true;
        console.log('Heavenly soundscape initiated. 475Hz center.');
    }

    stop() {
        if (!this.isRunning) return;
        const now = this.audioCtx?.currentTime || 0;
        this.masterGain?.gain.linearRampToValueAtTime(0, now + 3);
        setTimeout(() => {
            this.nodes.forEach(n => {
                try { (n as any).stop(); } catch (e) { }
            });
            this.nodes = [];
            this.isRunning = false;
        }, 3100);
    }
}

export const ambientSound = new AmbientSoundService();
</file>

<file path="supabase_migration_monetization.sql">
-- Add free_sessions_used to profiles table
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS free_sessions_used INTEGER DEFAULT 0;

-- Update RLS policy to allow users to read their own usage
create policy "Users can view their own profile usage"
on profiles for select
using ( auth.uid() = id );
</file>

<file path="supabase_migration.sql">
-- Ytterbium Database Schema Migration
-- Execute this in your Supabase SQL Editor

-- ==================== PROFILES TABLE ====================
CREATE TABLE IF NOT EXISTS profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  full_name TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Profiles policies
CREATE POLICY "Users can view their own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);

-- ==================== SESSIONS TABLE ====================
CREATE TABLE IF NOT EXISTS sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  end_time TIMESTAMP WITH TIME ZONE,
  duration_seconds INTEGER NOT NULL,
  elapsed_seconds INTEGER NOT NULL DEFAULT 0,
  type TEXT NOT NULL CHECK (type IN ('FOCUS', 'RELAX')),
  focus_intensity INTEGER NOT NULL CHECK (focus_intensity >= 1 AND focus_intensity <= 10),
  fqs INTEGER NOT NULL DEFAULT 0 CHECK (fqs >= 0 AND fqs <= 100),
  status TEXT NOT NULL CHECK (status IN ('IDLE', 'RUNNING', 'PAUSED', 'COMPLETED')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;

-- Sessions policies
CREATE POLICY "Users can view their own sessions"
  ON sessions FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own sessions"
  ON sessions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own sessions"
  ON sessions FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own sessions"
  ON sessions FOR DELETE
  USING (auth.uid() = user_id);

-- ==================== TASKS TABLE ====================
CREATE TABLE IF NOT EXISTS tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  completed BOOLEAN NOT NULL DEFAULT FALSE,
  priority TEXT NOT NULL DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

-- Tasks policies
CREATE POLICY "Users can view their own tasks"
  ON tasks FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own tasks"
  ON tasks FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own tasks"
  ON tasks FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own tasks"
  ON tasks FOR DELETE
  USING (auth.uid() = user_id);

-- ==================== FATIGUE METRICS TABLE ====================
CREATE TABLE IF NOT EXISTS fatigue_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  timestamp BIGINT NOT NULL,
  keystroke_latency_ms DOUBLE PRECISION NOT NULL,
  typing_speed_wpm DOUBLE PRECISION NOT NULL,
  mouse_distance_px DOUBLE PRECISION NOT NULL,
  mouse_velocity_px_per_sec DOUBLE PRECISION NOT NULL,
  erratic_mouse_movement BOOLEAN NOT NULL,
  fatigue_score INTEGER NOT NULL CHECK (fatigue_score >= 0 AND fatigue_score <= 100),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE fatigue_metrics ENABLE ROW LEVEL SECURITY;

-- Fatigue metrics policies (users can only access metrics for their own sessions)
CREATE POLICY "Users can view metrics for their own sessions"
  ON fatigue_metrics FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM sessions
      WHERE sessions.id = fatigue_metrics.session_id
      AND sessions.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can create metrics for their own sessions"
  ON fatigue_metrics FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM sessions
      WHERE sessions.id = fatigue_metrics.session_id
      AND sessions.user_id = auth.uid()
    )
  );

-- ==================== INDEXES FOR PERFORMANCE ====================
CREATE INDEX IF NOT EXISTS idx_sessions_user_id ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_created_at ON sessions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_sessions_status ON sessions(status);

CREATE INDEX IF NOT EXISTS idx_tasks_user_id ON tasks(user_id);
CREATE INDEX IF NOT EXISTS idx_tasks_session_id ON tasks(session_id);
CREATE INDEX IF NOT EXISTS idx_tasks_completed ON tasks(completed);

CREATE INDEX IF NOT EXISTS idx_fatigue_metrics_session_id ON fatigue_metrics(session_id);
CREATE INDEX IF NOT EXISTS idx_fatigue_metrics_timestamp ON fatigue_metrics(timestamp);

-- ==================== FUNCTIONS ====================

-- Function to automatically create profile on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'full_name'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create profile automatically
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers for updated_at
DROP TRIGGER IF EXISTS update_profiles_updated_at ON profiles;
CREATE TRIGGER update_profiles_updated_at
  BEFORE UPDATE ON profiles
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_tasks_updated_at ON tasks;
CREATE TRIGGER update_tasks_updated_at
  BEFORE UPDATE ON tasks
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
</file>

<file path="SUPABASE_SETUP.md">
# Supabase Database Setup Guide

## Step 1: Access Supabase Dashboard

1. Go to [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. Sign in to your account
3. Select your project: **ocgsabgeikikddgutthh**

## Step 2: Run the SQL Migration

1. In the left sidebar, click on **SQL Editor**
2. Click **New Query**
3. Open the file `supabase_migration.sql` from your project directory
4. Copy the entire contents
5. Paste into the SQL Editor
6. Click **Run** (or press Ctrl+Enter)

You should see a success message indicating all tables, policies, and triggers were created.

## Step 3: Verify the Schema

1. In the left sidebar, click on **Table Editor**
2. You should see 4 new tables:
   - `profiles`
   - `sessions`
   - `tasks`
   - `fatigue_metrics`

3. Click on each table to verify the columns match the schema

## Step 4: Check Row Level Security (RLS)

1. Click on **Authentication** → **Policies**
2. Verify that RLS is enabled for all tables
3. You should see policies like:
   - "Users can view their own profile"
   - "Users can view their own sessions"
   - "Users can create their own tasks"
   - etc.

## Step 5: Test Authentication

1. Run your development server: `npm run dev`
2. Open the app in your browser
3. Try signing up with a test email
4. Check the **Authentication** → **Users** tab in Supabase
5. You should see your new user listed

## Step 6: Verify Data Flow

1. Sign in to the app
2. Enter a task and start a focus session
3. Go to **Table Editor** → **sessions** in Supabase
4. You should see a new session record
5. Check the **tasks** table for your task
6. After running for a bit, check **fatigue_metrics** for tracking data

## Troubleshooting

### "relation does not exist" error
- Make sure you ran the entire SQL migration script
- Check that you're in the correct project

### "permission denied" error
- Verify RLS policies were created
- Check that you're signed in as an authenticated user

### Tasks/Sessions not saving
- Open browser console (F12) and check for errors
- Verify your `.env.local` file has the correct credentials
- Make sure you're signed in (check `currentUser` state)

## Environment Variables

Make sure your `.env.local` file contains:

```
VITE_SUPABASE_URL=https://ocgsabgeikikddgutthh.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZ3NhYmdlaWtpa2RkZ3V0dGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ4ODM0NzQsImV4cCI6MjA1MDQ1OTQ3NH0.sb_publishable_I6d1kAnxR4lsoJnJBT5F9g_Rgm6Iyyc
```

Restart your dev server after adding these variables.

## Next Steps

Once the database is set up and working:
- Test the full user flow (sign up → add tasks → run session)
- Verify data persists across page refreshes
- Test on multiple devices to ensure sync works
- Consider adding real-time subscriptions for collaborative features
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="verify_database.sql">
-- Step 1: Check what tables exist
-- Run this in Supabase SQL Editor to see current state

SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Step 2: Check if RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';

-- Step 3: List all policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
</file>

<file path="vite-env.d.ts">
/// <reference types="vite/client" />

interface ImportMetaEnv {
    readonly VITE_GROQ_API_KEY: string
}

interface ImportMeta {
    readonly env: ImportMetaEnv
}
</file>

<file path="api/analyze.ts">
export const config = {
    runtime: 'edge',
};

export default async function handler(req: Request) {
    if (req.method !== 'POST') {
        return new Response(JSON.stringify({ error: 'Method not allowed' }), {
            status: 405,
            headers: { 'Content-Type': 'application/json' },
        });
    }

    try {
        const { taskDescription } = await req.json();
        const GROQ_API_KEY = process.env.GROQ_API_KEY;

        if (!GROQ_API_KEY) {
            return new Response(JSON.stringify({ error: 'Server configuration error' }), {
                status: 500,
                headers: { 'Content-Type': 'application/json' },
            });
        }

        const prompt = `Task: "${taskDescription}". Identify focus mode: Creative(3), Balanced(6), or Deep(10). Return JSON: {"thinking_trace":"Analysis...","taskType":"Type","focusMode":"Creative Focus"|"Balanced Focus"|"Deep Laser Focus","explanation":"Why? (1 sentence)","suggestedIntensity":3|6|10}`;

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${GROQ_API_KEY}`,
            },
            body: JSON.stringify({
                model: "openai/gpt-oss-20b",
                messages: [
                    { role: "system", content: "You are a task analysis engine. Return raw JSON only." },
                    { role: "user", content: prompt },
                ],
                response_format: { type: "json_object" },
                reasoning_format: "parsed",
                temperature: 0.1,
            }),
        });

        if (!response.ok) {
            const errorText = await response.text();
            return new Response(JSON.stringify({ error: `Groq Error: ${errorText}` }), {
                status: response.status,
                headers: { 'Content-Type': 'application/json' },
            });
        }

        const data = await response.json();
        return new Response(JSON.stringify(data), {
            status: 200,
            headers: { 'Content-Type': 'application/json' },
        });
    } catch (error: any) {
        return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' },
        });
    }
}
</file>

<file path="components/AIOptimizedIndicator.tsx">
import React from 'react';
import { motion } from 'framer-motion';

const MotionDiv = motion.div as any;

interface AIOptimizedIndicatorProps {
    currentInsight: string;
}

/**
 * A fixed, minimalist indicator for AI activity, placed in the top right.
 */
export const AIOptimizedIndicator: React.FC<AIOptimizedIndicatorProps> = ({ currentInsight }) => {
    return (
        <MotionDiv
            // Position fixed to the top-right corner.
            // Adjusted from top-6 to top-10 (40px) to align it visually lower, 
            // closer to the 'Ytterbium' logo's baseline.
            initial={{ x: 50, opacity: 0 }}
            animate={{ x: 0, opacity: 1 }}
            transition={{ type: "spring", stiffness: 100, damping: 20, delay: 0.5 }}
            className="fixed top-4 right-4 md:top-10 md:right-6 z-[60] pointer-events-auto"
        >
            <div
                className="px-4 py-2 bg-zinc-900/40 backdrop-blur-md border border-white/5 rounded-full shadow-lg flex items-center gap-2 cursor-default transition-all duration-300 hover:ring-2 ring-emerald-400/30"
                title={currentInsight}
            >

                {/* The Signaling Circle Component */}
                <div className="relative flex items-center justify-center h-3 w-3">
                    {/* Pulsing Ring (Subtle Signal) */}
                    <motion.div
                        animate={{
                            scale: [1, 1.8, 1],
                            opacity: [0.5, 0.2, 0.5]
                        }}
                        transition={{
                            duration: 2.5,
                            repeat: Infinity,
                            ease: "easeInOut"
                        }}
                        className="absolute h-full w-full rounded-full bg-emerald-400/70"
                    />

                    {/* Inner Circle (solid light green) */}
                    <div className="relative h-2 w-2 rounded-full bg-emerald-400 shadow-lg shadow-emerald-400/50"></div>
                </div>

                <span className="text-xs font-semibold text-emerald-300 uppercase tracking-widest leading-none">
                    AI-Enhanced
                </span>
            </div>
        </MotionDiv>
    );
};
</file>

<file path="components/CountdownNotification.tsx">
import React from 'react';
import { motion } from 'framer-motion';

interface CountdownNotificationProps {
    countdown: number;
}

export const CountdownNotification: React.FC<CountdownNotificationProps> = ({ countdown }) => {
    console.log("[CountdownNotification] rendering with countdown:", countdown);
    return (
        <motion.div
            initial={{ y: -100, opacity: 0, scale: 0.9 }}
            animate={{ y: 0, opacity: 1, scale: 1 }}
            exit={{ y: -100, opacity: 0, scale: 0.9 }}
            transition={{
                type: 'spring',
                stiffness: 400,
                damping: 25,
                mass: 0.8
            }}
            className="fixed top-6 left-1/2 -translate-x-1/2 z-[200]"
        >
            {/* Mac-style Notification Card */}
            <div className="relative group">
                {/* Subtle outer glow */}
                <div className="absolute -inset-[1px] bg-gradient-to-br from-indigo-500/20 via-purple-500/10 to-pink-500/20 rounded-2xl blur-sm opacity-0 group-hover:opacity-100 transition-opacity duration-500" />

                {/* Main notification container */}
                <div className="relative bg-white/[0.08] backdrop-blur-2xl border border-white/[0.12] rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.4)] overflow-hidden">
                    {/* Subtle gradient overlay */}
                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.05] to-transparent pointer-events-none" />

                    {/* Content */}
                    <div className="relative px-6 py-4 flex items-center gap-4">
                        {/* Left: Pulsing indicator */}
                        <div className="relative flex-shrink-0">
                            {/* Outer pulse ring */}
                            <motion.div
                                animate={{
                                    scale: [1, 1.4, 1],
                                    opacity: [0.4, 0, 0.4]
                                }}
                                transition={{
                                    duration: 2,
                                    repeat: Infinity,
                                    ease: 'easeInOut'
                                }}
                                className="absolute inset-0 rounded-full bg-indigo-400/40 blur-md"
                            />

                            {/* Icon container */}
                            <div className="relative w-11 h-11 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center backdrop-blur-sm">
                                {/* Inner glow */}
                                <div className="absolute inset-[2px] rounded-full bg-gradient-to-br from-indigo-400/10 to-transparent" />

                                {/* Animated dot */}
                                <motion.div
                                    animate={{
                                        scale: [1, 1.2, 1],
                                        opacity: [0.8, 1, 0.8]
                                    }}
                                    transition={{
                                        duration: 1.5,
                                        repeat: Infinity,
                                        ease: 'easeInOut'
                                    }}
                                    className="relative w-2.5 h-2.5 rounded-full bg-gradient-to-br from-indigo-400 to-indigo-300 shadow-[0_0_12px_rgba(129,140,248,0.6)]"
                                />
                            </div>
                        </div>

                        {/* Center: Text content */}
                        <div className="flex-1 min-w-0">
                            <h4 className="text-[11px] font-semibold text-white/95 tracking-wide mb-0.5 leading-tight">
                                Prepare yourself
                            </h4>
                            <p className="text-[10px] text-white/50 font-medium tracking-wide leading-tight">
                                Focus session starting soon
                            </p>
                        </div>

                        {/* Right: Countdown number */}
                        <div className="flex-shrink-0">
                            <motion.div
                                key={countdown}
                                initial={{ scale: 1.3, opacity: 0 }}
                                animate={{ scale: 1, opacity: 1 }}
                                transition={{
                                    type: 'spring',
                                    stiffness: 500,
                                    damping: 20
                                }}
                                className="relative"
                            >
                                {/* Number glow */}
                                <div className="absolute inset-0 bg-gradient-to-br from-indigo-400/40 to-purple-400/40 blur-xl rounded-full" />

                                {/* Number */}
                                <div className="relative w-14 h-14 rounded-xl bg-gradient-to-br from-white/[0.08] to-white/[0.02] border border-white/10 flex items-center justify-center backdrop-blur-sm">
                                    <span className="text-3xl font-bold bg-gradient-to-br from-white via-indigo-100 to-indigo-200 bg-clip-text text-transparent tabular-nums">
                                        {countdown}
                                    </span>
                                </div>
                            </motion.div>
                        </div>
                    </div>

                    {/* Bottom progress bar */}
                    <motion.div
                        initial={{ scaleX: 0 }}
                        animate={{ scaleX: 1 }}
                        transition={{ duration: 1, ease: 'linear' }}
                        className="h-[2px] bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 origin-left"
                    />
                </div>
            </div>
        </motion.div>
    );
};
</file>

<file path="components/ExerciseCard.tsx">
import React from 'react';
import { motion } from 'framer-motion';
import { Clock } from 'lucide-react'; // Icon for the duration cue

interface ExerciseCardProps {
    emoji: string;
    label: string;
    isHighlighted?: boolean;
    scale?: number;
    duration?: number; // Added duration property (in seconds)
}

// NOTE: colorMap is now ONLY used to determine the passive border/background on hover, 
// ensuring a clean, dark-glass aesthetic in the default state.
const colorMap: { [key: string]: { passiveBg: string, passiveBorder: string } } = {
    '👁️': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '🧍': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '💨': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '🧘': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '🌞': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '🌀': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
    '🎧': { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' }, // Pure glass-dark
};

const formatTime = (seconds: number | undefined) => {
    if (typeof seconds !== 'number' || seconds === 0) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
};


export const ExerciseCard: React.FC<ExerciseCardProps> = ({
    emoji,
    label,
    isHighlighted = false,
    scale = 1,
    duration
}) => {
    const neutralStyles = colorMap[emoji] || { passiveBg: 'bg-white/5 hover:bg-white/10', passiveBorder: 'border-white/10' };

    // Conditional styling for the TaskList look: solid Indigo on highlight, pure glass otherwise.
    const finalClasses = isHighlighted
        ? 'bg-indigo-600 border-indigo-500 shadow-xl shadow-indigo-500/50 text-white' // Solid Indigo Accent
        : `${neutralStyles.passiveBg} ${neutralStyles.passiveBorder} text-white/80`; // Minimalist Dark Glass

    return (
        <motion.div
            animate={{
                scale: isHighlighted ? 1.05 : scale,
                boxShadow: isHighlighted
                    ? '0 8px 24px rgba(99, 102, 241, 0.4)' // Indigo Glow
                    : '0 2px 8px rgba(0, 0, 0, 0.08)'
            }}
            whileHover={{ scale: 1.05 }}
            transition={{
                type: 'spring',
                stiffness: 300,
                damping: 25
            }}
            className={`
                relative flex flex-col items-center justify-center
                ${finalClasses} /* Dynamic colors based on TaskList style */
                backdrop-blur-sm
                border
                rounded-xl
                p-2.5 /* TIGHTER PADDING for maximum compactness */
                transition-all duration-300
                shadow-md
            `}
            style={{
                minHeight: '80px', /* MAX COMPACT HEIGHT */
            }}
        >
            {/* Emoji Icon */}
            <div className={`text-2xl mb-0.5 select-none`}>
                {emoji}
            </div>

            {/* Label */}
            <div className={`text-xs font-medium text-center leading-tight ${isHighlighted ? '' : 'text-white/90'}`}>
                {label}
            </div>

            {/* Subtle Timer Cue (Stove Clock Look) */}
            {duration !== undefined && (
                <div className={`absolute top-1 right-2 flex items-center space-x-0.5 text-[10px] font-semibold ${isHighlighted ? 'text-white/80' : 'text-white/50'}`}>
                    <Clock size={10} strokeWidth={2.5} />
                    <span>{formatTime(duration)}</span>
                </div>
            )}
        </motion.div>
    );
};
</file>

<file path="components/RelaxTimer.tsx">
import React, { useState, useCallback } from 'react';
import { motion } from 'framer-motion';
import { Play, Pause, PlusCircle, RotateCcw } from 'lucide-react';
import { ExerciseCard } from './ExerciseCard';
import { ExerciseModal } from './ExerciseModal';

// Re-aliasing motion.div for cleaner use
const MotionDiv = motion.div;

interface Exercise {
  emoji: string;
  label: string;
  description: string;
  duration: number; // in seconds
  animationType: 'breathing' | 'eye' | 'posture' | 'stretch' | 'sunlight' | 'neck' | 'silence';
}

interface RelaxTimerProps {
  onComplete: () => void;
  fatigueScore: number;
}

// Re-ordered exercises to match the requested 3x3 layout organization
const exercises: Exercise[] = [
  // Top Row
  { emoji: '👁️', label: 'Eye Refresh', description: 'Relax eye muscles.', duration: 120, animationType: 'eye' },
  { emoji: '🧍', label: 'Posture Reset', description: 'Align spine and shoulders.', duration: 180, animationType: 'posture' },
  { emoji: '💨', label: 'Breathing', description: 'Deep breathing exercise.', duration: 240, animationType: 'breathing' },
  // Middle Row
  { emoji: '🧘', label: 'Stretch Pulse', description: 'Release muscle tension.', duration: 180, animationType: 'stretch' },
  { emoji: '🌞', label: 'Sunlight', description: 'Reset circadian rhythm.', duration: 60, animationType: 'sunlight' },
  { emoji: '🌀', label: 'Neck Rotation', description: 'Improve neck mobility.', duration: 120, animationType: 'neck' },
  // Bottom Row
  { emoji: '🎧', label: 'Silence Mode', description: 'A moment of stillness.', duration: 180, animationType: 'silence' },
];

// Helper function to format seconds to M:SS
const formatTime = (seconds: number) => {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
};

// PRIMARY COLOR FOR SMALL ACTIONS: Single color for contrast on smaller buttons.
const PRIMARY_ACCENT = 'bg-sky-600 hover:bg-sky-500';

// 🎨 REFINED GLOW: Soft, integrated white/gray luminescence (Apple/Pro aesthetic)
const FUTURISTIC_GLOW = 'shadow-lg shadow-white/10';


export const RelaxTimer: React.FC<RelaxTimerProps> = ({ onComplete }) => {
  const [isRouletteActive, setIsRouletteActive] = useState(false);
  const [selectedExercise, setSelectedExercise] = useState<Exercise | null>(null);
  const [rouletteIndex, setRouletteIndex] = useState(-1);
  const [isGridShrunk, setIsGridShrunk] = useState(false);
  // State for the new control bar features
  const [isTimerRunning, setIsTimerRunning] = useState(false);
  const [timerDuration, setTimerDuration] = useState(180); // Default 3 minutes

  const startRoulette = useCallback(() => {
    if (isRouletteActive) return;

    setIsRouletteActive(true);
    setIsGridShrunk(true);

    let currentIndex = 0;
    let speed = 80;
    const maxSpeed = 400;
    const acceleration = 1.12;
    let iterations = 0;
    const minIterations = 15;

    const animate = () => {
      setRouletteIndex(currentIndex);
      currentIndex = (currentIndex + 1) % exercises.length;
      speed = Math.min(speed * acceleration, maxSpeed);
      iterations++;

      if (speed < maxSpeed || iterations < minIterations) {
        setTimeout(animate, speed);
      } else {
        setTimeout(() => {
          const finalIndex = Math.floor(Math.random() * exercises.length);
          setRouletteIndex(finalIndex);
          setTimerDuration(exercises[finalIndex].duration); // Set duration based on selected exercise

          setTimeout(() => {
            setSelectedExercise(exercises[finalIndex]);
            setIsRouletteActive(false);
          }, 500);
        }, 300);
      }
    };

    animate();
  }, [isRouletteActive]);

  const handleCloseModal = () => {
    setSelectedExercise(null);
    setIsGridShrunk(false);
    setRouletteIndex(-1);
    setIsTimerRunning(false); // Ensure timer state is reset
    onComplete();
  };

  // New control bar handlers
  const toggleTimer = () => setIsTimerRunning(prev => !prev);
  const addOneMinute = () => setTimerDuration(prev => prev + 60);
  const resetTimer = () => setTimerDuration(selectedExercise?.duration || exercises[0].duration); // Reset to default or selected

  return (
    // Outer container: **REMOVED** the conflicting h-full and min-h-screen properties.
    // **REVERTED** justify-center to justify-start, relying on App.tsx for centering.
    <div className="flex flex-col items-center justify-start 
                    max-w-sm mx-auto 
                    bg-zinc-900/70 backdrop-blur-2xl 
                    rounded-[30px] shadow-2xl p-4 
                    border border-white/10 
                    text-white
                    // The centering is now handled by the App.tsx parent component, making the alignment perfect.
                    animate-in fade-in duration-700"
    >
      {/* Inner wrapper (This is the block being centered by the App component) */}
      <div className="flex flex-col items-center">
        {/* Exercise Grid Area */}
        <MotionDiv
          animate={{
            scale: isGridShrunk ? 0.95 : 1,
            opacity: isRouletteActive ? 0.8 : 1
          }}
          transition={{ type: 'spring', stiffness: 200, damping: 20 }}
          className="relative z-20 w-full"
        >
          {/* 3x3 Grid: Tight layout (grid-cols-3, gap-3) */}
          <div className="grid grid-cols-3 gap-3 w-full">
            {exercises.map((exercise, index) => (
              // Kinetic Card Wrapper
              <MotionDiv
                key={index}
                onClick={startRoulette}
                className="cursor-pointer"
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                transition={{ type: "spring", stiffness: 400, damping: 20 }}
              >
                <ExerciseCard
                  // ExerciseCard should still maintain a clear, dark/glassy style internally
                  emoji={exercise.emoji}
                  label={exercise.label}
                  isHighlighted={rouletteIndex === index}
                  scale={selectedExercise?.label === exercise.label ? 1.1 : 1}
                  duration={exercise.duration}
                />
              </MotionDiv>
            ))}

            {/* Empty Slot 1 (Bottom Row, Middle) */}
            <div className="opacity-0 pointer-events-none">
              <div className='min-h-[96px]' />
            </div>

            {/* Status/Timer Card (Sharper Digital Display Screen) */}
            <div className="relative flex flex-col items-center justify-center min-h-[96px] 
              bg-white/5 backdrop-blur-md rounded-xl p-3 
              border border-white/10 text-white shadow-inner 
              shadow-black/20"
            >
              <span className="text-sm font-light mb-1 text-white/70">Total Time</span>
              <span className="text-2xl font-extrabold text-sky-400 drop-shadow-lg">
                {formatTime(timerDuration)}
              </span>
              <span className="text-xs mt-1 font-light text-white/50">Select above</span>
            </div>

          </div>
        </MotionDiv>

        {/* Control Bar (Sharper, Defined Glass Strip - iOS Tab Bar style) */}
        <div className="w-full mt-5 flex items-center justify-between 
          bg-white/5 rounded-2xl p-2.5 
          backdrop-blur-md border border-white/10"
        >

          {/* Left Controls: Play/Pause, Reset (Minimalist/Pro) */}
          <div className="flex space-x-2">
            <MotionDiv whileTap={{ scale: 0.85 }}>
              <button
                onClick={toggleTimer}
                // Single color accent for contrast
                className={`p-2 rounded-xl ${PRIMARY_ACCENT} text-white transition-colors disabled:opacity-50`}
                disabled={!selectedExercise}
                aria-label={isTimerRunning ? 'Pause Timer' : 'Start Timer'}
              >
                {isTimerRunning ? <Pause size={18} /> : <Play size={18} />}
              </button>
            </MotionDiv>
            <MotionDiv whileTap={{ scale: 0.85 }}>
              <button
                onClick={resetTimer}
                className="p-2 rounded-xl bg-white/10 hover:bg-white/20 text-white transition-colors"
                aria-label="Reset Timer"
              >
                <RotateCcw size={18} />
              </button>
            </MotionDiv>
          </div>

          {/* Center Button: Select Exercise (LIGHT, FUTURISTIC, COMPACT BUTTON) */}
          <MotionDiv
            whileHover={{ scale: 1.03 }}
            whileTap={{ scale: 0.97 }}
            transition={{ type: "spring", stiffness: 400, damping: 20 }}
          >
            <button
              onClick={startRoulette}
              disabled={isRouletteActive}
              className={`
                // PADDING & FONT WEIGHT: Compact and Pro (Apple/ChatGPT style)
                px-5 py-2 
                text-sm font-semibold
                
                // NEW LIGHT GLASS AESTHETIC
                bg-white/15 backdrop-blur-sm // Light, high-opacity glass
                text-white
                
                rounded-3xl 
                
                // BORDER & SHADOW: Subtle inner shadow for depth, clean outer shadow for lift
                border border-white/20 // Clean definition
                shadow-inner shadow-white/10 // Subtle inner highlight
                shadow-md shadow-black/50 // Base lift shadow
                
                // 🎨 REFINED GLOW ON HOVER
                hover:bg-white/20
                hover:shadow-[0_0_15px_rgba(255,255,255,0.4)] // Soft, ambient white glow
                ${FUTURISTIC_GLOW}

                transition-all duration-300 ease-in-out
                disabled:opacity-50 disabled:cursor-not-allowed
                
                // 🎨 REFINED ACTIVE STATE VISUALS (When Selecting)
                ${isRouletteActive
                  ? 'animate-pulse ring-2 ring-white/70 shadow-[0_0_15px_rgba(255,255,255,0.7)]'
                  : ''}
              `}
            >
              {isRouletteActive ? 'Selecting...' : 'Select Exercise'}
            </button>
          </MotionDiv>

          {/* Right Controls: Add Time (Minimalist/Pro) */}
          <div className="flex space-x-2">
            <MotionDiv whileTap={{ scale: 0.85 }}>
              <button
                onClick={addOneMinute}
                className="p-2 rounded-xl bg-white/10 hover:bg-white/20 text-white transition-colors"
                aria-label="Add 1 Minute"
              >
                <PlusCircle size={18} />
              </button>
            </MotionDiv>
          </div>
        </div>
      </div>


      {/* Exercise Modal */}
      {selectedExercise && (
        <ExerciseModal
          exercise={selectedExercise}
          onClose={handleCloseModal}
        />
      )}
    </div>
  );
};
</file>

<file path="components/TopNav.tsx">
import React from 'react';
import { motion } from 'framer-motion';
import { AppMode } from '../types';
import { BrainCircuit, Coffee, Activity, User, Moon, Sun } from 'lucide-react';

const MotionDiv = motion.div as any;

interface TopNavProps {
  currentMode: AppMode;
  setMode: (mode: AppMode) => void;
  fatigueScore: number;
}

export const TopNav: React.FC<TopNavProps> = ({ currentMode, setMode, fatigueScore }) => {

  // Determine AI Dot Color based on Fatigue/Status
  const getDotColor = () => {
    if (fatigueScore > 70) return 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.8)]';
    if (fatigueScore > 40) return 'bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.8)]';
    return 'bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.8)]';
  };

  const navItems = [
    { mode: AppMode.FOCUS, label: 'Focus' },
    { mode: AppMode.RELAX, label: 'Relax' },
    { mode: AppMode.STATS, label: 'Insights' },
  ];

  return (
    <MotionDiv
      initial={{ y: -100, opacity: 0 }}
      animate={{ y: 0, opacity: 1 }}
      className="fixed top-6 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-4xl"
    >
      <div className="relative px-6 py-3 rounded-2xl bg-zinc-900/60 backdrop-blur-xl border border-white/5 shadow-2xl flex items-center justify-between">

        {/* Left: Brand */}
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <span className="text-white font-bold text-sm">Y</span>
          </div>
          <span className="hidden sm:block text-gray-200 text-lg font-bold tracking-tight" style={{ fontFamily: "'EB Garamond', serif" }}>Ytterbium</span>
        </div>

        {/* Center: Navigation */}
        <div className="flex items-center gap-1 bg-black/20 p-1 rounded-xl border border-white/5">
          {navItems.map((item) => {
            const isActive = currentMode === item.mode;
            return (
              <button
                key={item.mode}
                onClick={() => setMode(item.mode)}
                className={`relative px-5 py-2 rounded-lg text-sm font-medium transition-colors duration-300 outline-none ${isActive ? 'text-white' : 'text-gray-500 hover:text-gray-300'
                  }`}
              >
                {isActive && (
                  <MotionDiv
                    layoutId="nav-bg"
                    className="absolute inset-0 bg-white/10 rounded-lg shadow-inner"
                    transition={{ type: "spring", stiffness: 400, damping: 30 }}
                  />
                )}
                <span className="relative z-10">{item.label}</span>
              </button>
            );
          })}
        </div>

        {/* Right: Actions */}
        <div className="flex items-center gap-4">

          {/* AI Activity Indicator */}
          <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/40 border border-white/5" title={`AI Load: ${fatigueScore}%`}>
            <div className={`w-2 h-2 rounded-full ${getDotColor()} animate-pulse`} />
            <span className="text-[10px] font-mono text-gray-500 hidden sm:block">AI ACTIVE</span>
          </div>

          {/* Theme Toggle (Visual Only) */}
          <button className="p-2 text-gray-400 hover:text-white transition-colors rounded-full hover:bg-white/5">
            <Moon className="w-4 h-4" />
          </button>

          {/* Avatar */}
          <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-zinc-700 to-zinc-600 border border-white/10 flex items-center justify-center cursor-pointer hover:ring-2 ring-white/20 transition-all">
            <User className="w-4 h-4 text-gray-300" />
          </div>

        </div>
      </div>
    </MotionDiv>
  );
};
</file>

<file path="hooks/useSubscription.ts">
import { useEffect, useState } from 'react';
import { supabase } from '../services/supabase';

import { PostgrestError } from '@supabase/supabase-js';

export interface Subscription {
    id: string;
    status: 'active' | 'canceled' | 'incomplete' | 'revoked';
    product_name: string;
    current_period_end: string;
    is_recurring: boolean;
}

export function useSubscription() {
    const [subscription, setSubscription] = useState<Subscription | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<PostgrestError | null>(null);

    useEffect(() => {
        let authSubscription: any;

        async function fetchSubscription() {
            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    setSubscription(null);
                    setLoading(false);
                    return;
                }

                // We query the helper view we created in the SQL migration
                const { data, error } = await supabase
                    .from('user_subscriptions')
                    .select('*')
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 is 'No rows found'
                    setError(error);
                } else {
                    setSubscription(data as Subscription);
                }
            } catch (err: any) {
                console.error("Subscription fetch failed:", err);
            } finally {
                setLoading(false);
            }
        }

        fetchSubscription();

        // Listen for auth state changes to re-fetch
        const { data: { subscription: authListener } } = supabase.auth.onAuthStateChange(() => {
            fetchSubscription();
        });
        authSubscription = authListener;

        // Subscribe to changes for Real-time Resilience
        const subscriptionChannel = supabase
            .channel('polar_sync_changes')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'polar_subscriptions' },
                () => fetchSubscription()
            )
            .subscribe();

        return () => {
            if (authSubscription) authSubscription.unsubscribe();
            supabase.removeChannel(subscriptionChannel);
        };
    }, []);


    return {
        subscription,
        loading,
        error,
        isPremium: subscription?.status === 'active'
    };
}
</file>

<file path="services/fatigueService.ts">
import { FatigueMetrics, FocusIntensity } from '../types';

// Constants for detection logic
const WINDOW_SIZE_MS = 5000; // Process metrics every 5 seconds

// Adaptive Baseline Storage Keys
const KEY_LATENCY_BASELINE = 'ytterbium_latency_baseline';
const KEY_VARIANCE_BASELINE = 'ytterbium_variance_baseline';

// Default baselines (used until a user baseline is established)
const DEFAULT_BASELINE_LATENCY = 120; // ms (Example baseline)
const DEFAULT_BASELINE_VARIANCE = 30; // ms

// ----------------------------------------------------------------------------------
// [NEW CONSTANT] Factor to adjust score based on Intensity. 
// At Intensity 10, the score is 20% higher. At Intensity 1, the score is 16% lower.
// ----------------------------------------------------------------------------------
const getIntensitySensitivityFactor = (intensity: FocusIntensity): number => {
  // 5 is the neutral intensity (Factor 1.0)
  return 1.0 + ((intensity - 5) / 5) * 0.2;
}

class FatigueService {
  private lastKeyTime: number = 0;
  private keyLatencies: number[] = [];
  private lastMousePos: { x: number; y: number } | null = null;
  private mouseDistance: number = 0;
  private mouseMoves: number = 0;
  private mouseDirectionChanges: number = 0;
  private lastMouseAngle: number = 0;

  private listenersAttached: boolean = false;
  private onMetricsUpdate: ((metrics: FatigueMetrics) => void) | null = null;
  private intervalId: number | null = null;

  // Adaptive Baseline Properties
  private userBaselineLatency: number;
  private userBaselineVariance: number;

  // ----------------------------------------------------------------------------------
  // [NEW PROPERTY] To store the user's selected intensity
  private currentIntensity: FocusIntensity = 5;
  // ----------------------------------------------------------------------------------

  // Rolling scores for smoothing
  private recentScores: number[] = [];

  constructor() {
    this.userBaselineLatency = FatigueService.getBaseline(KEY_LATENCY_BASELINE, DEFAULT_BASELINE_LATENCY);
    this.userBaselineVariance = FatigueService.getBaseline(KEY_VARIANCE_BASELINE, DEFAULT_BASELINE_VARIANCE);
  }

  // --- Persistence and Baseline Helpers (Preserved) ---
  private static getBaseline(key: string, defaultValue: number): number {
    const value = localStorage.getItem(key);
    return value ? parseFloat(value) : defaultValue;
  }

  private static setBaseline(key: string, value: number): void {
    const currentBest = FatigueService.getBaseline(key, value);
    // Only save the best (lowest) values
    if (value < currentBest) {
      localStorage.setItem(key, value.toString());
    }
  }

  // --- Input Handlers (Preserved) ---
  private handleKeyDown = (event: KeyboardEvent) => {
    const now = performance.now();
    if (this.lastKeyTime !== 0) {
      const latency = now - this.lastKeyTime;
      this.keyLatencies.push(latency);
    }
    this.lastKeyTime = now;
  };

  private handleMouseMove = (event: MouseEvent) => {
    this.mouseMoves++;
    if (this.lastMousePos) {
      const dx = event.clientX - this.lastMousePos.x;
      const dy = event.clientY - this.lastMousePos.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      this.mouseDistance += distance;

      // Track direction changes for erratic movement detection
      if (distance > 5) { // Only track meaningful movement
        const angle = Math.atan2(dy, dx);
        if (this.lastMouseAngle !== 0 && Math.abs(angle - this.lastMouseAngle) > Math.PI / 4) {
          this.mouseDirectionChanges++;
        }
        this.lastMouseAngle = angle;
      }
    }
    this.lastMousePos = { x: event.clientX, y: event.clientY };
  };

  // --- Core Logic: Calculate Metrics ---
  private calculateMetrics = () => {
    if (!this.onMetricsUpdate) return;

    // Calculate averages and stats for the window
    const avgLatency = this.keyLatencies.length > 0 ? this.keyLatencies.reduce((a, b) => a + b, 0) / this.keyLatencies.length : 0;
    const mouseVelocity = this.mouseDistance * (1000 / WINDOW_SIZE_MS); // Px per second
    const erraticScore = this.mouseDirectionChanges;

    // Calculate Standard Deviation (Jitter)
    const mean = avgLatency;
    const stdDev = this.keyLatencies.length > 1
      ? Math.sqrt(this.keyLatencies.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (this.keyLatencies.length - 1))
      : 0;

    // --- 1. FATIGUE SCORING ---
    let fatigueScore = 0;

    // Cognitive Slowing Score (40% weight)
    const cognitiveSlowingScore = Math.max(0, avgLatency - this.userBaselineLatency) / this.userBaselineLatency * 100 * 0.4;
    fatigueScore += cognitiveSlowingScore;

    // Motor Control Inconsistency Score (30% weight)
    const motorInconsistencyScore = Math.max(0, stdDev - this.userBaselineVariance) / this.userBaselineVariance * 100 * 0.3;
    fatigueScore += motorInconsistencyScore;

    // Mouse Dynamics Score (Sluggish or Erratic)
    if (mouseVelocity < 50 && this.mouseMoves > 0) {
      // Moving but very slowly (sluggish/disengaged)
      fatigueScore += 10;
    }
    if (erraticScore > 2) {
      // Jittery movement (frustration/loss of fine motor control)
      fatigueScore += 20;
    }

    // Additional Factor: Non-Activity Penalty (Stagnation)
    if (this.keyLatencies.length === 0 && this.mouseMoves < 5) {
      // Very low input: Apply a gentle penalty to detect long periods of disengagement.
      fatigueScore += 5;
    }

    // ----------------------------------------------------------------------------------
    // [NEW LOGIC] Apply Intensity Sensitivity Factor to the raw score
    const sensitivityFactor = getIntensitySensitivityFactor(this.currentIntensity);
    fatigueScore *= sensitivityFactor;
    // ----------------------------------------------------------------------------------

    // Clamp score
    fatigueScore = Math.min(100, Math.max(0, fatigueScore));

    // Smoothing
    this.recentScores.push(fatigueScore);
    if (this.recentScores.length > 5) this.recentScores.shift();
    const smoothedScore = this.recentScores.reduce((a, b) => a + b, 0) / this.recentScores.length;

    const metrics: FatigueMetrics = {
      timestamp: Date.now(),
      keystrokeLatencyMs: avgLatency,
      typingSpeedWpm: this.keyLatencies.length * (60000 / WINDOW_SIZE_MS) / 5, // Approx WPM
      mouseDistancePx: this.mouseDistance,
      mouseVelocityPxPerSec: mouseVelocity,
      erraticMouseMovement: erraticScore > 2,
      fatigueScore: Math.round(smoothedScore)
    };

    if (avgLatency > 0 && stdDev > 0) {
      FatigueService.setBaseline(KEY_LATENCY_BASELINE, avgLatency);
      FatigueService.setBaseline(KEY_VARIANCE_BASELINE, stdDev);
    }

    this.onMetricsUpdate(metrics);

    // --- Reset for next window ---
    this.keyLatencies = [];
    this.mouseDistance = 0;
    this.mouseMoves = 0;
    this.mouseDirectionChanges = 0;
    this.lastKeyTime = 0;
  };

  // --- Tracking Controls ---
  // [MODIFIED] Added intensity parameter
  public startTracking(onMetricsUpdate: (metrics: FatigueMetrics) => void, intensity: FocusIntensity = 5) {
    if (this.listenersAttached) return;

    this.onMetricsUpdate = onMetricsUpdate;
    this.currentIntensity = intensity; // [UPDATE] Set the new intensity

    document.addEventListener('keydown', this.handleKeyDown);
    document.addEventListener('mousemove', this.handleMouseMove);
    this.listenersAttached = true;

    // Start interval
    this.intervalId = window.setInterval(this.calculateMetrics, WINDOW_SIZE_MS);
  }

  public stopTracking() {
    if (this.intervalId !== null) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    if (this.listenersAttached) {
      document.removeEventListener('keydown', this.handleKeyDown);
      document.removeEventListener('mousemove', this.handleMouseMove);
      this.listenersAttached = false;
    }
    // Clear temporary data on stop
    this.keyLatencies = [];
    this.recentScores = [];
    this.lastKeyTime = 0;
  }
}

export const fatigueService = new FatigueService();
</file>

<file path="types.ts">
export enum AppMode {
  FOCUS = 'FOCUS',
  RELAX = 'RELAX',
  STATS = 'STATS'
}

export enum SessionStatus {
  IDLE = 'IDLE',
  RUNNING = 'RUNNING',
  PAUSED = 'PAUSED',
  COMPLETED = 'COMPLETED'
}

// ----------------------------------------------------------------------------------
// [NEW TYPE] Focus Intensity (1-10) for AI sensitivity control
export type FocusIntensity = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10;
// ----------------------------------------------------------------------------------


export interface Task {
  id: string;
  title: string;
  completed: boolean;
  priority: 'low' | 'medium' | 'high';
}

export interface FatigueMetrics {
  timestamp: number;
  keystrokeLatencyMs: number; // Average latency between keystrokes in this window
  typingSpeedWpm: number;
  mouseDistancePx: number;
  mouseVelocityPxPerSec: number;
  erraticMouseMovement: boolean; // Computed based on trajectory changes
  fatigueScore: number; // 0 (fresh) to 100 (exhausted)
}

export interface SessionData {
  id: string;
  startTime: number;
  endTime?: number;
  durationSeconds: number; // Planned duration
  elapsedSeconds: number; // Actual elapsed
  type: 'FOCUS' | 'RELAX';
  fqs: number; // Focus Quality Score (0-100)
}

export interface Insight {
  type: 'suggestion' | 'warning' | 'kudos';
  message: string;
  timestamp: number;
}
</file>

<file path="vercel.json">
{
    "buildCommand": "npm run build",
    "outputDirectory": "dist",
    "installCommand": "npm install",
    "framework": "vite",
    "rewrites": [
        {
            "source": "/api/(.*)",
            "destination": "/api/$1"
        },
        {
            "source": "/((?!api/).*)",
            "destination": "/index.html"
        }
    ]
}
</file>

<file path="vite.config.ts">
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, '.', '');
  return {
    server: {
      port: 3000,
      host: '0.0.0.0',
      proxy: {
        '/api/ollama': {
          target: 'http://localhost:11434',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api\/ollama/, ''),
        },
        '/api/gemini': {
          target: 'https://generativelanguage.googleapis.com',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api\/gemini/, ''),
        }
      }
    },
    plugins: [react()],
    define: {
      'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
      'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
    },
    resolve: {
      alias: {
        '@': path.resolve(__dirname, '.'),
      }
    }
  };
});
</file>

<file path=".env.example">
# Supabase Configuration
# Copy this file to .env.local and fill in your actual values

VITE_SUPABASE_URL=https://ocgsabgeikikddgutthh.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here

# Polar.sh Configuration
POLAR_ACCESS_TOKEN=your_token
POLAR_SUCCESS_URL=https://your-domain.com/success
# Plan-specific IDs
POLAR_ANNUAL_PRODUCT_ID=your_annual_product_id
POLAR_MONTHLY_PRODUCT_ID=your_monthly_product_id
# Fallback/Discovery
POLAR_PRODUCT_ID=your_product_id
POLAR_ORGANIZATION_ID=your_organization_id
POLAR_WEBHOOK_SECRET=your_webhook_secret
</file>

<file path="components/AuthModal.tsx">
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { authService } from '../services/authService';
import type { User } from '@supabase/supabase-js';

interface AuthModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSuccess: (user: User) => void;
    intensityMode: string;
}

export const AuthModal: React.FC<AuthModalProps> = ({ isOpen, onClose, onSuccess, intensityMode }) => {
    const [mode, setMode] = useState<'signin' | 'signup'>('signup');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [fullName, setFullName] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
            if (mode === 'signup') {
                const { user, error: authError } = await authService.signUp(email, password, fullName);
                if (authError) throw authError;
                if (user) onSuccess(user);
            } else {
                const { user, error: authError } = await authService.signIn(email, password);
                if (authError) throw authError;
                if (user) onSuccess(user);
            }
        } catch (err: any) {
            setError(err.message || 'Authentication failed');
        } finally {
            setLoading(false);
        }
    };

    return (
        <AnimatePresence>
            {isOpen && (
                <div className="fixed inset-0 z-[3000] flex items-center justify-center p-6">
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={onClose}
                        className="absolute inset-0 bg-black/60 backdrop-blur-md"
                    />

                    {/* Modal Content */}
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9, y: 30 }}
                        animate={{ opacity: 1, scale: 1, y: 0 }}
                        exit={{ opacity: 0, scale: 0.9, y: 30 }}
                        className="relative overflow-hidden backdrop-blur-3xl bg-zinc-900/80 border border-white/10 rounded-[40px] p-10 md:p-14 shadow-[0_40px_120px_-20px_rgba(0,0,0,0.8)] max-w-md w-full"
                    >
                        {/* Inner Rim Light */}
                        <div className="absolute inset-0 rounded-[40px] pointer-events-none border border-white/5 shadow-[inset_0_1px_1px_rgba(255,255,255,0.05)]" />

                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-black tracking-tighter text-white mb-3">
                                Secure your session.
                            </h2>
                            <p className="text-sm text-zinc-400 font-medium leading-relaxed px-4">
                                We have classified your work as <span className="text-indigo-400 font-bold">{intensityMode}</span>. Sign in to enable AI fatigue detection and save your focus history.
                            </p>
                        </div>

                        {/* Social Auth */}
                        <div className="space-y-4 mb-8">
                            <motion.button
                                whileHover={{ scale: 1.02 }}
                                whileTap={{ scale: 0.98 }}
                                onClick={async () => {
                                    setLoading(true);
                                    setError('');
                                    try {
                                        const { error: authError } = await authService.signInWithGoogle();
                                        if (authError) throw authError;
                                    } catch (err: any) {
                                        setError(err.message || 'Authentication failed');
                                        setLoading(false);
                                    }
                                }}
                                disabled={loading}
                                className="w-full py-4 bg-white text-black font-bold rounded-2xl flex items-center justify-center gap-3 transition-colors hover:bg-zinc-200 disabled:opacity-50"
                            >
                                <svg className="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M12.545,11.071L12,11.071L12,12.929L15.636,12.929C15.111,15.111 13.555,16.555 12,16.555C9.485,16.555 7.445,14.515 7.445,12C7.445,9.485 9.485,7.445 12,7.445C13.2,7.445 14.155,7.889 14.777,8.555L16.222,7.111C15.155,6.111 13.666,5.555 12,5.555C8.445,5.555 5.555,8.445 5.555,12C5.555,15.555 8.445,18.445 12,18.445C16.889,18.445 20,15.111 20,12C20,11.111 19.889,10.222 19.666,9.445L12,9.445L12,11.071L12.545,11.071Z" />
                                </svg>
                                <span className="text-[10px] uppercase tracking-[0.2em] font-black">
                                    {loading ? 'Redirecting...' : 'Continue with Google'}
                                </span>
                            </motion.button>
                        </div>

                        {error && (
                            <p className="text-red-400 text-xs text-center font-medium bg-red-400/10 py-3 rounded-xl border border-red-400/20 mb-4">
                                {error}
                            </p>
                        )}

                        <p className="text-[9px] text-zinc-500 text-center uppercase tracking-widest leading-relaxed">
                            Sign in to enable AI fatigue detection<br />and save your focus history.
                        </p>
                    </motion.div>
                </div>
            )}
        </AnimatePresence>
    );
};
</file>

<file path="components/StatsView.tsx">
import React, { useMemo } from 'react';
import { AreaChart, Area, ResponsiveContainer, YAxis } from 'recharts';
import { motion } from 'framer-motion';
import { BrainCircuit, Bolt, Zap, Trophy, TrendingUp, TrendingDown } from 'lucide-react';
import { FatigueMetrics } from '../types';

interface StatsViewProps {
  metricsHistory: FatigueMetrics[];
}

// Custom component to ensure the Gold Bar icon is consistent and beautiful
const GoldBarIcon = () => (
  <Trophy className="w-4 h-4 text-amber-500/80 fill-amber-500/20" strokeWidth={1.5} />
);

export const StatsView: React.FC<StatsViewProps> = ({ metricsHistory }) => {
  // 1. Enhanced AI Session Analysis
  const sessionAnalysis = useMemo(() => {
    // Mock Data and Logic for a richer scenario
    const safeHistory = metricsHistory.length > 0 ? metricsHistory : [
      { timestamp: Date.now() - 30000, fatigueScore: 20, keystrokeLatencyMs: 120 },
      { timestamp: Date.now() - 20000, fatigueScore: 35, keystrokeLatencyMs: 130 },
      { timestamp: Date.now() - 10000, fatigueScore: 50, keystrokeLatencyMs: 140 },
      { timestamp: Date.now(), fatigueScore: 88, keystrokeLatencyMs: 250 }, // Critical Spike
    ];

    const lastMetric = safeHistory[safeHistory.length - 1];
    const maxFatigue = safeHistory.reduce((max, curr) => Math.max(max, curr.fatigueScore), 0);
    const initialLatency = safeHistory[0]?.keystrokeLatencyMs || 100;
    const latencyChange = lastMetric.keystrokeLatencyMs - initialLatency;

    // Determine the outcome and key metrics
    const isFatigueStop = maxFatigue > 80;

    let verdict, reason, keyMetricValue, keyMetricLabel, accentColor, icon;

    if (isFatigueStop) {
      verdict = "Critical Fatigue Detected. Protection Engaged.";
      reason = `The AI proactively ended the session to prevent cognitive burnout.`;
      keyMetricValue = `${latencyChange > 0 ? '+' : ''}${latencyChange}ms`;
      keyMetricLabel = 'Typing Latency Shift';
      accentColor = "#ef4444"; // Red (Burnout/Stop)
      icon = Zap;
    } else {
      verdict = "Sustained Deep Focus Achieved.";
      reason = "Your cognitive stability remained excellent across all key focus vectors.";
      keyMetricValue = `+${Math.floor(maxFatigue / 10)}%`;
      keyMetricLabel = 'Peak Stability Index';
      accentColor = "#34d399"; // Green (Flow/Success)
      icon = Bolt;
    }

    return {
      verdict,
      reason,
      keyMetricValue,
      keyMetricLabel,
      icon,
      data: safeHistory.map(m => ({
        value: m.fatigueScore,
        safeZone: 75, // The line where fatigue becomes risky
        sessionTime: m.timestamp
      })),
      goldBars: 5, // Enhanced daily reward
      accentColor,
      isFatigueStop
    };
  }, [metricsHistory]);

  const Icon = sessionAnalysis.icon;

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4 }}
      className="w-full h-full bg-zinc-900/50 backdrop-blur-xl border border-white/10 rounded-3xl overflow-hidden shadow-[0_0_60px_rgba(0,0,0,0.6)] relative flex flex-col"
    >

      {/* Header (Clean, Pro Look) */}
      <div className="px-4 py-3 border-b border-white/5 flex items-center bg-white/5 relative z-10 shrink-0">
        <Icon className={`w-4 h-4 mr-2 ${sessionAnalysis.isFatigueStop ? 'text-red-400' : 'text-emerald-400'}`} />
        <h3 className="text-xs font-semibold text-gray-300 uppercase tracking-widest" style={{ fontFamily: "'EB Garamond', serif" }}>Ytterbium Insights</h3>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col justify-between p-6 relative z-10">

        {/* 1. System Verdict (PRIMARY - Dominant, Empathetic) */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="text-left mb-6"
        >
          <h2 className="text-2xl md:text-3xl font-light text-zinc-50 tracking-tight leading-normal">
            {sessionAnalysis.verdict}
          </h2>
        </motion.div>

        {/* 2. Visual Confirmation (SECONDARY - The Trust Band) */}
        <motion.div
          initial={{ scaleX: 0 }}
          animate={{ scaleX: 1 }}
          transition={{ delay: 0.4, duration: 1, type: "spring", stiffness: 50 }}
          style={{ originX: 0 }}
          className="w-full h-20 mb-6 relative -mx-2" // Slightly wider than content for dramatic effect
        >
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={sessionAnalysis.data}>
              <defs>
                {/* Gradient for the fatigue curve */}
                <linearGradient id="fatigueGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={sessionAnalysis.accentColor} stopOpacity={0.4} />
                  <stop offset="95%" stopColor={sessionAnalysis.accentColor} stopOpacity={0.0} />
                </linearGradient>
                {/* Gradient for the Confidence Band (Subtle grey fill) */}
                <linearGradient id="safeZoneGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stopColor="#a1a1aa" stopOpacity={0.05} />
                  <stop offset="100%" stopColor="#a1a1aa" stopOpacity={0.0} />
                </linearGradient>
              </defs>

              {/* The "Safe Zone" Band (Low Opacity, Non-data line) */}
              <Area
                type="monotone"
                dataKey="safeZone"
                stroke="#a1a1aa" // Zinc-400
                strokeWidth={1}
                strokeDasharray="4 4" // Dotted line for the threshold
                fill="url(#safeZoneGradient)"
                fillOpacity={0.1}
                dot={false}
              />

              {/* The Actual Fatigue Curve */}
              <Area
                type="monotone"
                dataKey="value"
                stroke={sessionAnalysis.accentColor}
                strokeWidth={2}
                fill="url(#fatigueGradient)"
                dot={false}
                isAnimationActive={true}
                animationDuration={1800}
              />
            </AreaChart>
          </ResponsiveContainer>

        </motion.div>

        {/* Pro Context: Key Metric Card */}
        <motion.div
          initial={{ opacity: 0, y: 5 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className={`flex justify-between items-center p-3 rounded-xl mb-6 border ${sessionAnalysis.isFatigueStop ? 'border-red-600/30 bg-red-900/20' : 'border-emerald-600/30 bg-emerald-900/20'}`}
        >
          <div className='flex flex-col'>
            <span className='text-[10px] text-zinc-400 uppercase tracking-wider font-semibold'>Key Metric</span>
            <span className={`text-lg font-light ${sessionAnalysis.isFatigueStop ? 'text-red-300' : 'text-emerald-300'}`}>
              {sessionAnalysis.keyMetricLabel}
            </span>
          </div>
          <div className='flex items-center gap-1'>
            {sessionAnalysis.isFatigueStop ? <TrendingDown className='w-4 h-4 text-red-400' /> : <TrendingUp className='w-4 h-4 text-emerald-400' />}
            <span className={`text-xl font-mono ${sessionAnalysis.isFatigueStop ? 'text-red-200' : 'text-emerald-200'}`}>
              {sessionAnalysis.keyMetricValue}
            </span>
          </div>
        </motion.div>

        {/* 3. System Reason (TERTIARY - Direct Explanation) */}
        <motion.p
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.8 }}
          className="text-sm text-zinc-400 font-normal leading-relaxed text-left border-l-2 pl-3 border-zinc-700"
        >
          {sessionAnalysis.reason}
        </motion.p>
      </div>

      {/* 4. Gold Bars Summary (QUATERNARY - Clean Footer) */}
      <div className="px-6 py-4 bg-white/5 border-t border-white/5 flex justify-between items-center relative z-10">
        <div className="flex items-center gap-2 opacity-70">
          <GoldBarIcon />
          <span className="text-xs font-medium text-zinc-400">DAILY GOLD BARS</span>
        </div>

        <div className="flex items-center">
          <span className="text-xl font-light text-amber-300">
            +{sessionAnalysis.goldBars}
          </span>
        </div>
      </div>

    </motion.div>
  );
};
</file>

<file path="services/databaseService.ts">
import { supabase } from './supabase';
import type { Database } from './supabase';
import type { Task, FatigueMetrics, SessionData } from '../types';

type Profile = Database['public']['Tables']['profiles']['Row'];
type DbSession = Database['public']['Tables']['sessions']['Row'];
type DbTask = Database['public']['Tables']['tasks']['Row'];
type DbMetrics = Database['public']['Tables']['fatigue_metrics']['Row'];

class DatabaseService {
    // ==================== PROFILE OPERATIONS ====================

    async getProfile(userId: string): Promise<Profile | null> {
        try {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();

            if (error) throw error;
            return data;
        } catch (err) {
            console.error('Get profile error:', err);
            return null;
        }
    }

    async updateProfile(userId: string, updates: { full_name?: string, total_reserve?: number }): Promise<boolean> {
        try {
            const { error } = await supabase
                .from('profiles')
                .update({ ...updates, updated_at: new Date().toISOString() })
                .eq('id', userId);

            if (error) throw error;
            return true;
        } catch (err) {
            console.error('Update profile error:', err);
            return false;
        }
    }

    // ==================== VAULT OPERATIONS ====================

    async getVaultStats(userId: string): Promise<{ barsToday: number; totalBars: number }> {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 1. Get today's yield (1 bar per 10 minutes of completed focus sessions since midnight)
            const { data: sessionData, error: sessionError } = await supabase
                .from('sessions')
                .select('elapsed_seconds')
                .eq('user_id', userId)
                .eq('status', 'COMPLETED')
                .eq('type', 'FOCUS')
                .gte('created_at', today.toISOString());

            if (sessionError) throw sessionError;

            const totalSecondsToday = sessionData?.reduce((acc, s) => acc + (s.elapsed_seconds || 0), 0) || 0;
            const barsToday = Math.floor(totalSecondsToday / 600);

            // 2. Get total reserve from profile
            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('*') // Select all to avoid schema mismatch issues if specific field is missing
                .eq('id', userId)
                .single();

            let totalBars = 0;
            if (!profileError && profileData) {
                totalBars = (profileData as any).total_reserve || 0;
            }

            return { barsToday, totalBars };
        } catch (err) {
            console.error('Get vault stats error:', err);
            return { barsToday: 0, totalBars: 0 };
        }
    }

    async incrementTotalReserve(userId: string, amount: number = 1): Promise<boolean> {
        try {
            const stats = await this.getVaultStats(userId);
            return await this.updateProfile(userId, { total_reserve: stats.totalBars + amount });
        } catch (err) {
            console.error('Increment total reserve error:', err);
            return false;
        }
    }

    async incrementFreeSessionsUsed(userId: string): Promise<boolean> {
        try {
            // Get current count
            const { data: profile, error: getError } = await supabase
                .from('profiles')
                .select('free_sessions_used')
                .eq('id', userId)
                .single();

            if (getError) return false;

            const current = (profile as any)?.free_sessions_used || 0;

            // Increment
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ free_sessions_used: current + 1 })
                .eq('id', userId);

            return !updateError;
        } catch (err) {
            console.error('Increment free sessions error:', err);
            return false;
        }
    }

    // ==================== SESSION OPERATIONS ====================

    async createSession(
        userId: string | null,
        sessionData: {
            duration_seconds: number;
            type: 'FOCUS' | 'RELAX';
            focus_intensity: number;
        }
    ): Promise<string | null> {
        try {
            const { data, error } = await supabase
                .from('sessions')
                .insert({
                    user_id: userId,
                    duration_seconds: sessionData.duration_seconds,
                    elapsed_seconds: 0,
                    type: sessionData.type,
                    focus_intensity: sessionData.focus_intensity,
                    fqs: 0,
                    status: 'IDLE',
                    start_time: new Date().toISOString(),
                })
                .select('id')
                .single();

            if (error) throw error;
            return data.id;
        } catch (err) {
            console.error('Create session error:', err);
            return null;
        }
    }

    async updateSession(
        sessionId: string,
        updates: {
            elapsed_seconds?: number;
            status?: 'IDLE' | 'RUNNING' | 'PAUSED' | 'COMPLETED';
            fqs?: number;
            end_time?: string;
        }
    ): Promise<boolean> {
        try {
            const { error } = await supabase
                .from('sessions')
                .update(updates)
                .eq('id', sessionId);

            if (error) throw error;
            return true;
        } catch (err) {
            console.error('Update session error:', err);
            return false;
        }
    }

    async getSessionHistory(userId: string, limit: number = 50): Promise<DbSession[]> {
        try {
            const { data, error } = await supabase
                .from('sessions')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(limit);

            if (error) throw error;
            return data || [];
        } catch (err) {
            console.error('Get session history error:', err);
            return [];
        }
    }

    async getCurrentSession(userId: string): Promise<DbSession | null> {
        try {
            const { data, error } = await supabase
                .from('sessions')
                .select('*')
                .eq('user_id', userId)
                .in('status', ['RUNNING', 'PAUSED'])
                .order('created_at', { ascending: false })
                .limit(1)
                .single();

            if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows
            return data;
        } catch (err) {
            console.error('Get current session error:', err);
            return null;
        }
    }

    // ==================== TASK OPERATIONS ====================

    async createTask(
        userId: string | null,
        task: {
            title: string;
            priority?: 'low' | 'medium' | 'high';
            session_id?: string;
        }
    ): Promise<DbTask | null> {
        try {
            const { data, error } = await supabase
                .from('tasks')
                .insert({
                    user_id: userId,
                    title: task.title,
                    priority: task.priority || 'medium',
                    session_id: task.session_id || null,
                    completed: false,
                })
                .select()
                .single();

            if (error) throw error;
            return data;
        } catch (err) {
            console.error('Create task error:', err);
            return null;
        }
    }

    async updateTask(
        taskId: string,
        updates: {
            title?: string;
            completed?: boolean;
            priority?: 'low' | 'medium' | 'high';
            session_id?: string;
        }
    ): Promise<boolean> {
        try {
            const { error } = await supabase
                .from('tasks')
                .update({ ...updates, updated_at: new Date().toISOString() })
                .eq('id', taskId);

            if (error) throw error;
            return true;
        } catch (err) {
            console.error('Update task error:', err);
            return false;
        }
    }

    async deleteTask(taskId: string): Promise<boolean> {
        try {
            const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', taskId);

            if (error) throw error;
            return true;
        } catch (err) {
            console.error('Delete task error:', err);
            return false;
        }
    }

    async getTasks(userId: string, includeCompleted: boolean = true): Promise<DbTask[]> {
        try {
            let query = supabase
                .from('tasks')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });

            if (!includeCompleted) {
                query = query.eq('completed', false);
            }

            const { data, error } = await query;

            if (error) throw error;
            return data || [];
        } catch (err) {
            console.error('Get tasks error:', err);
            return [];
        }
    }

    /**
     * Subscribe to real-time task updates for a user
     */
    subscribeToTasks(userId: string, callback: (payload: any) => void) {
        return supabase
            .channel(`tasks:user_id=eq.${userId}`)
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'tasks',
                    filter: `user_id=eq.${userId}`,
                },
                (payload) => callback(payload)
            )
            .subscribe();
    }

    /**
     * "Claim" an anonymous session and its tasks for a newly authenticated user
     */
    async claimGhostData(userId: string, sessionId: string): Promise<boolean> {
        try {
            // 1. Update session
            const { error: sessionError } = await supabase
                .from('sessions')
                .update({ user_id: userId })
                .eq('id', sessionId)
                .is('user_id', null);

            if (sessionError) throw sessionError;

            // 2. Update all tasks linked to this session
            const { error: tasksError } = await supabase
                .from('tasks')
                .update({ user_id: userId })
                .eq('session_id', sessionId)
                .is('user_id', null);

            if (tasksError) throw tasksError;

            return true;
        } catch (err) {
            console.error('Claim ghost data error:', err);
            return false;
        }
    }

    // ==================== METRICS OPERATIONS ====================

    async saveMetrics(sessionId: string, metrics: FatigueMetrics): Promise<boolean> {
        try {
            const { error } = await supabase
                .from('fatigue_metrics')
                .insert({
                    session_id: sessionId,
                    timestamp: metrics.timestamp,
                    keystroke_latency_ms: metrics.keystrokeLatencyMs,
                    typing_speed_wpm: metrics.typingSpeedWpm,
                    mouse_distance_px: metrics.mouseDistancePx,
                    mouse_velocity_px_per_sec: metrics.mouseVelocityPxPerSec,
                    erratic_mouse_movement: metrics.erraticMouseMovement,
                    fatigue_score: metrics.fatigueScore,
                });

            if (error) throw error;
            return true;
        } catch (err) {
            console.error('Save metrics error:', err);
            return false;
        }
    }

    async getSessionMetrics(sessionId: string): Promise<DbMetrics[]> {
        try {
            const { data, error } = await supabase
                .from('fatigue_metrics')
                .select('*')
                .eq('session_id', sessionId)
                .order('timestamp', { ascending: true });

            if (error) throw error;
            return data || [];
        } catch (err) {
            console.error('Get session metrics error:', err);
            return [];
        }
    }

    // ==================== UTILITY FUNCTIONS ====================

    /**
     * Convert database task to app task format
     */
    dbTaskToTask(dbTask: DbTask): Task {
        return {
            id: dbTask.id,
            title: dbTask.title,
            completed: dbTask.completed,
            priority: dbTask.priority,
        };
    }

    /**
     * Convert database session to app session format
     */
    dbSessionToSession(dbSession: DbSession): SessionData {
        return {
            id: dbSession.id,
            startTime: new Date(dbSession.start_time).getTime(),
            endTime: dbSession.end_time ? new Date(dbSession.end_time).getTime() : undefined,
            durationSeconds: dbSession.duration_seconds,
            elapsedSeconds: dbSession.elapsed_seconds,
            type: dbSession.type,
            fqs: dbSession.fqs,
        };
    }
}

export const databaseService = new DatabaseService();
</file>

<file path="services/geminiService.ts">
import { FatigueMetrics, FocusIntensity } from "../types";

const GEMINI_API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

export const getGeminiInsight = async (
  metrics: FatigueMetrics[],
  currentFocusDuration: number,
  completedTasks: number
): Promise<string> => {
  if (!GEMINI_API_KEY) return "Neural focus optimal. Proceed.";

  try {
    const avgFatigue = metrics.length > 0
      ? metrics.reduce((acc, m) => acc + m.fatigueScore, 0) / metrics.length
      : 0;

    const prompt = `
      System Instruction: You are Ytterbium, an intelligent productivity and well-being assistant. 
      Tone: Professional, calm, minimalist. Maximum 40 words.
      
      Session Data:
      - Focus Duration: ${Math.round(currentFocusDuration / 60)}m
      - Fatigue Score: ${Math.round(avgFatigue)}
      - Completed Tasks: ${completedTasks}
      
      Suggest one specific improvement for the user's focus or health based on this data.
    `;

    const response = await fetch(GEMINI_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    if (!response.ok) return "Stay focused, you're doing well.";

    const data = await response.json();
    return data.candidates[0].content.parts[0].text.trim() || "Stay focused, you're doing well.";

  } catch (error) {
    console.error("Gemini Insight Error:", error);
    return "Neural focus optimal. Proceed.";
  }
};

export const generateRelaxationGuide = async (fatigueLevel: number): Promise<string> => {
  if (!GEMINI_API_KEY) return "Inhale deeply, exhale slowly.";

  try {
    const prompt = `Generate a 2-sentence calming relaxation guide for fatigue level ${fatigueLevel}/100. Be minimalist.`;

    const response = await fetch(GEMINI_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    if (!response.ok) return "Take a deep breath.";

    const data = await response.json();
    return data.candidates[0].content.parts[0].text.trim() || "Take a deep breath.";

  } catch (e) {
    return "Inhale deeply, exhale slowly.";
  }
};

export const analyzeTaskGemini = async (taskDescription: string) => {
  if (!GEMINI_API_KEY) throw new Error("Gemini API Key missing");

  try {
    const prompt = `
            Analyze this task: "${taskDescription}"
            
            Identify the most appropriate focus mode:
            1. "Creative Focus" (Intensity 3): For ideation, writing, or design.
            2. "Balanced Focus" (Intensity 6): For regular work, admin, or coding.
            3. "Deep Laser Focus" (Intensity 10): For intense problem solving or deep learning.
            
            Return a JSON object exactly like this (no markdown, just raw JSON):
            {
                "taskType": "Short category name",
                "focusMode": "Creative Focus" | "Balanced Focus" | "Deep Laser Focus",
                "explanation": "One short sentence explaining why",
                "suggestedIntensity": 3 | 6 | 10,
                "thinking_trace": "Brief internal neural analysis"
            }
        `;

    const response = await fetch(GEMINI_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
          responseMimeType: "application/json",
        }
      })
    });

    if (!response.ok) throw new Error("Gemini API call failed");

    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    const parsed = JSON.parse(text);

    return {
      taskType: parsed.taskType || "Task",
      focusMode: parsed.focusMode || "Balanced Focus",
      explanation: parsed.explanation || "Cognitive calibration complete.",
      suggestedIntensity: (parsed.suggestedIntensity || 6) as FocusIntensity,
      rawReasoning: parsed.thinking_trace,
      source: 'Cloud (Gemini)' as const
    };
  } catch (error) {
    console.error("Gemini Task Analysis Error:", error);
    throw error;
  }
};
</file>

<file path="services/ollamaService.ts">
import { FocusIntensity } from '../types';
import { analyzeTaskGemini } from './geminiService';

interface TaskAnalysisResult {
    taskType: string;
    focusMode: 'Creative Focus' | 'Balanced Focus' | 'Deep Laser Focus';
    explanation: string;
    suggestedIntensity: FocusIntensity;
    rawReasoning?: string;
    latency?: number;
    source?: 'Cloud (Groq)' | 'Cloud (Gemini)' | 'Local' | 'Recovery';
}

const GROQ_API_KEY = import.meta.env.VITE_GROQ_API_KEY;
const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
const PROXY_ENDPOINT = "/api/analyze";
const GROQ_MODEL = "openai/gpt-oss-20b";
const OLLAMA_ENDPOINT = '/api/ollama/api/generate';
const OLLAMA_MODEL = 'gemma3:4b';

const PROJECT_CONTEXT = "Ytterbium is a productivity tool where Focus Intensity ranges from 1 (Calm) to 10 (Peak). Focus Modes are 'Creative Focus', 'Balanced Focus', and 'Deep Laser Focus'.";

export const ollamaService = {
    analyzeTask: async (taskDescription: string): Promise<TaskAnalysisResult> => {
        const prompt = `${PROJECT_CONTEXT}\n\nTask: "${taskDescription}". Identify the best focus mode and intensity. Return ONLY a raw JSON object with this structure: {"thinking_trace":"Step-by-step analysis of why this mode was chosen","taskType":"Short category (e.g., Coding, Writing)","focusMode":"Creative Focus"|"Balanced Focus"|"Deep Laser Focus","explanation":"One short sentence to showing to the user","suggestedIntensity":3|6|10}`;

        const isProd = import.meta.env.PROD;

        // 1. Try Groq (Via Proxy in Production, Direct in Development)
        try {
            const startTime = performance.now();
            let response;

            if (isProd) {
                console.log(`[AI SERVICE] Connecting to Groq via Proxy...`);
                response = await fetch(PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskDescription })
                });
            } else {
                if (!GROQ_API_KEY) throw new Error("Local Groq API Key missing");
                console.log(`[AI SERVICE] Connecting to Groq Direct...`);
                response = await fetch(GROQ_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: GROQ_MODEL,
                        messages: [
                            { role: "system", content: "You are a task analysis engine. Return raw JSON only." },
                            { role: "user", content: prompt }
                        ],
                        response_format: { type: "json_object" },
                        reasoning_format: "parsed",
                        temperature: 0.1
                    })
                });
            }

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Groq Service Error: ${errorText.substring(0, 100)}`);
            }

            const data = await response.json();
            console.log(`[AI SERVICE] Groq Response Received:`, data);

            // If via proxy, the structure might be different depending on how Vercel returns it
            // Our proxy returns the raw Groq response
            const content = data.choices[0].message.content;
            const result = JSON.parse(content);
            const endTime = performance.now();

            return {
                taskType: result.taskType || "Task",
                focusMode: result.focusMode || "Balanced Focus",
                explanation: result.explanation || "Cognitive calibration complete.",
                suggestedIntensity: (result.suggestedIntensity === 3 ? 3 : result.suggestedIntensity >= 9 ? 10 : 6) as FocusIntensity,
                rawReasoning: result.thinking_trace || "Neural trace synthesized.",
                latency: Math.round(endTime - startTime),
                source: 'Cloud (Groq)'
            };

        } catch (cloudError: any) {
            console.warn(`[AI SERVICE] Groq failed, switching to Gemini Fallback...`, cloudError.message);

            // 2. Try Gemini (Cloud secondary)
            try {
                const geminiStart = performance.now();
                const geminiResult = await analyzeTaskGemini(taskDescription);
                const geminiEnd = performance.now();

                return {
                    ...geminiResult,
                    latency: Math.round(geminiEnd - geminiStart),
                    source: 'Cloud (Gemini)'
                };
            } catch (geminiError: any) {
                console.error(`[AI SERVICE] Gemini fallback failed, trying Local...`, geminiError.message);

                // 3. Try Ollama (Local tertiary)
                try {
                    const localStart = performance.now();
                    const ollamaResponse = await fetch(OLLAMA_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: OLLAMA_MODEL,
                            prompt: prompt,
                            stream: false,
                            format: 'json'
                        }),
                    });

                    if (!ollamaResponse.ok) throw new Error("Local Engine unavailable.");

                    const data = await ollamaResponse.json();
                    const result = JSON.parse(data.response);
                    const localEnd = performance.now();

                    return {
                        taskType: result.taskType || "Task",
                        focusMode: result.focusMode || "Balanced Focus",
                        explanation: result.explanation || "Local analysis complete.",
                        suggestedIntensity: (result.suggestedIntensity >= 9 ? 10 : result.suggestedIntensity) as FocusIntensity,
                        rawReasoning: `[LOCAL] ${result.thinking_trace}`,
                        latency: Math.round(localEnd - localStart),
                        source: 'Local'
                    };
                } catch (localError: any) {
                    // 4. Recovery Protocol (No AI engines available)
                    return {
                        taskType: "Neural Recovery",
                        focusMode: "Balanced Focus",
                        explanation: "Stabilizing cognitive resonance manually.",
                        suggestedIntensity: 6,
                        rawReasoning: `Recovery Protocol: All engines unavailable. Details: ${localError.message}`,
                        source: 'Recovery'
                    };
                }
            }
        }
    }
};
</file>

<file path="services/supabase.ts">
import { createClient } from '@supabase/supabase-js';

// Supabase configuration
// IMPORTANT: Create a .env.local file with your actual Supabase credentials
// See SUPABASE_SETUP.md for instructions
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || 'https://ocgsabgeikikddgutthh.supabase.co';
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || '';

if (!supabaseAnonKey) {
    console.error('VITE_SUPABASE_ANON_KEY is not set. Please create a .env.local file with your Supabase credentials.');
}

// Create Supabase client or fallback
let client;

if (supabaseUrl && supabaseAnonKey) {
    client = createClient(supabaseUrl, supabaseAnonKey, {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storage: window.localStorage,
        },
    });
} else {
    console.warn('Supabase credentials missing. App running in offline/mock mode.');
    // Mock client to prevent crash on load
    client = {
        auth: {
            getUser: async () => ({ data: { user: null }, error: null }),
            onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => { } } } }),
            getSession: async () => ({ data: { session: null }, error: null }),
            signOut: async () => ({ error: null }),
            signInWithOAuth: async (options: any) => {
                console.warn('Supabase Mock: signInWithOAuth called with', options);
                alert('Supabase is in Mock Mode. Google Sign-In is disabled. Please check your .env.local file.');
                return { error: null };
            },
        },
        from: () => ({
            select: () => ({
                eq: () => ({
                    single: async () => ({ data: null, error: null }),
                    maybeSingle: async () => ({ data: null, error: null })
                })
            }),
            update: () => ({ eq: () => ({ select: () => ({ single: async () => ({ data: null, error: null }) }) }) }),
            insert: () => ({ select: () => ({ single: async () => ({ data: null, error: null }) }) }),
        }),
        channel: () => ({ on: () => ({ subscribe: () => { } }) }),
        removeChannel: () => { },
    } as any;
}

export const supabase = client;

// Database types for TypeScript
export interface Database {
    public: {
        Tables: {
            profiles: {
                Row: {
                    id: string;
                    email: string;
                    full_name: string | null;
                    created_at: string;
                    updated_at: string;
                };
                Insert: {
                    id: string;
                    email: string;
                    full_name?: string | null;
                    created_at?: string;
                    updated_at?: string;
                };
                Update: {
                    id?: string;
                    email?: string;
                    full_name?: string | null;
                    updated_at?: string;
                };
            };
            sessions: {
                Row: {
                    id: string;
                    user_id: string | null;
                    start_time: string;
                    end_time: string | null;
                    duration_seconds: number;
                    elapsed_seconds: number;
                    type: 'FOCUS' | 'RELAX';
                    focus_intensity: number;
                    fqs: number;
                    status: 'IDLE' | 'RUNNING' | 'PAUSED' | 'COMPLETED';
                    created_at: string;
                };
                Insert: {
                    id?: string;
                    user_id: string | null;
                    start_time?: string;
                    end_time?: string | null;
                    duration_seconds: number;
                    elapsed_seconds: number;
                    type: 'FOCUS' | 'RELAX';
                    focus_intensity: number;
                    fqs: number;
                    status: 'IDLE' | 'RUNNING' | 'PAUSED' | 'COMPLETED';
                    created_at?: string;
                };
                Update: {
                    end_time?: string | null;
                    elapsed_seconds?: number;
                    fqs?: number;
                    status?: 'IDLE' | 'RUNNING' | 'PAUSED' | 'COMPLETED';
                };
            };
            tasks: {
                Row: {
                    id: string;
                    user_id: string | null;
                    session_id: string | null;
                    title: string;
                    completed: boolean;
                    priority: 'low' | 'medium' | 'high';
                    created_at: string;
                    updated_at: string;
                };
                Insert: {
                    id?: string;
                    user_id: string | null;
                    session_id?: string | null;
                    title: string;
                    completed?: boolean;
                    priority?: 'low' | 'medium' | 'high';
                    created_at?: string;
                    updated_at?: string;
                };
                Update: {
                    title?: string;
                    completed?: boolean;
                    priority?: 'low' | 'medium' | 'high';
                    session_id?: string | null;
                    updated_at?: string;
                };
            };
            fatigue_metrics: {
                Row: {
                    id: string;
                    session_id: string;
                    timestamp: number;
                    keystroke_latency_ms: number;
                    typing_speed_wpm: number;
                    mouse_distance_px: number;
                    mouse_velocity_px_per_sec: number;
                    erratic_mouse_movement: boolean;
                    fatigue_score: number;
                    created_at: string;
                };
                Insert: {
                    id?: string;
                    session_id: string;
                    timestamp: number;
                    keystroke_latency_ms: number;
                    typing_speed_wpm: number;
                    mouse_distance_px: number;
                    mouse_velocity_px_per_sec: number;
                    erratic_mouse_movement: boolean;
                    fatigue_score: number;
                    created_at?: string;
                };
            };
        };
    };
}
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local
.env
.env.bak
*.bak


# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

.vercel
.env*.local
</file>

<file path="components/Sidebar.tsx">
import React from 'react';
import { motion } from 'framer-motion';
import { AppMode } from '../types';

interface SidebarProps {
  currentMode: AppMode;
  setMode: (mode: AppMode) => void;
  alienMode: boolean;
  toggleAlienMode: () => void;
  onSignOut: () => void;
  user: any; // Type from Supabase User
}

export const Sidebar: React.FC<SidebarProps> = ({ currentMode, setMode, alienMode, onSignOut, user }) => {
  const items = [
    { mode: AppMode.FOCUS, label: 'Focus' },
    { mode: AppMode.STATS, label: 'Insights' },
    { mode: AppMode.RELAX, label: 'Relax' },
  ];

  // Animation variants for the whole panel (subtle entrance)
  const panelVariants = {
    hidden: { opacity: 0, x: -50 },
    visible: { opacity: 1, x: 0, transition: { duration: 0.5, ease: 'easeOut', delay: 0.2 } },
  };

  // Base button styles for clean separation
  const baseButtonStyle = `
    relative w-full py-2 px-2 transition-all duration-300
    rounded-full flex items-center justify-center border
  `;

  return (
    <>
      {/* DESKTOP SIDEBAR */}
      <aside className="fixed left-0 top-0 w-72 h-screen hidden md:flex flex-col justify-center z-50 pointer-events-none">

        {/* 1. TITLE SECTION */}
        <div className="px-5 pt-8 pb-4 pointer-events-auto">
          <motion.h1
            className={`
              text-6xl font-bold tracking-tight leading-none transition-all duration-500 
              drop-shadow-lg cursor-default
              ${alienMode
                ? 'font-alien tracking-widest text-cyan-400 shadow-[0_0_15px_rgba(0,255,255,0.6)] hover:text-white'
                : 'text-white hover:text-gray-100'
              }
            `}
            style={!alienMode ? { fontFamily: "'Playfair Display', serif", fontWeight: 700 } : {}}
          >
            Ytterbium
          </motion.h1>
        </div>

        <nav className="flex-grow flex flex-col justify-center items-start w-full pl-10 pointer-events-auto -mt-48">
          <motion.div
            className="w-32 p-3 bg-zinc-900/30 backdrop-blur-2xl border border-white/20 rounded-3xl shadow-2xl flex flex-col gap-3 transition-all duration-500 group/panel"
            variants={panelVariants}
            initial="hidden"
            animate="visible"
          >
            {items.map((item) => {
              const isActive = currentMode === item.mode;
              const activeStyles = `bg-white/10 text-white border-white/30 shadow-[inset_0_0_8px_rgba(255,255,255,0.2),_0_0_10px_rgba(255,255,255,0.1)] hover:bg-white/15`;
              const inactiveStyles = `bg-white/5 text-gray-300 border-white/10 hover:bg-white/10 hover:text-white hover:border-white/30 shadow-inner shadow-black/30`;
              const fontStyles = alienMode
                ? 'font-alien text-[11px] tracking-[0.3em] uppercase font-light'
                : 'text-sm font-medium font-sans';

              return (
                <motion.button
                  key={item.mode}
                  onClick={() => setMode(item.mode)}
                  className={`${baseButtonStyle} ${isActive ? activeStyles : inactiveStyles} ${fontStyles}`}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }}
                >
                  <span className="relative z-10">{item.label}</span>
                </motion.button>
              );
            })}
          </motion.div>
        </nav>

        {/* Sign Out Section */}
        <div className="px-5 pl-10 pb-8 pointer-events-auto flex flex-col items-start gap-4">
          {user && (
            <div className="text-[10px] text-white/40 font-bold tracking-widest uppercase text-center w-full truncate px-2">
              {user.email}
            </div>
          )}
          <motion.button
            onClick={onSignOut}
            className="text-[10px] text-white/60 hover:text-white font-bold tracking-[0.3em] uppercase transition-colors"
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            Sign Out
          </motion.button>
        </div>
      </aside>

      {/* MOBILE BOTTOM NAV */}
      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm h-16 md:hidden z-[100] flex items-center justify-around bg-zinc-900/60 backdrop-blur-2xl border border-white/10 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)] px-2">
        {items.map((item) => {
          const isActive = currentMode === item.mode;
          return (
            <motion.button
              key={item.mode}
              onClick={() => setMode(item.mode)}
              className={`flex flex-col items-center justify-center gap-1 flex-1 py-2 px-1 rounded-xl transition-all ${isActive ? 'text-white' : 'text-gray-500'
                }`}
            >
              <div className={`w-1 h-1 rounded-full mb-1 transition-all ${isActive ? 'bg-white shadow-[0_0_8px_rgba(255,255,255,0.8)]' : 'bg-transparent'}`} />
              <span className={`text-[10px] tracking-widest uppercase ${alienMode ? 'font-alien' : 'font-bold'}`}>
                {item.label}
              </span>
              {isActive && (
                <motion.div
                  layoutId="activeTab"
                  className="absolute inset-x-2 inset-y-2 bg-white/5 border border-white/10 rounded-xl -z-10"
                  transition={{ type: "spring", stiffness: 380, damping: 30 }}
                />
              )}
            </motion.button>
          );
        })}
      </nav>
    </>
  );
};
</file>

<file path="components/TaskList.tsx">
import React, { useState, useRef, useEffect } from 'react';
import { Plus, Circle, CheckCircle2, MoreHorizontal } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { Task } from '../types';
import { useQuantumRipple } from '../hooks/useQuantumRipple';
import { AIAttention } from './AIAttention';

const MotionDiv = motion.div as any;
const MotionLine = motion.line as any;

interface TaskListProps {
  tasks: Task[];
  onToggle: (id: string) => void;
  onAdd: (title: string) => void;
}

export const TaskList: React.FC<TaskListProps> = ({ tasks, onToggle, onAdd }) => {
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [isAdding, setIsAdding] = useState(false);
  const { triggerRipple } = useQuantumRipple();

  // Refs to track task positions for the neural link line
  const containerRef = useRef<HTMLDivElement>(null);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (newTaskTitle.trim()) {
      onAdd(newTaskTitle);
      setNewTaskTitle('');
      setIsAdding(false);
    }
  };

  const handleTaskToggle = (id: string, e: React.MouseEvent) => {
    triggerRipple({ intensity: 'large', x: e.clientX, y: e.clientY, force: true });
    onToggle(id);
  };

  return (
    <div ref={containerRef} className="w-full h-full bg-zinc-900/40 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden shadow-2xl transition-all hover:shadow-[0_0_30px_-5px_rgba(0,0,0,0.5)] relative flex flex-col group/panel">

      {/* Energetic Link Layer - Abstract Neural Line */}
      <svg className="absolute top-0 left-4 w-4 h-full pointer-events-none z-0 opacity-30">
        <defs>
          <linearGradient id="neural-gradient" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor="#6366f1" stopOpacity="0" />
            <stop offset="50%" stopColor="#818cf8" stopOpacity="0.8" />
            <stop offset="100%" stopColor="#6366f1" stopOpacity="0" />
          </linearGradient>
        </defs>
        {/* Draw vertical connector for completed tasks */}
        <MotionLine
          x1="10" y1="40" x2="10" y2="100%"
          stroke="url(#neural-gradient)"
          strokeWidth="0.5"
          strokeDasharray="2 3"
          initial={{ pathLength: 0, opacity: 0 }}
          animate={{
            pathLength: tasks.some(t => t.completed) ? 1 : 0,
            opacity: tasks.some(t => t.completed) ? 0.4 : 0
          }}
          transition={{ duration: 0.5 }}
        />
      </svg>

      <div className="px-3 py-1.5 border-b border-white/[0.03] flex justify-between items-center bg-zinc-900/90 relative z-10 shrink-0">
        <h3 className="text-[11px] font-medium text-gray-400">Contextual Tasks</h3>
        <button onClick={() => setIsAdding(true)} className="text-gray-500 hover:text-white transition-colors">
          <Plus className="w-3.5 h-3.5" />
        </button>
      </div>

      <div className="relative z-10 flex-1 overflow-y-auto custom-scrollbar">
        <AnimatePresence>
          {tasks.map((task, index) => (
            <AIAttention key={task.id}>
              <MotionDiv
                layout
                initial={{ opacity: 0, x: -5 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, height: 0 }}
                className="group flex items-center justify-between px-3 py-2 hover:bg-white/5 transition-all duration-300 cursor-default border-l-2 border-transparent hover:border-white/10"
              >
                <div className="flex items-center gap-3">
                  <button onClick={(e) => handleTaskToggle(task.id, e)} className="text-gray-500 hover:text-indigo-400 transition-colors relative">
                    {/* Energy burst on check */}
                    {task.completed && (
                      <MotionDiv
                        initial={{ scale: 0, opacity: 1 }}
                        animate={{ scale: 1.5, opacity: 0 }}
                        transition={{ duration: 0.4 }}
                        className="absolute inset-0 bg-indigo-500/50 rounded-full blur-sm"
                      />
                    )}
                    {task.completed ? (
                      <CheckCircle2 className="w-3.5 h-3.5 text-indigo-400" />
                    ) : (
                      <Circle className="w-3.5 h-3.5 opacity-50" />
                    )}
                  </button>
                  <span className={`text-[11px] transition-colors ${task.completed ? 'text-gray-500 line-through' : 'text-gray-200 group-hover:text-white'}`}>
                    {task.title}
                  </span>
                </div>
                <button className="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-gray-400 transition-opacity">
                  <MoreHorizontal className="w-3.5 h-3.5" />
                </button>

                {/* Neural Connector to next task if both checked */}
                {task.completed && tasks[index + 1]?.completed && (
                  <MotionDiv
                    layoutId={`link-${index}`}
                    // Updated: Thinner line and subtle glow
                    className="absolute left-[25px] top-6 w-[1px] h-full bg-indigo-500/40 shadow-[0_0_4px_rgba(99,102,241,0.4)] z-0"
                    initial={{ height: 0 }}
                    animate={{ height: '100%' }} // Adjusted to 100% for precise stacking
                    transition={{ duration: 0.3, delay: 0.1 }}
                  />
                )}

              </MotionDiv>
            </AIAttention>
          ))}
        </AnimatePresence>

        {tasks.length === 0 && !isAdding && (
          <div className="px-2 py-4 text-center text-[10px] text-gray-600">
            No active tasks linked.
          </div>
        )}

        {isAdding && (
          <form onSubmit={handleSubmit} className="px-2 py-2">
            <input
              type="text"
              autoFocus
              value={newTaskTitle}
              onChange={(e) => setNewTaskTitle(e.target.value)}
              placeholder="New objective..."
              className="w-full bg-transparent text-[11px] text-gray-300 placeholder-gray-600 focus:outline-none font-sans"
              onBlur={() => !newTaskTitle && setIsAdding(false)}
            />
          </form>
        )}
      </div>
    </div>
  );
};
</file>

<file path="services/authService.ts">
import { supabase } from './supabase';
import type { User, AuthError, Session } from '@supabase/supabase-js';

export interface AuthResponse {
    user: User | null;
    error: AuthError | null;
}

export interface AuthState {
    user: User | null;
    session: Session | null;
    loading: boolean;
}

class AuthService {
    /**
     * Sign up a new user with email and password
     */
    async signUp(email: string, password: string, fullName?: string): Promise<AuthResponse> {
        try {
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: fullName,
                    },
                },
            });

            if (error) {
                return { user: null, error };
            }

            // Create profile entry
            if (data.user) {
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert({
                        id: data.user.id,
                        email: data.user.email!,
                        full_name: fullName || null,
                    });

                if (profileError) {
                    console.error('Profile creation error:', profileError);
                }
            }

            return { user: data.user, error: null };
        } catch (err) {
            return { user: null, error: err as AuthError };
        }
    }

    /**
     * Sign in an existing user
     */
    async signIn(email: string, password: string): Promise<AuthResponse> {
        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                return { user: null, error };
            }

            return { user: data.user, error: null };
        } catch (err) {
            return { user: null, error: err as AuthError };
        }
    }

    /**
     * Sign out the current user
     */
    async signOut(): Promise<{ error: AuthError | null }> {
        try {
            const { error } = await supabase.auth.signOut();
            return { error };
        } catch (err) {
            return { error: err as AuthError };
        }
    }

    /**
     * Get the current authenticated user from local session
     */
    async getUser(): Promise<User | null> {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            return user;
        } catch (err) {
            console.error('Get user error:', err);
            return null;
        }
    }

    /**
     * Get the current session
     */
    async getSession(): Promise<Session | null> {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            return session;
        } catch (err) {
            console.error('Get session error:', err);
            return null;
        }
    }

    /**
     * Listen to auth state changes
     */
    onAuthStateChange(callback: (user: User | null, session: Session | null) => void) {
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            callback(session?.user ?? null, session);
        });

        return subscription;
    }

    /**
     * Send password reset email
     */
    async resetPassword(email: string): Promise<{ error: AuthError | null }> {
        try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: `${window.location.origin}/reset-password`,
            });
            return { error };
        } catch (err) {
            return { error: err as AuthError };
        }
    }

    /**
     * Update user password
     */
    async updatePassword(newPassword: string): Promise<{ error: AuthError | null }> {
        try {
            const { error } = await supabase.auth.updateUser({
                password: newPassword,
            });
            return { error };
        } catch (err) {
            return { error: err as AuthError };
        }
    }

    /**
     * Sign in with Google
     */
    async signInWithGoogle(): Promise<{ error: AuthError | null }> {
        try {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: `${window.location.origin}?authenticated=true`
                }
            });
            return { error };
        } catch (err) {
            return { error: err as AuthError };
        }
    }
}

export const authService = new AuthService();
</file>

<file path="api/checkout.ts">
import { Polar } from "@polar-sh/sdk";

// CTO PRINCIPLE: Use Edge Runtime for maximum performance and lower cold starts.
export const config = {
    runtime: "edge",
};

export default async function handler(req: Request) {
    // CTO PRINCIPLE: Resilience & Logging.
    console.log("[POLAR] Initiating checkout process...");

    const accessToken = process.env.POLAR_ACCESS_TOKEN;
    const successUrl = process.env.POLAR_SUCCESS_URL;

    if (!accessToken || !successUrl) {
        console.error("[POLAR] Error: Missing environment variables (POLAR_ACCESS_TOKEN or POLAR_SUCCESS_URL)");
        return new Response(
            JSON.stringify({
                error: "Server Configuration Error",
                message: "Check Vercel Environment Variables."
            }),
            { status: 500, headers: { "Content-Type": "application/json" } }
        );
    }

    try {
        const url = new URL(req.url);
        const userId = url.searchParams.get("user_id");
        const plan = url.searchParams.get("plan");

        if (!userId) {
            console.warn("[POLAR] Checkout attempted without user_id. Params:", url.search);
            return new Response(
                JSON.stringify({
                    error: "Unauthorized",
                    message: "User identity required.",
                    diagnostics: {
                        url: req.url,
                        params: Array.from(url.searchParams.entries())
                    }
                }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }


        const polar = new Polar({ accessToken });

        // CTO PRINCIPLE: Dynamic Plan Routing.
        // We prioritize specific env vars for each plan type.
        let productId: string | undefined;

        if (plan === "annual") {
            productId = process.env.POLAR_ANNUAL_PRODUCT_ID;
            console.log("[POLAR] Annual plan requested.");
        } else if (plan === "monthly") {
            productId = process.env.POLAR_MONTHLY_PRODUCT_ID;
            console.log("[POLAR] Monthly plan requested.");
        }

        // Fallback to generic product ID if specific one is missing or no plan specified
        if (!productId) {
            productId = process.env.POLAR_PRODUCT_ID;
        }

        if (!productId) {
            console.log("[POLAR] No explicit product ID found, attempting auto-discovery via organization...");
            const organizationId = process.env.POLAR_ORGANIZATION_ID;

            if (!organizationId) {
                return new Response(
                    JSON.stringify({
                        error: "Configuration Missing",
                        message: "Plan not set and no discovery ID provided. Please set POLAR_ANNUAL_PRODUCT_ID or POLAR_MONTHLY_PRODUCT_ID."
                    }),
                    { status: 500, headers: { "Content-Type": "application/json" } }
                );
            }

            const products = await polar.products.list({
                organizationId: organizationId
            });

            // If we have an organization but no specific product, we'll pick based on price if possible,
            // or just the first one if we can't distinguish.
            if (products.result.items.length > 0) {
                // CTO Tip: Search for the product name that matches the plan
                const found = products.result.items.find(p =>
                    p.name.toLowerCase().includes(plan || '') ||
                    p.name.toLowerCase().includes(plan === 'annual' ? 'year' : 'month')
                );
                productId = found ? found.id : products.result.items[0].id;
                console.log(`[POLAR] Found product via discovery: ${productId}`);
            }
        }

        if (!productId) {
            return new Response(
                JSON.stringify({
                    error: "Product Not Found",
                    message: `Could not determine Polar product for plan: ${plan}. Please check your environment variables.`
                }),
                { status: 404, headers: { "Content-Type": "application/json" } }
            );
        }


        const checkout = await polar.checkouts.create({
            products: [productId],
            successUrl: successUrl,
            customerMetadata: {
                supabase_user_id: userId,
                plan_type: plan || "unknown"
            },
        });



        console.log(`[POLAR] Checkout created successfully for user ${userId}: ${checkout.url}`);

        return Response.redirect(checkout.url, 303);
    } catch (error: any) {
        console.error("[POLAR] Runtime Exception:", error);
        return new Response(
            JSON.stringify({
                error: "Internal Server Error",
                message: error.message,
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
            }),
            { status: 500, headers: { "Content-Type": "application/json" } }
        );
    }
}
</file>

<file path="components/GoldVault.tsx">
import React from 'react';
import { motion } from 'framer-motion';
import { Database, Coins, Pickaxe, Layers } from 'lucide-react';

interface GoldVaultProps {
    progress: number; // 0-100 representing current bar mining progress
    barsToday: number;
    totalBars: number;
}

export const GoldVault: React.FC<GoldVaultProps> = ({ progress = 0, barsToday = 0, totalBars = 0 }) => {
    return (
        <div className="w-full h-full bg-zinc-900/40 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden shadow-2xl transition-all hover:shadow-[0_0_30px_-5px_rgba(0,0,0,0.5)] relative flex flex-col group/panel">

            {/* Header */}
            <div className="px-3 py-1.5 border-b border-white/[0.03] flex justify-between items-center bg-zinc-900/90 relative z-10 shrink-0">
                <div className="flex items-center gap-2">
                    <Pickaxe className="w-3.5 h-3.5 text-[#D4AF37]" />
                    <h3 className="text-[11px] font-medium text-gray-400">Gold Vault</h3>
                </div>
                <div className="flex items-center gap-1.5 px-2 py-0.5 rounded-md text-[#D4AF37] bg-white/[0.02] border border-white/[0.05] shadow-sm">
                    <span className="text-[9px] font-bold tracking-widest uppercase">
                        {progress >= 100 ? '● COMPLETE' : '● EXTRACTING'}
                    </span>
                </div>
            </div>

            {/* Content */}
            <div className="relative z-10 flex-1 overflow-y-auto custom-scrollbar">
                {/* Progress Section */}
                <div className="px-3 py-1.5 hover:bg-white/5 transition-all">
                    <div className="flex items-center justify-between mb-1">
                        <span className="text-[10px] text-gray-400 uppercase tracking-tighter">Batch Progress</span>
                        <span className="text-[10px] font-medium text-[#D4AF37]">{Math.round(progress)}%</span>
                    </div>
                    <div className="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                        <motion.div
                            initial={{ width: 0 }}
                            animate={{ width: `${progress}%` }}
                            transition={{ duration: 0.5, ease: "easeOut" }}
                            className="h-full"
                            style={{
                                background: 'linear-gradient(90deg, #8B735B 0%, #D4AF37 100%)'
                            }}
                        />
                    </div>
                </div>

                {/* Today's Yield */}
                <div className="px-3 py-1.5 hover:bg-white/5 transition-all">
                    <div className="flex items-center justify-between mb-1">
                        <div className="flex items-center gap-2">
                            <Layers className="w-3.5 h-3.5 text-gray-500" />
                            <span className="text-[10px] text-gray-400 uppercase tracking-tighter">Today's Yield</span>
                        </div>
                        <span className="text-[10px] font-bold text-white tabular-nums tracking-widest">{barsToday} Bars</span>
                    </div>
                    {barsToday > 0 ? (
                        <div className="flex h-1 items-center gap-0.5 overflow-hidden rounded bg-white/[0.02]">
                            {Array.from({ length: Math.min(8, barsToday) }).map((_, i) => (
                                <motion.div
                                    key={i}
                                    initial={{ opacity: 0, scaleX: 0 }}
                                    animate={{ opacity: 1, scaleX: 1 }}
                                    transition={{ delay: i * 0.05, duration: 0.3 }}
                                    className="h-full flex-1 rounded-[1px]"
                                    style={{
                                        background: 'linear-gradient(180deg, #D4AF37 0%, #8B735B 100%)'
                                    }}
                                />
                            ))}
                            {barsToday > 8 && (
                                <span className="ml-1 text-[9px] text-[#D4AF37]">+{barsToday - 8}</span>
                            )}
                        </div>
                    ) : (
                        <div className="h-1 w-full rounded bg-white/[0.02]" />
                    )}
                </div>

                {/* Total Reserve */}
                <div className="px-2 py-0.5 hover:bg-white/5 transition-all">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Coins className="w-3 h-3 text-gray-500" />
                            <span className="text-[11px] text-gray-400">Total Reserve</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex gap-0.5">
                                {Array.from({ length: 4 }).map((_, i) => (
                                    <div
                                        key={i}
                                        className={`h-1 w-1 rounded-full ${totalBars > i * 10 ? 'bg-[#D4AF37] shadow-[0_0_4px_#D4AF37]' : 'bg-white/10'}`}
                                    />
                                ))}
                            </div>
                            <span className="text-[11px] font-medium text-gray-200">{totalBars}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};
</file>

<file path="package.json">
{
  "name": "ytterbium",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.31.0",
    "@polar-sh/nextjs": "^0.9.3",
    "@polar-sh/sdk": "^0.42.1",
    "@supabase/supabase-js": "^2.89.0",
    "framer-motion": "^11.0.8",
    "lenis": "^1.3.17",
    "lucide-react": "^0.555.0",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "recharts": "^3.5.1"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ytterbium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&family=Inter+Tight:wght@500;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&family=Playfair+Display:wght@600;700&family=PT+Serif:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="96326f8b-572e-4ad4-920e-379ecac70b77"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              tight: ['Inter Tight', 'Inter', 'sans-serif'],
              serif: ['EB Garamond', 'serif'],
              instrument: ['"Instrument Serif"', 'serif'],
              logo: ['EB Garamond', 'serif'],
              mono: ['JetBrains Mono', 'monospace'],
              alien: ['"Share Tech Mono"', 'monospace'],
            },
            colors: {
              // Intelligent Sky Palette
              'pale-blue': '#e8f1f7',
              'soft-sky': '#b8d4e8',
              'clear-blue': '#7aa8c9',
              'deep-intelligence': '#2d5f8f',
              'warm-white': '#faf8f5',
              'cloud-cream': '#f5f0eb',
              'vesper-clay': '#e8dad3',
              'warm-stone': '#d4c4b8',
              'text-primary': '#1a2332',
              'text-secondary': '#4a5568',
              'text-tertiary': '#7a8599',
            },
            animation: {
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 20s ease-in-out infinite',
              'float-delayed': 'float 20s ease-in-out 10s infinite',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translate(0, 0) scale(1)' },
                '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              }
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #09090b;
        color: #ffffff;
        font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        -webkit-font-smoothing: antialiased;
        /* FIX: Removing overflow: hidden to allow fixed SVG arrows to render */
      }
      /* Custom scrollbar for webkit */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
      }
    </style>


</head>
  <body>
    <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
</file>

<file path="components/LandingPage.tsx">
import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ollamaService } from '../services/ollamaService';
import { supabase } from '../services/supabase';
import { databaseService } from '../services/databaseService';
import type { User } from '@supabase/supabase-js';
import { Header } from './Header';
import { PricingModal } from './PricingModal';
import { authService } from '../services/authService';
import { useSubscription } from '../hooks/useSubscription';

interface LandingPageProps {
    onEnter: (data: any) => void;
}

const LandingPage: React.FC<LandingPageProps> = ({ onEnter }) => {
    const [stage, setStage] = useState<'hero' | 'analyzing' | 'result'>('hero');
    const [task, setTask] = useState('');
    const [analysisResult, setAnalysisResult] = useState<any>(null);
    const [showAuthModal, setShowAuthModal] = useState(false);
    const [showPricingModal, setShowPricingModal] = useState(false);
    const [currentUser, setCurrentUser] = useState<User | null>(null);
    const [freeSessionsUsed, setFreeSessionsUsed] = useState(0);
    const { isPremium } = useSubscription(); // Use existing hook
    // const isPremium = false;
    const chatInputRef = useRef<HTMLInputElement>(null);

    // Check for existing user & usage stats
    useEffect(() => {
        const checkUser = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            setCurrentUser(user);

            if (user) {
                const profile = await databaseService.getProfile(user.id);
                if (profile) {
                    setFreeSessionsUsed((profile as any).free_sessions_used || 0);
                }
            }
        };
        checkUser();
    }, []);

    const scrollToInput = () => {
        chatInputRef.current?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => chatInputRef.current?.focus(), 600);
    };

    const handleGetStarted = () => {
        scrollToInput();
    };

    const handleLogin = async () => {
        console.log("[LandingPage] Initiating Google login...");
        const { error } = await authService.signInWithGoogle();
        if (error) console.error('[LandingPage] Login error:', error);
    };

    const handleTaskSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!task.trim()) return;

        setStage('analyzing');

        try {
            const aiResult = await ollamaService.analyzeTask(task);
            setAnalysisResult({
                intensity: aiResult.suggestedIntensity,
                insight: aiResult.explanation,
                type: aiResult.taskType,
                focusMode: aiResult.focusMode,
                suggestedSessions: Math.ceil(aiResult.suggestedIntensity / 3.33),
            });
            setStage('result');
        } catch (error) {
            console.error('AI analysis failed:', error);
            setAnalysisResult({
                intensity: 6,
                insight: 'Balanced focus recommended for this task.',
                type: 'Standard Task',
                focusMode: 'Balanced Focus',
                suggestedSessions: 2,
            });
            setStage('result');
        }
    };

    const handleStartSession = async () => {
        // 1. Check Limits (The Wall)
        if (currentUser && !isPremium && freeSessionsUsed >= 3) {
            setShowPricingModal(true);
            return;
        }

        if (currentUser) {
            // User is logged in, proceed to app
            onEnter({
                task,
                intensity: analysisResult.intensity,
                insight: analysisResult.insight,
                focusMode: analysisResult.focusMode,
                user: currentUser,
            });
        } else {
            // Save session data to localStorage for restoration after auth
            localStorage.setItem('pending_session', JSON.stringify({
                task,
                intensity: analysisResult.intensity,
                insight: analysisResult.insight,
                focusMode: analysisResult.focusMode,
            }));

            // Show auth modal (task will be restored after successful login)
            setShowAuthModal(true);
        }
    };

    const handleGoogleSignUp = async () => {
        try {
            console.log("[LandingPage] Engaging authService.signInWithGoogle...");
            const { error } = await authService.signInWithGoogle();

            if (error) {
                console.error('[LandingPage] OAuth Error:', error);
                alert(`Authentication stalled: ${error.message}\n\nPlease verify your Supabase keys in .env.local.`);
            }
        } catch (err: any) {
            console.error('[LandingPage] Critical Auth Failure:', err);
            alert(`Critical System Error: ${err.message || 'Unknown failure'}`);
        }
    };

    return (
        <div className="min-h-screen bg-black text-white relative overflow-hidden">
            {/* Background Elements */}
            <div className="fixed inset-0 bg-[#09090b]" />

            {/* Header */}
            <Header
                onGetStartedClick={handleGetStarted}
                onLoginClick={handleLogin}
                isDashboard={stage !== 'hero'}
            />

            {/* Main Content */}
            <div className="relative z-10 min-h-screen flex items-center justify-center px-6 pt-12">
                <AnimatePresence mode="wait">
                    {/* Hero Section - Centered Input */}
                    <AnimatePresence>
                        {stage === 'hero' && (
                            <motion.div
                                initial={{ opacity: 0, scale: 1.02, filter: 'blur(8px)' }}
                                animate={{ opacity: 1, scale: 1, filter: 'blur(0px)' }}
                                exit={{ opacity: 0, scale: 0.98, filter: 'blur(8px)' }}
                                transition={{ duration: 0.4, ease: [0.22, 1, 0.36, 1] }}
                                className="relative z-10 w-full max-w-3xl px-6"
                            >
                                {/* Headline */}
                                <motion.div
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    transition={{ delay: 0.2 }}
                                    className="text-center mb-10"
                                >
                                    <h1 className="flex flex-col gap-3">
                                        <span className="text-3xl md:text-5xl font-black text-zinc-50 tracking-tight uppercase font-sans">
                                            A neural and physical guard.
                                        </span>
                                        <span className="block text-base md:text-lg text-zinc-400 max-w-xl mx-auto leading-relaxed font-light tracking-[0.02em] font-sans opacity-90">
                                            For your eyes, posture, and cognitive health. Detect burnout and calibrate your biology to work smarter.
                                        </span>
                                    </h1>
                                </motion.div>

                                {/* Input Container */}
                                <div className="relative group">
                                    <div className="relative bg-[#18181b] border border-zinc-800 rounded-2xl md:rounded-[36px] overflow-hidden shadow-2xl">
                                        <form
                                            onSubmit={(e) => {
                                                e.preventDefault();
                                                handleTaskSubmit(e);
                                            }}
                                            className="flex flex-col"
                                        >
                                            <textarea
                                                ref={chatInputRef}
                                                value={task}
                                                onChange={(e) => setTask(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter' && !e.shiftKey) {
                                                        e.preventDefault();
                                                        handleTaskSubmit(e);
                                                    }
                                                }}
                                                placeholder="Ask Ytterbium to analyze a task..."
                                                className="w-full bg-transparent text-white placeholder-zinc-500 text-sm md:text-base px-6 pt-4 pb-14 focus:outline-none resize-none min-h-[80px] leading-relaxed"
                                                style={{ caretColor: '#818cf8' }}
                                                autoFocus
                                            />

                                            {/* Input Footer / Actions */}
                                            <div className="absolute bottom-3 right-3 flex items-center justify-end">

                                                {/* Submit Button */}
                                                <button
                                                    type="submit"
                                                    disabled={!task.trim()}
                                                    className={`p-1.5 rounded-full transition-all duration-300 ${task.trim()
                                                        ? 'bg-zinc-50 text-zinc-950 translate-x-0 opacity-100 shadow-[0_0_20px_rgba(250,250,250,0.1)]'
                                                        : 'bg-zinc-900/50 text-zinc-600 translate-x-0 opacity-50 cursor-not-allowed border border-zinc-800'
                                                        }`}
                                                >
                                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                {/* Suggestion Chips (Secondary Button Style) */}
                                <div className="mt-8 flex flex-wrap items-center justify-center gap-3">
                                    {['Deep Work Session', 'Study for Exam', 'Debug Code'].map((suggestion, i) => (
                                        <motion.button
                                            key={suggestion}
                                            initial={{ opacity: 0, y: 10 }}
                                            animate={{ opacity: 1, y: 0 }}
                                            transition={{ delay: 0.4 + (i * 0.1) }}
                                            onClick={() => setTask(suggestion)}
                                            className="px-4 py-2 rounded-full border border-zinc-800 bg-zinc-900/50 hover:bg-zinc-800 text-xs md:text-sm text-zinc-400 hover:text-zinc-50 transition-all duration-200"
                                        >
                                            {suggestion}
                                        </motion.button>
                                    ))}
                                </div>

                            </motion.div>
                        )}

                        {stage === 'analyzing' && (
                            <AnalyzingState key="analyzing" />
                        )}

                        {stage === 'result' && analysisResult && (
                            <ResultView
                                key="result"
                                task={task}
                                result={analysisResult}
                                onStartSession={handleStartSession}
                                showLock={currentUser ? (!isPremium && freeSessionsUsed >= 3) : false}
                            />
                        )}
                    </AnimatePresence>
                </AnimatePresence>
            </div>

            {/* Auth Modal */}
            <AnimatePresence>
                {showAuthModal && (
                    <AuthModal onClose={() => setShowAuthModal(false)} onSignUp={handleGoogleSignUp} />
                )}
            </AnimatePresence>

            {/* Pricing Modal */}
            <PricingModal isOpen={showPricingModal} onClose={() => setShowPricingModal(false)} />
        </div >
    );
};

// Analyzing State with Skeleton Loader
const AnalyzingState: React.FC = () => {
    const [messageIndex, setMessageIndex] = useState(0);
    const messages = [
        'Analyzing cognitive load...',
        'Calibrating task intensity...',
        'Optimizing session flow...',
    ];

    useEffect(() => {
        const interval = setInterval(() => {
            setMessageIndex((prev) => (prev + 1) % messages.length);
        }, 1200);
        return () => clearInterval(interval);
    }, []);

    return (
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className="w-full max-w-6xl h-[80vh] flex flex-col md:flex-row gap-0 overflow-hidden rounded-sm border border-zinc-800 bg-[#09090b] shadow-2xl"
        >
            {/* Left Sidebar - Chat Style (30%) */}
            <div className="w-full md:w-[35%] flex flex-col border-r border-zinc-900 relative bg-[#0d0d0e]">
                {/* Chat History Area */}
                <div className="flex-1 p-6 space-y-8">
                    {/* User Message Skeleton */}
                    <div className="flex flex-col items-end space-y-2">
                        <div className="bg-zinc-800/30 px-4 py-3 rounded-sm w-3/4 border border-zinc-700/30">
                            <div className="h-4 bg-zinc-700/50 rounded-sm w-full animate-pulse" />
                        </div>
                    </div>

                    {/* AI Message Skeleton */}
                    <div className="flex flex-col items-start space-y-2">
                        <div className="flex items-center gap-2 mb-1">
                            <div className="w-5 h-5 flex items-center justify-center text-indigo-500">
                                <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                                    <circle cx="14" cy="14" r="12" stroke="currentColor" strokeWidth="1.5" opacity="0.6" />
                                    <circle cx="14" cy="14" r="6" fill="currentColor" opacity="0.9" />
                                    <circle cx="14" cy="14" r="3" fill="currentColor" />
                                </svg>
                            </div>
                            <span className="text-[10px] text-zinc-500 uppercase tracking-widest">Thinking...</span>
                        </div>
                        <div className="space-y-3 w-full">
                            <div className="h-4 bg-zinc-800/50 rounded-md w-[80%] animate-pulse" />
                            <div className="h-4 bg-zinc-800/50 rounded-md w-[60%] animate-pulse" />
                            <div className="pt-2 flex items-center gap-2">
                                <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce" style={{ animationDelay: '0ms' }} />
                                <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce" style={{ animationDelay: '200ms' }} />
                                <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce" style={{ animationDelay: '400ms' }} />
                            </div>
                        </div>
                    </div>
                </div>

                <div className="p-4 border-t border-zinc-800 bg-[#0d0d0e]">
                    <div className="bg-zinc-900/50 border border-zinc-800/50 rounded-none px-4 py-3 opacity-30 select-none">
                        <span className="text-zinc-600 text-sm">Ask Ytterbium...</span>
                    </div>
                </div>
            </div>

            {/* Right Main Content (65%) - Stacked Card Skeleton */}
            <div className="flex-1 flex flex-col items-center justify-center p-12 pb-24 relative bg-[#09090b]">
                {/* Status Pill */}
                <div className="absolute top-8 flex items-center gap-2 px-4 py-1.5 rounded-full bg-zinc-900 border border-zinc-800 shadow-sm">
                    <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse shadow-[0_0_8px_rgba(99,102,241,0.8)]" />
                    <span className="text-[11px] font-medium text-zinc-400 uppercase tracking-widest">{messages[messageIndex]}</span>
                </div>

                {/* Stacked Card Skeleton Effect */}
                <div className="relative w-full max-w-[340px] aspect-[4/5] flex flex-col items-center justify-center opacity-50">
                    <div className="absolute top-[-10px] w-[95%] aspect-[4/5] bg-zinc-900/40 border border-zinc-800/50 rounded-sm -z-10" />
                    <div className="w-full h-full rounded-sm border border-zinc-800 bg-[#121214] flex flex-col overflow-hidden">
                        <div className="flex-1 bg-[#0a0a0b] flex items-center justify-center relative overflow-hidden">
                            {/* Technical Grid Overlay */}
                            <div className="absolute inset-0 opacity-[0.05]" style={{ backgroundImage: 'linear-gradient(zinc-800 1px, transparent 1px), linear-gradient(90deg, zinc-800 1px, transparent 1px)', backgroundSize: '20px 20px' }} />
                            <div className="w-16 h-16 rounded-full bg-zinc-900/50 border border-zinc-800 flex items-center justify-center animate-pulse z-10">
                                <div className="w-8 h-8 rounded-full border-2 border-indigo-500/20 border-t-indigo-500 animate-spin" />
                            </div>
                        </div>
                        <div className="p-8 space-y-4">
                            <div className="h-4 bg-zinc-800/50 rounded-sm w-3/4 animate-pulse" />
                            <div className="h-4 bg-zinc-800/50 rounded-sm w-1/2 animate-pulse" />
                            <div className="pt-4 h-12 bg-zinc-800/30 rounded-sm w-full animate-pulse" />
                        </div>
                    </div>
                </div>
            </div>
        </motion.div>
    );
};

// Result View Component
interface ResultViewProps {
    task: string;
    result: any;
    onStartSession: () => void;
    showLock?: boolean;
}

const ResultView: React.FC<ResultViewProps> = ({ task, result, onStartSession, showLock }) => {
    return (
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className="w-full max-w-6xl md:h-[80vh] flex flex-col md:flex-row gap-0 overflow-hidden md:rounded-sm border-0 md:border border-zinc-800 bg-[#09090b] shadow-2xl"
        >
            {/* Left Sidebar - Chat Style (30%) */}
            <div className="w-full md:w-[35%] flex flex-col border-b md:border-b-0 md:border-r border-zinc-900 relative bg-[#0d0d0e] max-h-[35vh] md:max-h-none">
                {/* Chat History Area */}
                <div className="flex-1 p-4 md:p-6 overflow-y-auto space-y-6 md:space-y-8">
                    {/* User Message */}
                    <div className="flex flex-col items-end space-y-2">
                        <div className="bg-zinc-800/50 px-4 py-3 rounded-sm max-w-[90%] border border-zinc-700/50">
                            <p className="text-zinc-200 text-sm leading-relaxed font-sans">{task}</p>
                        </div>
                        <span className="text-[10px] text-zinc-600 uppercase tracking-[0.2em] font-bold px-1 font-sans">You</span>
                    </div>

                    {/* AI Message */}
                    <div className="flex flex-col items-start space-y-2">
                        <div className="flex items-center gap-2 mb-1">
                            <div className="w-5 h-5 flex items-center justify-center text-indigo-500">
                                <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                                    <circle cx="14" cy="14" r="12" stroke="currentColor" strokeWidth="1.5" opacity="0.6" />
                                    <circle cx="14" cy="14" r="6" fill="currentColor" opacity="0.9" />
                                    <circle cx="14" cy="14" r="3" fill="currentColor" />
                                </svg>
                            </div>
                            <span className="text-[10px] text-zinc-500 uppercase tracking-[0.2em] font-bold font-sans">Ytterbium</span>
                        </div>
                        <div className="space-y-4 max-w-[95%]">
                            <p className="text-zinc-400 text-sm leading-relaxed font-light font-sans">
                                I've analyzed your focus request. Based on the cognitive load required for <span className="text-zinc-200 font-medium">"{task}"</span>, I've calibrated a specialized environment.
                            </p>
                            <p className="text-zinc-400 text-sm leading-relaxed font-light font-sans">
                                <span className="text-zinc-200 font-medium">{result.focusMode}</span> mode is best suited for this. {result.insight.replace(/^"|"$/g, '')}
                            </p>
                        </div>
                    </div>
                </div>

                <div className="p-4 border-t border-zinc-800 bg-[#0d0d0e]">
                    <div className="relative group">
                        <div className="bg-zinc-900 border border-zinc-800 rounded-none px-4 py-3 flex items-center justify-between opacity-50 cursor-not-allowed">
                            <span className="text-zinc-500 text-sm font-sans font-light tracking-wide">Ask Ytterbium...</span>
                            <div className="flex items-center gap-2">
                                <div className="p-1 rounded-lg bg-zinc-800 text-zinc-600">
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                </div>
                                <div className="p-1 rounded-lg bg-zinc-700 text-zinc-900">
                                    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Right Main Content (65%) - Stacked Card Design */}
            <div className="flex-1 flex flex-col items-center justify-center p-6 md:p-12 pb-20 md:pb-24 relative bg-[#09090b] overflow-y-auto">


                {/* Stacked Card Effect */}
                <div className="relative w-full max-w-[300px] md:max-w-[340px] aspect-[4/5] flex flex-col items-center justify-center my-8 md:my-0">
                    {/* Backward Layers */}
                    <div className="absolute top-[-10px] w-[95%] aspect-[4/5] bg-zinc-900/40 border border-zinc-800/50 rounded-sm -z-10" />
                    <div className="absolute top-[-20px] w-[90%] aspect-[4/5] bg-zinc-900/20 border border-zinc-800/30 rounded-sm -z-20" />

                    {/* Main Card */}
                    <motion.div
                        initial={{ scale: 0.95, y: 20 }}
                        animate={{ scale: 1, y: 0 }}
                        className="w-full h-full rounded-sm border border-zinc-800 bg-[#121214] overflow-hidden shadow-2xl flex flex-col"
                    >
                        {/* Card Upper: Placeholder/Visual Area */}
                        <div className="flex-1 bg-[#0a0a0b] relative group overflow-hidden">
                            {/* Technical Grid Overlay */}
                            <div className="absolute inset-0 opacity-[0.05]" style={{ backgroundImage: 'linear-gradient(zinc-800 1px, transparent 1px), linear-gradient(90deg, zinc-800 1px, transparent 1px)', backgroundSize: '15px 15px' }} />
                            <div className="absolute inset-0 bg-gradient-to-b from-transparent to-[#121214]/80" />
                            {/* Focus Mode Icon/Graphics Overlay */}
                            <div className="absolute inset-0 flex flex-col items-center justify-center space-y-6">
                                <div className="w-20 h-20 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center group-hover:scale-110 transition-transform duration-500 shadow-inner">
                                    {showLock ? (
                                        <svg className="w-8 h-8 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                    ) : (
                                        <svg className="w-8 h-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    )}
                                </div>
                                <div className="text-center px-8">
                                    <div className="text-[10px] text-zinc-500 uppercase tracking-[0.3em] mb-1 font-bold font-sans">Recommended State</div>
                                    <div className="text-3xl font-black text-white tracking-tight font-sans">{result.focusMode}</div>
                                </div>
                            </div>
                        </div>

                        <div className="p-8 bg-[#121214] space-y-6">
                            <div className="space-y-4">
                                <div className="space-y-1">
                                    <h3 className="text-lg font-bold text-zinc-100 tracking-tight font-sans">Ytterbium Environment</h3>
                                    <p className="text-sm text-zinc-500 leading-relaxed font-light font-sans">
                                        Calibrated for {result.intensity}/10 intensity across {result.suggestedSessions} scheduled sprints.
                                    </p>
                                </div>
                                {/* Intensity Progress Bar */}
                                <div className="w-full h-[1px] bg-zinc-800 rounded-full overflow-hidden">
                                    <motion.div
                                        initial={{ width: 0 }}
                                        animate={{ width: `${result.intensity * 10}%` }}
                                        transition={{ duration: 1, delay: 0.5, ease: "easeOut" }}
                                        className="h-full bg-indigo-500/40"
                                    />
                                </div>
                            </div>

                            {/* Action Button */}
                            <motion.button
                                whileHover={{ scale: 1.02 }}
                                whileTap={{ scale: 0.98 }}
                                onClick={onStartSession}
                                className={`w-full py-4 rounded-sm font-black text-[11px] uppercase tracking-[0.2em] font-sans shadow-lg transition-all duration-300 ${showLock
                                    ? 'bg-zinc-900 text-zinc-600 cursor-not-allowed border border-zinc-800'
                                    : 'bg-zinc-50 text-zinc-950 hover:bg-white hover:shadow-[0_0_20px_rgba(99,102,241,0.3)] border border-zinc-800'
                                    }`}
                            >
                                {showLock ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                        Limit Reached
                                    </span>
                                ) : "Initiate Environment"}
                            </motion.button>
                        </div>
                    </motion.div>
                </div>
            </div>
        </motion.div>
    );
};

// Auth Modal Component
interface AuthModalProps {
    onClose: () => void;
    onSignUp: () => void;
}

const AuthModal: React.FC<AuthModalProps> = ({ onClose, onSignUp }) => {
    return (
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 z-[500] flex items-center justify-center p-6 bg-black/80 backdrop-blur-md"
        >
            <motion.div
                initial={{ y: 20, opacity: 0 }}
                animate={{ y: 0, opacity: 1 }}
                exit={{ y: 20, opacity: 0 }}
                onClick={(e) => e.stopPropagation()}
                className="max-w-[400px] w-full p-6 md:p-10 rounded-sm bg-[#09090b] border border-zinc-800 relative shadow-2xl"
            >
                {/* Close Button hit-box (44x44px) */}
                <button
                    onClick={onClose}
                    className="absolute top-2 right-2 w-11 h-11 flex items-center justify-center text-zinc-500 hover:text-white transition-colors group"
                >
                    <svg className="w-5 h-5 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div className="space-y-8">
                    {/* Top Left Logo Identity */}
                    <div className="flex justify-start">
                        <div className="w-10 h-10 flex items-center justify-center text-indigo-500">
                            <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
                                <circle cx="14" cy="14" r="12" stroke="currentColor" strokeWidth="1.5" opacity="0.6" />
                                <circle cx="14" cy="14" r="6" fill="currentColor" opacity="0.9" />
                                <circle cx="14" cy="14" r="3" fill="currentColor" />
                            </svg>
                        </div>
                    </div>

                    <div className="space-y-1">
                        <h3 className="text-xl md:text-[28px] font-bold text-zinc-50 tracking-tight leading-none uppercase">Start Building.</h3>
                        <p className="text-xl md:text-[28px] font-bold text-zinc-800 leading-none uppercase">Create free account</p>
                    </div>

                    <div className="pt-4 space-y-4">
                        {/* Google Sign In Button - Hybrid Style */}
                        <button
                            type="button"
                            onClick={() => {
                                console.log("[AuthModal] Primary Action: Continue with Google");
                                onSignUp();
                            }}
                            className="w-full h-[52px] px-4 rounded-sm bg-zinc-50 text-zinc-950 font-black text-[11px] uppercase tracking-[0.2em] flex items-center justify-center gap-3 hover:bg-white transition-all relative z-50 group shadow-[0_0_20px_rgba(255,255,255,0.05)] cursor-pointer"
                        >
                            <svg className="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                            </svg>
                            Continue with Google

                            {/* Muted Indigo Badge Style */}
                            <div className="absolute -top-2 -right-2 px-2 py-0.5 bg-indigo-500/10 border border-indigo-500/20 rounded-sm shadow-sm backdrop-blur-sm pointer-events-none">
                                <span className="text-[9px] font-bold text-indigo-400 uppercase tracking-wider">Last used</span>
                            </div>
                        </button>
                    </div>

                    <div className="space-y-4 pt-4">
                        <p className="text-[10px] text-zinc-500 leading-relaxed font-medium uppercase tracking-widest">
                            By continuing, you agree to the <a href="#" className="text-zinc-400 hover:text-zinc-200 transition-colors underline underline-offset-4 decoration-zinc-800">Terms of Service</a> and <a href="#" className="text-zinc-400 hover:text-zinc-200 transition-colors underline underline-offset-4 decoration-zinc-800">Privacy Policy</a>.
                        </p>
                        <div className="pt-2 border-t border-zinc-900">
                            <p className="text-[9px] text-zinc-600 uppercase tracking-[0.2em]">Standard security protocols active</p>
                        </div>
                    </div>
                </div>
            </motion.div>
        </motion.div>
    );
};

export default LandingPage;
</file>

<file path="components/FocusTimer.tsx">
import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { Play, Pause, Square, Clock, Zap, Activity, Gauge, Target, Sparkles } from 'lucide-react';
import { SessionStatus } from '../types';

interface FocusTimerProps {
  status: SessionStatus;
  elapsedSeconds: number;
  durationSeconds: number;
  fatigueScore: number;
  currentIntensity: number; // Added prop
  onStart: () => void;
  onPause: () => void;
  onReset: () => void;
  onIntensityChange: (intensity: number) => void;
  currentInsight?: string; // Prop kept for compatibility with App.tsx
}

// ----------------------------------------------------------------------------------
// [NEW LOGIC] Function to map the 1-10 numerical scale to clear conceptual labels
// ----------------------------------------------------------------------------------
const getIntensityLabel = (intensity: number): { label: string, color: string } => {
  if (intensity <= 3) {
    return { label: 'Creative Focus', color: 'text-purple-400' }; // Low sensitivity
  }
  if (intensity <= 7) {
    return { label: 'Balanced Focus', color: 'text-cyan-400' }; // Medium sensitivity
  }
  return { label: 'Deep Laser Focus', color: 'text-red-400' }; // High sensitivity
};

export const FocusTimer: React.FC<FocusTimerProps> = ({
  status,
  elapsedSeconds,
  durationSeconds,
  fatigueScore,
  currentIntensity,
  onStart,
  onPause,
  onReset,
  onIntensityChange,
  currentInsight,
}) => {
  const [sliderValue, setSliderValue] = useState(currentIntensity);

  // Sync sliderValue when currentIntensity changes from parent (e.g., AI classification)
  React.useEffect(() => {
    console.log("[FocusTimer] Syncing intensity from prop:", currentIntensity);
    setSliderValue(currentIntensity);
  }, [currentIntensity]);

  // Get the current label based on the slider value
  const { label: intensityLabel, color: intensityColor } = getIntensityLabel(sliderValue);

  const handleSliderChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = parseInt(e.target.value);
    setSliderValue(val);
    // Call the intensity handler to update App.tsx and its hidden duration mapping
    onIntensityChange(val);
  };

  // [FIX] Progress Bar now uses the dynamic duration from App.tsx 
  // This ensures the bar hits 100% exactly when the hidden cap (e.g., 40 mins) is reached.
  const progressPercent = durationSeconds > 0
    ? Math.min(100, (elapsedSeconds / durationSeconds) * 100)
    : 0;

  // Timer Display Logic (Counting Up)
  const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
  const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');

  // [UPDATED] Check if session is finished via AI Intervention
  const isFinished = elapsedSeconds >= durationSeconds && durationSeconds > 0;

  // Status configuration - Simplified
  let StatusIcon = Clock;
  let statusColor = "text-gray-400";
  let statusText = "IDLE";

  if (status === SessionStatus.RUNNING) {
    if (fatigueScore > 70) {
      StatusIcon = Activity;
      statusColor = "text-red-400";
      statusText = "OVERLOAD";
    } else if (fatigueScore > 40) {
      StatusIcon = Gauge;
      statusColor = "text-amber-400";
      statusText = "ACTIVE";
    } else {
      StatusIcon = Zap;
      statusColor = "text-emerald-400";
      statusText = "FLOW";
    }
  } else if (status === SessionStatus.PAUSED) {
    // [UPDATED] If paused because we hit the peak, show "PEAK REACHED"
    if (isFinished) {
      StatusIcon = Sparkles;
      statusColor = "text-amber-400";
      statusText = "PEAK REACHED";
    } else {
      StatusIcon = Clock;
      statusColor = "text-blue-400";
      statusText = "PAUSED";
    }
  }

  const actionButtonClasses = `
    flex items-center justify-center
    text-gray-500 hover:text-primary transition-all duration-200
    p-1.5 rounded-md
    shadow-[0_1px_0px_rgba(255,255,255,0.05)] hover:shadow-[0_2px_4px_rgba(0,0,0,0.3)]
    bg-white/[0.02] hover:bg-white/[0.06]
    border border-white/[0.02] hover:border-white/[0.1]
    backdrop-blur-sm
  `;

  const resetButtonStyle = `
    text-gray-600 hover:text-red-400 transition-all duration-200
    p-1.5 rounded-md
    shadow-[0_1px_0px_rgba(255,255,255,0.05)] hover:shadow-[0_2px_4px_rgba(220,38,38,0.2)]
    bg-white/[0.02] hover:bg-white/[0.06]
    border border-white/[0.02] hover:border-red-400/[0.2]
    backdrop-blur-sm
  `;

  // APPLE SPECTRAL GLOW LOGIC
  const isRunning = status === SessionStatus.RUNNING;

  return (
    // Updated: Added max-w-[240px] and mx-auto to tighten width
    <div className={`
      w-full max-w-[240px] mx-auto h-full
      bg-gradient-to-br from-zinc-900/40 via-zinc-900/30 to-zinc-950/40
      backdrop-blur-xl
      rounded-2xl
      shadow-[0_0_0_1px_rgba(255,255,255,0.02),0_8px_32px_rgba(0,0,0,0.32),0_16px_60px_rgba(0,0,0,0.28)]
      hover:shadow-[0_0_0_1px_rgba(255,255,255,0.03),0_8px_40px_rgba(0,0,0,0.36),0_20px_80px_rgba(0,0,0,0.32)]
      relative flex flex-col
      transition-all duration-700 ease-in-out

      /* Standard border (reverts to this when not running) */
      border ${(!isRunning && !isFinished) ? 'border-white/[0.08]' : 'border-transparent'}

      /* [UPDATED] Spectral Edge Glow Pseudo-element */
      /* Adds a VERY subtle pulsing Emerald glow when the session is running */
      ${isRunning ? `
        before:content-['']
        before:absolute before:inset-0 before:rounded-2xl 
        before:p-[0.5px] 
        before:bg-gradient-to-tr 
        before:from-emerald-400/20 before:via-white/5 before:to-emerald-400/20
        before:mask-[linear-gradient(#fff_0_0)_content-box,linear-gradient(#fff_0_0)]
        before:mask-composite-exclude
        before:pointer-events-none
        before:z-20
        before:animate-pulse
        shadow-[0_0_20px_rgba(52,211,153,0.08)]
      ` : isFinished ? `
        before:content-['']
        before:absolute before:inset-0 before:rounded-2xl 
        before:p-[1px] 
        before:bg-gradient-to-tr 
        before:from-amber-400/40 before:via-white/20 before:to-amber-400/40
        before:mask-[linear-gradient(#fff_0_0)_content-box,linear-gradient(#fff_0_0)]
        before:mask-composite-exclude
        before:pointer-events-none
        before:z-20
        before:animate-pulse
        shadow-[0_0_30px_rgba(251,191,36,0.15)]
      ` : `
        before:absolute before:inset-0 before:rounded-2xl before:bg-gradient-to-b before:from-white/[0.04] before:to-transparent before:pointer-events-none
      `}

      after:absolute after:inset-0 after:rounded-2xl after:bg-gradient-to-br after:from-transparent after:via-transparent after:to-white/[0.01] after:pointer-events-none
    `}>

      {/* Header: Title bar aesthetic */}
      <div className="
        px-2.5 py-1.5 
        border-b border-white/[0.08] 
        flex justify-between items-center 
        bg-gradient-to-r from-white/[0.03] to-white/[0.01]
        relative z-10 shrink-0
        backdrop-blur-sm
        after:absolute after:inset-0 after:rounded-t-2xl after:bg-gradient-to-b after:from-white/[0.04] after:to-transparent after:pointer-events-none
      ">
        <h3 className="text-[10px] font-medium text-gray-400 tracking-tight">AI Timer</h3>

        {/* Status badge */}
        <div className={`
          flex items-center gap-1 px-1.5 py-0.5 rounded-lg
          ${statusColor}
          bg-white/[0.04]
          border border-white/[0.1]
          shadow-[0_2px_8px_rgba(0,0,0,0.15),0_1px_2px_rgba(255,255,255,0.05)_inset]
          backdrop-blur-sm
          relative
          before:absolute before:inset-0 before:rounded-lg before:bg-gradient-to-b before:from-white/[0.08] before:to-transparent before:pointer-events-none
        `}>
          <StatusIcon className="w-2 h-2 relative z-10" />
          <span className="text-[8px] font-medium tracking-tighter relative z-10">{statusText}</span>
        </div>
      </div>

      {/* Main Content Area - Updated p-4 to p-3 for width reduction */}
      <div className="p-3 space-y-4 flex-1 flex flex-col relative z-10">

        {/* Timer Display */}
        <div className="flex flex-col items-center justify-center">
          <div className={`
            text-2xl font-mono font-medium tracking-tighter tabular-nums
            drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]
            ${isFinished ? 'text-amber-400' : 'text-white'}
          `}>
            {minutes}:{seconds}
          </div>

          {/* Progress indicator - Invisible Target Logic */}
          <div className="w-full max-w-[100px] flex items-center gap-2 mt-1">
            <div className="
              flex-1 h-0.5 
              bg-white/[0.05] 
              rounded-full overflow-hidden
              shadow-[0_1px_2px_rgba(0,0,0,0.2)_inset]
              border border-white/[0.05]
            ">
              <motion.div
                className={`
                  h-full 
                  ${isFinished
                    ? 'bg-gradient-to-r from-amber-500 via-white to-amber-500'
                    : isRunning
                      ? 'bg-gradient-to-r from-emerald-500/60 via-emerald-400/40 to-emerald-500/60'
                      : 'bg-gradient-to-r from-indigo-500/80 via-blue-400/80 to-cyan-400/80'
                  }
                  shadow-[0_0_6px_rgba(16,185,129,0.2),0_1px_1px_rgba(255,255,255,0.1)_inset]
                  relative
                  before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/[0.1] before:to-transparent before:opacity-30
                `}
                initial={{ width: "0%" }}
                animate={{ width: `${progressPercent}%` }}
                transition={{ duration: 0.5, ease: "linear" }}
              />
            </div>
            <div className={`text-[8px] font-mono tabular-nums w-5 text-right ${isFinished ? 'text-amber-400' : isRunning ? 'text-emerald-400' : 'text-gray-500'}`}>
              {Math.round(progressPercent)}%
            </div>
          </div>
        </div>

        {/* Configuration/Status Area */}
        <div className="space-y-3">
          {status === SessionStatus.IDLE ? (
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5">
                  <Target className="w-2.5 h-2.5 text-gray-500 drop-shadow-[0_1px_2px_rgba(0,0,0,0.3)]" />
                  <span className={`text-[8px] uppercase tracking-tighter ${intensityColor} font-medium drop-shadow-[0_1px_2px_rgba(0,0,0,0.3)]`}>
                    {intensityLabel}
                  </span>
                </div>
                <div className="text-[9px] text-gray-400 font-mono">{sliderValue}/10</div>
              </div>

              {/* Slider */}
              <div className="flex items-center gap-2">
                <div className="flex-1 relative">
                  <div className="
                    absolute inset-0 
                    bg-gradient-to-r from-purple-500/40 via-cyan-500/40 to-red-500/40 
                    rounded-full pointer-events-none
                  "></div>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={sliderValue}
                    onChange={handleSliderChange}
                    className="
                      relative
                      w-full h-0.5 
                      bg-transparent 
                      rounded-full 
                      appearance-none 
                      [&::-webkit-slider-thumb]:appearance-none 
                      [&::-webkit-slider-thumb]:h-2.5 
                      [&::-webkit-slider-thumb]:w-2.5 
                      [&::-webkit-slider-thumb]:rounded-full 
                      [&::-webkit-slider-thumb]:bg-gradient-to-br 
                      [&::-webkit-slider-thumb]:from-white 
                      [&::-webkit-slider-thumb]:to-gray-200
                      [&::-webkit-slider-thumb]:border 
                      [&::-webkit-slider-thumb]:border-white/[0.3]
                      [&::-webkit-slider-thumb]:shadow-[0_2px_8px_rgba(0,0,0,0.3),0_1px_2px_rgba(255,255,255,0.8)_inset]
                      [&::-webkit-slider-thumb]:cursor-pointer
                      [&::-webkit-slider-thumb]:transition-all
                      [&::-webkit-slider-thumb]:duration-200
                      [&::-webkit-slider-thumb]:hover:scale-110
                      [&::-webkit-slider-thumb]:hover:shadow-[0_4px_12px_rgba(99,102,241,0.4),0_1px_2px_rgba(255,255,255,0.8)_inset]
                      [&::-webkit-slider-thumb]:-translate-y-[calc((0.625rem-0.125rem)/2)]
                      [&::-webkit-slider-track]:appearance-none
                      [&::-webkit-slider-track]:bg-gradient-to-r
                      [&::-webkit-slider-track]:from-purple-500/70
                      [&::-webkit-slider-track]:via-cyan-500/70
                      [&::-webkit-slider-track]:to-red-500/70
                      [&::-webkit-slider-track]:rounded-full
                      [&::-webkit-slider-track]:h-0.5
                      cursor-pointer
                    "
                  />
                </div>
              </div>
            </div>
          ) : (
            <div className="space-y-1.5">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5">
                  <Activity className="w-2.5 h-2.5 text-gray-500 drop-shadow-[0_1px_2px_rgba(0,0,0,0.3)]" />
                  <span className="text-[8px] text-gray-400 uppercase tracking-tighter">COGNITIVE LOAD</span>
                </div>
                <div className="text-[9px] text-white font-mono">{fatigueScore}/100</div>
              </div>

              {/* Cognitive Load Bar */}
              <div className="
                w-full h-1 
                bg-white/[0.05] 
                rounded-full 
                overflow-hidden
                shadow-[0_1px_2px_rgba(0,0,0,0.2)_inset]
                border border-white/[0.05]
              ">
                <motion.div
                  className="
                    h-full 
                    bg-gradient-to-r from-emerald-500 via-amber-500 to-red-500
                    shadow-[0_0_12px_rgba(34,197,94,0.15),0_1px_2px_rgba(255,255,255,0.1)_inset]
                    relative
                    before:absolute before:inset-0 before:bg-gradient-to-r before:from-transparent before:via-white/[0.2] before:to-transparent before:opacity-50
                  "
                  initial={{ width: "0%" }}
                  animate={{ width: `${fatigueScore}%` }}
                  transition={{ duration: 0.5 }}
                />
              </div>
            </div>
          )}
        </div>

        {/* Grouped Controls (Action Buttons and Footer) */}
        <div className="mt-auto shrink-0 space-y-2">

          {/* Action Buttons */}
          <div className="pt-2 border-t border-white/[0.08]">
            <div className="flex items-center justify-center gap-2">
              {status === SessionStatus.RUNNING ? (
                <>
                  <button
                    onClick={onPause}
                    className={actionButtonClasses}
                    title="Pause Session"
                  >
                    <Pause className="w-2.5 h-2.5" />
                  </button>
                  <button
                    onClick={onReset}
                    className={resetButtonStyle}
                    title="Reset Session"
                  >
                    <Square className="w-2.5 h-2.5" />
                  </button>
                </>
              ) : (
                <button
                  onClick={onStart}
                  className="
                    flex items-center justify-center gap-1.5
                    flex-1 text-[9px] py-1.5
                    border border-gray-300/[0.15]
                    rounded-xl
                    text-gray-300 hover:text-white
                    bg-gradient-to-b from-white/[0.07] to-white/[0.03]
                    hover:bg-gradient-to-b hover:from-white/[0.12] hover:to-white/[0.05]
                    hover:border-gray-300/[0.25]
                    transition-all duration-200
                    font-medium tracking-tighter
                    shadow-[0_4px_12px_rgba(0,0,0,0.2),0_1px_2px_rgba(255,255,255,0.05)_inset]
                    hover:shadow-[0_8px_24px_rgba(0,0,0,0.3),0_2px_4px_rgba(255,255,255,0.1)_inset]
                    backdrop-blur-sm
                    relative
                    before:absolute before:inset-0 before:rounded-xl before:bg-gradient-to-b before:from-white/[0.1] before:to-transparent before:opacity-0 hover:before:opacity-100 before:transition-opacity before:duration-200
                    active:scale-[0.98]
                  "
                >
                  <Play className="w-2.5 h-2.5 relative z-10" />
                  <span className="relative z-10">{isFinished ? 'RESTART' : 'START'}</span>
                </button>
              )}
            </div>
          </div>

          {/* Footer */}
          <div className="pt-2 border-t border-white/[0.08]">
            <div className="flex items-center justify-between">
              <div className="text-[8px] text-gray-500 tracking-tighter">
                {status === SessionStatus.IDLE ? 'Ready' :
                  status === SessionStatus.RUNNING ? 'Optimizing...' :
                    isFinished ? 'Finished' : 'Paused'}
              </div>

              {/* Status indicators */}
              <div className="flex items-center gap-0.5">
                {Array.from({ length: 4 }).map((_, i) => (
                  <div
                    key={i}
                    className={`
                      w-0.5 h-1 rounded-sm 
                      transition-all duration-300
                      ${(status === SessionStatus.RUNNING || isFinished) && fatigueScore > (i * 25)
                        ? 'bg-gradient-to-b from-emerald-500 to-amber-500 shadow-[0_0_4px_rgba(34,197,94,0.3)]'
                        : 'bg-white/[0.05]'
                      }
                    `}
                  />
                ))}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};
</file>

<file path="components/ImmersiveJourney.tsx">
import React, { useState, useEffect } from 'react';

import { motion, AnimatePresence } from 'framer-motion';
import { supabase } from '../services/supabase';
import { User } from '@supabase/supabase-js';
import { useSubscription } from '../hooks/useSubscription';


interface ImmersiveJourneyProps {
    onComplete: () => void;
    onAuthRequired: () => void;
    currentUser: User | null;
}

export const ImmersiveJourney: React.FC<ImmersiveJourneyProps> = ({ onComplete, onAuthRequired, currentUser }) => {


    const [step, setStep] = useState(0);

    useEffect(() => {
        document.body.style.overflow = 'hidden';
        return () => { document.body.style.overflow = 'unset'; };
    }, []);

    const nextStep = () => setStep((prev) => prev + 1);

    const protocols = [
        { label: "SOLUTION 1", name: "Non-Invasive Vagus Nerve Stimulation Protocol", type: "NEURAL", color: "hover:bg-[#00FFFF] hover:text-black" },
        { label: "SOLUTION 2", name: "Deep Tissue Decalcification & Spinal Reset", type: "PHYSICAL", color: "hover:bg-[#FF00FF] hover:text-black" },
        { label: "SOLUTION 3", name: "Retinal Frequency Calibration & Blue Light Rejection", type: "OCULAR", color: "hover:bg-[#CCFF00] hover:text-black" },
        { label: "SOLUTION 4", name: "Dopamine Receptor Resensitization Framework", type: "COGNITIVE", color: "hover:bg-[#FF3300] hover:text-white" },
        { label: "SOLUTION 5", name: "Neural Plasticity Enhancement through Ultradian Rhythms", type: "SYSTEMS", color: "hover:bg-[#7000FF] hover:text-white" },
        { label: "SOLUTION 6", name: "Circadian Thermal Regulation & Sleep Architecture", type: "BIOLOGIC", color: "hover:bg-[#00FF66] hover:text-black" },
        { label: "SOLUTION 7", name: "Cortisol Management via Bio-Feedback AI Integration", type: "HORMONAL", color: "hover:bg-[#FF9900] hover:text-black" },
    ];

    const benefits = [
        { title: "Income Increase", category: "FINANCIAL", subCategory: "optimization", desc: "Monetary growth" },
        { title: "Stress Decrease", category: "NEURAL", subCategory: "CORTISOL", desc: "Stress suppression" },
        { title: "Sleep Better", category: "BIOLOGIC", subCategory: "REM CYCLE", desc: "Deep restoration" },
        { title: "Better Posture", category: "PHYSICAL", subCategory: "SPINAL", desc: "Alignment reset" },
        { title: "Healthy Eyes", category: "OCULAR", subCategory: "RETINAL", desc: "Vision clarity" },
        { title: "Work Smarter", category: "SYSTEMIC", subCategory: "EFFICIENCY", desc: "Weeks into hours" },
        { title: "Neural Silence", category: "COGNITIVE", subCategory: "ZENITH", desc: "Zero brain fog" },
        { title: "Age Reverse", category: "CELLULAR", subCategory: "TELOMERE", desc: "Biological youth" },
    ];

    return (
        <div className={`relative w-full h-screen ${step === 7 ? 'bg-white' : 'bg-[#F9F7F2]'} text-[#1a1a1a] overflow-hidden selection:bg-[#2F4F4F] font-sans transition-colors duration-1000`}>
            {/* Grain Overlay */}
            <div className={`fixed inset-0 pointer-events-none z-50 mix-blend-multiply transition-opacity duration-1000 ${step === 7 ? 'opacity-0' : 'opacity-[0.05]'}`}
                style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E")` }}
            />

            <AnimatePresence mode="wait">
                {/* Steps 0-5 remain identical */}
                {step === 0 && (
                    <motion.section key="s0" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0, scale: 1.05 }} transition={{ duration: 1.2 }} className="absolute inset-0 flex items-center justify-center p-6 text-center">
                        <h1 className="font-instrument text-[8rem] md:text-[13rem] lg:text-[16rem] tracking-[-0.06em] leading-[0.75]">
                            You are losing <br /> your sight.
                        </h1>
                    </motion.section>
                )}

                {step === 1 && (
                    <motion.section key="s1" initial={{ opacity: 0, y: 30 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -30 }} transition={{ duration: 1.2 }} className="absolute inset-0 flex items-center justify-center p-6 text-center">
                        <div className="max-w-6xl">
                            <h2 className="font-instrument text-[4rem] md:text-[7rem] lg:text-[9rem] tracking-[-0.04em] leading-[0.85] mb-12">
                                Your posture is broken. <br /> Your hormones are dead.
                            </h2>
                            <h3 className="font-instrument text-4xl md:text-6xl text-[#8a8a8a] tracking-tight">
                                Your brain is no longer yours.
                            </h3>
                        </div>
                    </motion.section>
                )}

                {step === 2 && (
                    <motion.section key="s2" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 1.2 }} className="absolute inset-0 flex items-center justify-center p-6">
                        <div className="flex items-center gap-8 md:gap-16">
                            <div className="border-2 border-black rounded-[40px] px-10 py-16 md:px-16 md:py-24 text-center">
                                <h2 className="font-instrument text-5xl md:text-7xl font-bold leading-tight">
                                    You sleep <br /> 8 hours
                                </h2>
                            </div>
                            <span className="font-instrument text-6xl md:text-8xl font-light">+</span>
                            <div className="border-2 border-black rounded-[40px] px-10 py-16 md:px-16 md:py-24 text-center">
                                <h2 className="font-instrument text-5xl md:text-7xl font-bold leading-tight">
                                    You work <br /> 12 hours
                                </h2>
                            </div>
                        </div>
                    </motion.section>
                )}

                {step === 3 && (
                    <motion.section key="s3" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} transition={{ duration: 1.2 }} className="absolute inset-0 flex items-center justify-center p-6 text-center">
                        <div className="max-w-6xl">
                            <p className="font-instrument text-[2rem] md:text-[3.2rem] text-[#8a8a8a] tracking-tight italic font-light mb-4">
                                If you live to 70, you only spend
                            </p>
                            <p className="font-instrument text-[2.2rem] md:text-[3.8rem] tracking-tight">
                                <span className="text-[#1a1a1a] font-medium">14 years</span> <span className="text-[#8a8a8a] italic font-light">actually awake for yourself.</span>
                            </p>
                        </div>
                    </motion.section>
                )}

                {step === 4 && (
                    <motion.section key="s4" initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }} transition={{ duration: 1.5 }} className="absolute inset-0 flex items-center justify-center p-6 text-center">
                        <div className="max-w-4xl">
                            <span className="block font-mono text-sm tracking-[0.5em] text-[#8a8a8a] mb-8 uppercase">The Protocol</span>
                            <h1 className="font-instrument text-7xl md:text-[10rem] tracking-[-0.04em] leading-[0.9]">
                                Ytterbium is <br /> the solution.
                            </h1>
                        </div>
                    </motion.section>
                )}

                {step === 5 && (
                    <motion.section key="s5" initial={{ opacity: 0, y: 40 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -40 }} transition={{ duration: 1 }} className="absolute inset-0 flex items-center justify-center p-6 md:p-12 overflow-hidden">
                        <div className="w-full max-w-[1300px] h-[85vh] flex flex-col">
                            <div className="grid grid-cols-12 py-3 border-b border-black font-mono text-[11px] tracking-widest text-black/60 uppercase">
                                <div className="col-span-2">/ SOLUTIONS WE OFFER</div>
                                <div className="col-span-8 px-4">/ PROTOCOL NAME</div>
                                <div className="col-span-2 text-right">/ CLASSIFICATION</div>
                            </div>
                            <div className="flex-1 overflow-y-auto pr-4 custom-scrollbar">
                                {protocols.map((row, i) => (
                                    <div key={i} className={`grid grid - cols - 12 py - 7 border - b border - black items - center group transition - all duration - 300 cursor - crosshair ${row.color} `}>
                                        <div className="col-span-2 font-mono text-sm tracking-tighter pl-2 flex items-center gap-2">
                                            <span className="text-[8px]">■</span> {row.label}
                                        </div>
                                        <div className="col-span-8 px-4 font-instrument text-3xl md:text-5xl tracking-tight leading-none transition-transform duration-300 group-hover:translate-x-2 font-medium uppercase">
                                            {row.name}
                                        </div>
                                        <div className="col-span-2 text-right pr-2 flex justify-end items-center gap-8">
                                            <span className="font-mono text-[11px] border border-current px-3 py-1 bg-transparent transition-colors uppercase rounded-sm">
                                                {row.type}
                                            </span>
                                            <span className="text-xl font-light opacity-30 group-hover:opacity-100">+</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </motion.section>
                )}

                {/* Step 6 remains with 8 benefits and no grid */}
                {step === 6 && (
                    <motion.section key="s6" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 1 }} className="absolute inset-0 flex flex-col items-center justify-center p-6">
                        <div className="relative z-10 w-full max-w-6xl">
                            <motion.h2
                                initial={{ opacity: 0, y: -10 }}
                                animate={{ opacity: 1, y: 0 }}
                                className="font-instrument text-2xl md:text-3xl italic text-[#8a8a8a] mb-16 text-center font-light tracking-tight"
                            >
                                In simple language
                            </motion.h2>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-x-12 gap-y-16 w-full">
                                {benefits.map((b, i) => (
                                    <motion.div
                                        key={i}
                                        initial={{ opacity: 0, y: 10 }}
                                        animate={{ opacity: 1, y: 0 }}
                                        transition={{ delay: i * 0.1 }}
                                        className="flex flex-col text-left group cursor-default"
                                    >
                                        <h3 className="font-instrument text-3xl md:text-4xl font-bold tracking-tighter leading-none mb-1">
                                            {b.title}
                                        </h3>
                                        <div className="flex flex-col font-mono text-[11px] tracking-widest uppercase opacity-40 group-hover:opacity-100 transition-opacity">
                                            <span>{b.category}</span>
                                            <span className="mt-[-2px]">{b.subCategory}</span>
                                            <span className="mt-1 normal-case tracking-normal font-sans italic opacity-80">{b.desc}</span>
                                        </div>
                                    </motion.div>
                                ))}
                            </div>
                        </div>
                    </motion.section>
                )}

                {/* STEP 7 - CLEAN PRICING ONLY */}
                {step === 7 && <PricingStep onComplete={onComplete} onAuthRequired={onAuthRequired} currentUser={currentUser} />}



            </AnimatePresence>

            {step < 7 && (
                <div className="fixed bottom-12 left-1/2 -translate-x-1/2 z-[60]">
                    <motion.button onClick={nextStep} className="w-12 h-12 rounded-full bg-[#1a1a1a] text-[#F9F7F2] flex items-center justify-center hover:scale-110 active:scale-90 transition-all">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M12 5v14M19 12l-7 7-7-7" /></svg>
                    </motion.button>
                </div>
            )}
        </div>
    );
};

const PricingStep: React.FC<{ onComplete: () => void; onAuthRequired: () => void; currentUser: User | null }> = ({ onComplete, onAuthRequired, currentUser }) => {
    const { isPremium, loading } = useSubscription();
    const [selectedPlan, setSelectedPlan] = useState<'monthly' | 'annual' | null>(null);
    const [showError, setShowError] = useState(false);

    useEffect(() => {
        // If we have a user and they selected a plan previously (persisted), we might want to trigger checkout
        // But this is likely handled in App.tsx or we handle it here if they are still on this screen
        if (currentUser && selectedPlan) {
            const checkoutUrl = `/api/checkout?user_id=${encodeURIComponent(currentUser.id)}&plan=${selectedPlan}`;
            window.location.href = checkoutUrl;
        }
    }, [currentUser, selectedPlan]);

    const handlePlanSelect = (plan: 'monthly' | 'annual') => {
        console.log("Saving plan to localStorage:", plan);
        setSelectedPlan(plan);
        setShowError(false);
        localStorage.setItem('pending_plan', plan);

        // If already logged in, go to checkout immediately
        if (currentUser) {
            console.log("User already logged in, redirecting to checkout");
            const checkoutUrl = `/api/checkout?user_id=${encodeURIComponent(currentUser.id)}&plan=${plan}`;
            window.location.href = checkoutUrl;
        }
    };

    const handleGoogleSignUp = async () => {
        if (!selectedPlan) {
            setShowError(true);
            // Shake effect or toast could go here
            return;
        }

        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
        if (error) console.error("Google Auth Error:", error);
    };

    const handleLogin = async () => {
        // Login doesn't necessarily require a plan selection, but if they are here, maybe they want to sync?
        // Prompt says "new user... choose plan... sign up". 
        // Returning paid user shouldn't be here (Immersive Journey is skipped).
        // Returning free user might be here.
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
        if (error) console.error("Google Auth Error:", error);
    };

    if (loading) return <div className="flex items-center justify-center h-full font-mono text-black">CALIBRATING...</div>;

    if (isPremium) {
        return (
            <motion.section initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center bg-white text-black">
                <h3 className="font-instrument text-6xl mb-8">Access Granted.</h3>
                <p className="font-instrument text-xl text-[#8a8a8a] mb-12">Your profile is already synced with the Ytterbium protocol.</p>
                <button onClick={onComplete} className="px-12 py-4 bg-black text-white rounded-full font-mono text-sm tracking-widest uppercase hover:scale-105 transition-transform">
                    Enter System
                </button>
            </motion.section>
        );
    }

    return (
        <motion.section
            key="s7"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className="absolute inset-0 flex flex-col md:flex-row bg-white text-black overflow-hidden"
        >
            {/* Left Side: Pricing */}
            <div className="flex-1 flex flex-col justify-center items-center p-12 lg:p-24 border-b md:border-b-0 md:border-r border-black/5 bg-[#FDFDFD]">
                <div className="w-full max-w-md space-y-12">
                    <div className="space-y-4">
                        <span className="font-mono text-[10px] tracking-[0.4em] text-black/40 uppercase">Economic selection</span>
                        <h3 className="font-instrument text-5xl md:text-6xl font-medium tracking-tight">Choose your <br /> resonance.</h3>
                    </div>

                    <div className="space-y-6">
                        {/* Annual Plan */}
                        <button
                            onClick={() => handlePlanSelect('annual')}
                            className={`w-full p-8 border ${selectedPlan === 'annual' ? 'border-black bg-black text-white' : 'border-black/10 hover:bg-black hover:text-white'} rounded-[32px] flex flex-col gap-1 group transition-all duration-500 text-left relative overflow-hidden`}
                        >
                            <span className={`font-mono text-[10px] tracking-[0.3em] uppercase ${selectedPlan === 'annual' ? 'opacity-60' : 'opacity-40 group-hover:opacity-60'}`}>Elite / Annual</span>
                            <div className="flex items-baseline justify-between">
                                <span className="font-instrument text-4xl font-bold">$12</span>
                                <span className={`font-mono text-[11px] ${selectedPlan === 'annual' ? 'opacity-60' : 'opacity-40 group-hover:opacity-60'} italic`}>/ 12 MONTHS</span>
                            </div>
                            <div className={`mt-4 flex items-center gap-2 font-mono text-[10px] tracking-widest ${selectedPlan === 'annual' ? 'opacity-100' : 'opacity-40 group-hover:opacity-100'} transition-opacity`}>
                                <span>■ SECURE PROTOCOL</span>
                            </div>
                        </button>

                        {/* Monthly Plan */}
                        <button
                            onClick={() => handlePlanSelect('monthly')}
                            className={`w-full p-8 border ${selectedPlan === 'monthly' ? 'border-black bg-black text-white' : 'border-black/10 hover:bg-black hover:text-white'} rounded-[32px] flex flex-col gap-1 group transition-all duration-500 text-left`}
                        >
                            <span className={`font-mono text-[10px] tracking-[0.3em] uppercase ${selectedPlan === 'monthly' ? 'opacity-60' : 'opacity-40 group-hover:opacity-60'}`}>Base / Monthly</span>
                            <div className="flex items-baseline justify-between">
                                <span className="font-instrument text-4xl font-bold">$5</span>
                                <span className={`font-mono text-[11px] ${selectedPlan === 'monthly' ? 'opacity-60' : 'opacity-40 group-hover:opacity-60'} italic`}>/ MONTHLY</span>
                            </div>
                            <div className={`mt-4 flex items-center gap-2 font-mono text-[10px] tracking-widest ${selectedPlan === 'monthly' ? 'opacity-100' : 'opacity-40 group-hover:opacity-100'} transition-opacity`}>
                                <span>□ STANDARD GAIN</span>
                            </div>
                        </button>
                    </div>

                    <p className={`font-instrument text-sm ${showError ? 'text-red-500' : 'text-[#8a8a8a]'} italic transition-colors duration-300`}>
                        {showError ? "Choose the plan first." : "Select a plan to synchronize your neural architecture."}
                    </p>
                </div>
            </div>

            {/* Right Side: Auth (Matching Screenshot) */}
            <div className="flex-1 flex flex-col justify-center items-center p-12 lg:p-24 bg-white">
                <div className="w-full max-w-[360px] flex flex-col items-center text-center">
                    <h2 className="font-instrument text-5xl font-medium tracking-tight mb-2">Ytterbium</h2>
                    <p className="font-instrument text-lg text-[#8a8a8a] mb-16 italic">Automate your health.</p>

                    <div className="w-full space-y-4">
                        {/* Google Sign Up */}
                        <button
                            onClick={handleGoogleSignUp}
                            className="w-full h-[58px] bg-black text-white rounded-full flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12.545,11.071L12,11.071L12,12.929L15.636,12.929C15.111,15.111 13.555,16.555 12,16.555C9.485,16.555 7.445,14.515 7.445,12C7.445,9.485 9.485,7.445 12,7.445C13.2,7.445 14.155,7.889 14.777,8.555L16.222,7.111C15.155,6.111 13.666,5.555 12,5.555C8.445,5.555 8.445,8.445 12,12C5.555,15.555 8.445,18.445 12,18.445C16.889,18.445 20,15.111 20,12C20,11.111 19.889,10.222 19.666,9.445L12,9.445L12,11.071L12.545,11.071Z" />
                            </svg>
                            <span className="font-bold text-[15px]">Sign up</span>
                        </button>

                        <div className="flex items-center py-2">
                            <div className="flex-1 h-[1px] bg-black/5" />
                            <span className="px-4 font-mono text-[10px] text-black/40">or</span>
                            <div className="flex-1 h-[1px] bg-black/5" />
                        </div>

                        {/* Log In */}
                        <button
                            onClick={handleLogin}
                            className="w-full h-[58px] border border-black/10 text-black rounded-full flex items-center justify-center font-bold text-[15px] hover:bg-black/5 hover:border-black transition-all duration-300"
                        >
                            Log in
                        </button>
                    </div>

                    {/* Legal Footer */}
                    <div className="mt-12 text-[10px] text-black/40 leading-relaxed font-sans">
                        By signing up you agree to our<br />
                        <button className="underline hover:text-black">Privacy Policy</button> and <button className="underline hover:text-black">Terms of Service</button>.
                    </div>

                    <div className="mt-auto pt-24">
                        <p className="font-instrument text-sm text-black/40 italic">
                            by <span className="underline cursor-pointer hover:text-black transition-colors">The General Intelligence Company</span>
                        </p>
                    </div>
                </div>
            </div>
        </motion.section>
    );
};
</file>

<file path="App.tsx">
// App.tsx - WITH SUPABASE INTEGRATION
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Sidebar } from './components/Sidebar';
import { FocusTimer } from './components/FocusTimer';
import { RelaxTimer } from './components/RelaxTimer';
import { StatsView } from './components/StatsView';
import { TaskList } from './components/TaskList';
import { Background } from './components/Background';
import { GoldVault } from './components/GoldVault';
import { AppMode, SessionStatus, Task, FatigueMetrics } from './types';
import { fatigueService } from './services/fatigueService';
import { CosmicParticles } from './components/CosmicParticles';
import { QuantumRippleBackground } from './components/QuantumRippleBackground';
import { AIWhisper } from './components/AIWhisper';
import LandingPage from './components/LandingPage';
import { AIOptimizedIndicator } from './components/AIOptimizedIndicator';
import { authService } from './services/authService';
import { databaseService } from './services/databaseService';
import { AuthModal } from './components/AuthModal';
import { CountdownNotification } from './components/CountdownNotification';
import type { User } from '@supabase/supabase-js';
import { useSubscription } from './hooks/useSubscription';

const DEFAULT_DURATION = 25 * 60; // 25 min default
const SCALE_FACTOR = 1.05; // Restored to original scale as per request
const GHOST_SESSION_KEY = 'ytterbium_ghost_session_id';

const MotionDiv = motion.div as any;

// ----------------------------------------------------------------------------------
// Define dynamic fatigue thresholds based on Intensity (1-10)
const INTENSITY_THRESHOLDS: Record<number, number> = {
  10: 65, // Max Focus: Very sensitive, stop at 65 score
  9: 70,
  8: 75,
  7: 80,
  6: 85,
  5: 90, // Default Threshold
  4: 95,
  3: 100, // Very Low Focus: Timer only stops if score hits max
  2: 100,
  1: 100,
};

// ----------------------------------------------------------------------------------
// [UPDATED] Invisible Biological Governor (Hidden Time Limits in Minutes)
// This logic is hidden from the UI. The user sees a counting-up timer,
// but the session will auto-pause when these "Elite" performance caps are hit.
// 10: 5 / 60 creates exactly 5 seconds for rapid testing.
// ----------------------------------------------------------------------------------
const INTENSITY_TIME_CAPS: Record<number, number> = {
  1: 70,
  2: 80,
  3: 90,
  4: 50,
  5: 55,
  6: 60,
  7: 65,
  8: 30,
  9: 35,
  10: 5 / 60, // 5 seconds test mode
};
// ----------------------------------------------------------------------------------

const App: React.FC = () => {
  const [hasEntered, setHasEntered] = useState(false);
  const [mode, setMode] = useState<AppMode>(AppMode.FOCUS);
  const [status, setStatus] = useState<SessionStatus>(SessionStatus.IDLE);
  const [duration, setDuration] = useState(DEFAULT_DURATION);
  const [elapsed, setElapsed] = useState(0);

  // State: Track the user's Focus Intensity (default 5)
  const [focusIntensity, setFocusIntensity] = useState(5);
  const isFocusMode = mode === AppMode.FOCUS;

  // Supabase state
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const [isAuthLoading, setIsAuthLoading] = useState(true);
  const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);


  // Subscription Hook
  const { isPremium } = useSubscription();
  // const isPremium = false; // DEBUG: Hardcoded to false

  const [tasks, setTasks] = useState<Task[]>([]);
  const [alienMode, setAlienMode] = useState(false);

  // Fatigue state is initialized to null
  const [currentMetrics, setCurrentMetrics] = useState<FatigueMetrics | null>(null);
  const [metricsHistory, setMetricsHistory] = useState<FatigueMetrics[]>([]);
  const [insight, setInsight] = useState('Initializing quantum focus systems...');
  const [countdownRemaining, setCountdownRemaining] = useState<number | null>(null);
  const [pendingStartUserId, setPendingStartUserId] = useState<string | null>(null);
  const [shouldTriggerCountdown, setShouldTriggerCountdown] = useState(false); // [NEW] Centralized trigger flag

  // Layout Refs
  const tasksRef = useRef<HTMLDivElement>(null);
  const timerRefDiv = useRef<HTMLDivElement>(null);
  const vaultRef = useRef<HTMLDivElement>(null);

  // [NEW] Mobile detection state
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth < 768);
    };
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // CRITICAL: Main scaled content area reference - SVG parent
  const layoutWrapperRef = useRef<HTMLDivElement>(null);

  // Path States
  const [path1, setPath1] = useState<string>('');
  const [path2, setPath2] = useState<string>('');

  // Vault state
  const [barsToday, setBarsToday] = useState(0);
  const [totalBars, setTotalBars] = useState(0);

  const refreshVaultStats = useCallback(async () => {
    if (currentUser) {
      const stats = await databaseService.getVaultStats(currentUser.id);
      setBarsToday(stats.barsToday);
      setTotalBars(stats.totalBars);
    }
  }, [currentUser]);

  // --- 4. AUTH & SESSION INITIALIZATION ---
  useEffect(() => {
    const initAuth = async () => {
      console.log("[App] initAuth starting...");
      setIsAuthLoading(true);

      // Check if this is an OAuth callback
      const urlParams = new URLSearchParams(window.location.search);
      const isOAuthCallback = urlParams.get('authenticated') === 'true';

      // Clean up the URL if it's an OAuth callback
      if (isOAuthCallback) {
        console.log("[App] OAuth callback detected, cleaning URL...");
        window.history.replaceState({}, '', window.location.pathname);
      }

      try {
        const user = await authService.getUser();
        console.log("[App] initAuth found user:", user?.email || 'none');

        if (user) {
          setCurrentUser(user);
          const pendingPlan = localStorage.getItem('pending_plan');
          if (pendingPlan) {
            console.log("[App] initAuth: Redirecting to checkout for plan:", pendingPlan);
            const checkoutUrl = `/api/checkout?user_id=${encodeURIComponent(user.id)}&plan=${pendingPlan}`;
            window.location.href = checkoutUrl;
            return;
          }

          // If this is an OAuth callback or user is already authenticated, bypass landing page
          console.log("[App] initAuth: User authenticated, setting hasEntered = true");
          setHasEntered(true);

          const activeSession = await databaseService.getCurrentSession(user.id);
          if (activeSession) {
            console.log("[App] initAuth: Restoring active session:", activeSession.id);
            setCurrentSessionId(activeSession.id);
            setStatus(activeSession.status as SessionStatus);
            setElapsed(activeSession.elapsed_seconds);
            setFocusIntensity(activeSession.focus_intensity);

            if (activeSession.type === 'RELAX') setMode(AppMode.RELAX);
            setInsight(`Welcome back. Resuming ${activeSession.type.toLowerCase()} session.`);
          }

          // [CRITICAL] Check for pending session immediately after confirming user
          const pendingSession = localStorage.getItem('pending_session');
          if (pendingSession) {
            console.log("[App] initAuth: Detected pending session. Triggering restoration...");
            try {
              const sessionData = JSON.parse(pendingSession);
              localStorage.removeItem('pending_session');

              setInsight("Restoring your environment...");
              handleIntensityChange(sessionData.intensity);
              setInsight(sessionData.insight);

              await addTask(sessionData.task, user.id);

              // [FIX] Store data and set trigger instead of manual setTimeout
              setPendingStartUserId(user.id);
              setShouldTriggerCountdown(true);
              console.log("[App] initAuth Restoration: flags set for countdown trigger effect.");
            } catch (e) {
              console.error("[App] initAuth: Restoration failed", e);
            }
          }
        } else {
          console.log("[App] initAuth: No user found.");
          const ghostSessionId = localStorage.getItem(GHOST_SESSION_KEY);
          if (ghostSessionId) {
            console.log("[App] initAuth: Restoring ghost session:", ghostSessionId);
            setCurrentSessionId(ghostSessionId);
            setHasEntered(true);
            setInsight('Quantum session active. (Ghost Mode)');
          }
        }
      } catch (err) {
        console.error('[App] initAuth error:', err);
      } finally {
        console.log("[App] initAuth complete. isAuthLoading -> false");
        setIsAuthLoading(false);
      }
    };

    initAuth();

    // Listen for auth changes globally
    const subscription = authService.onAuthStateChange(async (user) => {
      console.log("[App] Auth State Changed. User:", user?.email);

      // Only trigger updates if the user actually CHANGED
      // This prevents re-triggering logic on initial load which relies on initAuth
      setCurrentUser(prevUser => {
        if (prevUser?.id === user?.id) return prevUser;
        return user;
      });

      if (!user) {
        console.log("[App] onAuthStateChange: User is NULL. resetting state.");
        setHasEntered(false);
        setCurrentSessionId(null);
        setTasks([]);
      } else {
        console.log("[App] onAuthStateChange: User found:", user.email, "setting hasEntered = true");
        setHasEntered(true);

        // [NEW] Also check for pending session here in case initAuth was too early
        const pendingSession = localStorage.getItem('pending_session');
        if (pendingSession) {
          console.log("[App] onAuthStateChange: Detected pending session. Restoring...");
          try {
            const sessionData = JSON.parse(pendingSession);
            localStorage.removeItem('pending_session');
            handleIntensityChange(sessionData.intensity);
            setInsight(sessionData.insight);
            addTask(sessionData.task, user.id);

            // [FIX] Store data and set trigger
            setPendingStartUserId(user.id);
            setShouldTriggerCountdown(true);
            console.log("[App] onAuthStateChange Restoration: flags set for countdown trigger effect.");
          } catch (e) {
            console.error("[App] onAuthStateChange: Restoration failed", e);
          }
        }

        // CHECK FOR PENDING PLAN REDIRECT (Race Condition Fix)
        const pendingPlan = localStorage.getItem('pending_plan');
        console.log("[App] Pending Plan Check:", pendingPlan);

        if (pendingPlan) {
          const msg = `[DEBUG] Redirecting to checkout for plan: ${pendingPlan}`;
          console.log(msg);
          // alert(msg); // Uncomment to force pause if needed

          // Redirect to checkout if they just signed up and intend to pay
          const checkoutUrl = `/api/checkout?user_id=${encodeURIComponent(user.id)}&plan=${pendingPlan}`;
          // Clear it to avoid loops, though redirect unloads page anyway
          localStorage.removeItem('pending_plan');
          window.location.href = checkoutUrl;
          return;
        }

        // HANDSHAKE: If a user just logged in and we have a ghost session, claim it
        const ghostSessionId = localStorage.getItem(GHOST_SESSION_KEY);
        if (ghostSessionId) {
          const success = await databaseService.claimGhostData(user.id, ghostSessionId);
          if (success) {
            localStorage.removeItem(GHOST_SESSION_KEY);
            setInsight('Data secured. Ghost session successfully linked to your account.');
          }
        }
      }
    });


    return () => {
      subscription.unsubscribe();
    };
  }, []);

  // --- 1. TIMER LOGIC (Preserved) ---
  useEffect(() => {
    let interval: NodeJS.Timeout | undefined;

    if (status === SessionStatus.RUNNING) {
      interval = setInterval(() => {
        setElapsed((prev) => prev + 1);
      }, 1000);
    }

    return () => {
      if (interval) clearInterval(interval);
    };
  }, [status]);
  // ---------------------------

  // --- 2. AI FATIGUE TRACKING LIFECYCLE (Updated to pass intensity) ---
  useEffect(() => {
    // Callback function to update metrics in App state
    const handleMetricsUpdate = (metrics: FatigueMetrics) => {
      setCurrentMetrics(metrics);
    };

    if (status === SessionStatus.RUNNING) {
      // Start tracking user input when the timer is running
      fatigueService.startTracking(handleMetricsUpdate, focusIntensity);
    } else {
      // Stop tracking when paused, idle, or completed
      fatigueService.stopTracking();
    }

    // Cleanup function: stop tracking when the component unmounts or status changes away from RUNNING
    return () => {
      fatigueService.stopTracking();
    };
  }, [status, focusIntensity]);
  // ---------------------------

  // --- 3. [UPDATED] AI INTERVENTION LOGIC (ADAPTIVE: Checks score AND Hidden Time Caps) ---
  useEffect(() => {
    const score = currentMetrics?.fatigueScore || 0;

    // Get the dynamic threshold based on user's selected intensity
    const criticalThreshold = INTENSITY_THRESHOLDS[focusIntensity] || 90;

    // Get the hidden biological cap (minutes converted to seconds)
    const hiddenTimeLimit = (INTENSITY_TIME_CAPS[focusIntensity] || 60) * 60;

    if (status === SessionStatus.RUNNING) {
      // STOP TRIGGER: Fatigue hits threshold OR secret time limit reached
      if (score >= criticalThreshold || elapsed >= hiddenTimeLimit) {

        // AI automatically stops the timer
        setStatus(SessionStatus.PAUSED);

        // [SENSORY CUE] Audio & Haptic Feedback - "Glass Bowl" Chime
        try {
          const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
          if (AudioContext) {
            const ctx = new AudioContext();
            const now = ctx.currentTime;
            const fundamental = 174.61; // F3
            [1.0, 1.5, 2.0, 3.5].forEach((ratio, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.value = fundamental * ratio;
              gain.gain.setValueAtTime(0, now);
              gain.gain.linearRampToValueAtTime(0.08 - (i * 0.015), now + 0.1);
              gain.gain.exponentialRampToValueAtTime(0.0001, now + 3.5);
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.start(now);
              osc.stop(now + 3.5);
            });
          }
          if (navigator.vibrate) navigator.vibrate([40, 60, 40]);
        } catch (e) {
          console.error("Sensory cue failed:", e);
        }

        if (elapsed >= hiddenTimeLimit) {
          // [PRO NARRATIVE] Professional, high-status feedback
          setInsight(`Optimal focus window utilized. Initiating recovery sequence to preserve cognitive gold.`);
        } else {
          // Message when biometric fatigue is detected
          setInsight(`🚨 Critical Fatigue Detected (${score}%). Session paused based on Intensity ${focusIntensity}/10 threshold of ${criticalThreshold}%.`);
        }

        // AUTH WALL: Trigger modal on auto-pause if not logged in
        if (!currentUser) {
          setIsAuthModalOpen(true);
        }

        if (currentMetrics) {
          setMetricsHistory(prev => [...prev, currentMetrics]);

          // CRITICAL: Save last metrics before pausing
          if (currentSessionId) {
            databaseService.saveMetrics(currentSessionId, currentMetrics);
          }
        }
      }
    }
  }, [currentMetrics?.fatigueScore, status, focusIntensity, elapsed]);
  // ---------------------------

  // Utility to get coordinates from the path string for connection points
  const getPathCoords = useCallback((path: string, type: 'start' | 'end') => {
    const parts = path.trim().split(/\s+/);
    if (parts.length < 3) return { x: 0, y: 0 };

    if (type === 'start') {
      return { x: parseFloat(parts[1]) || 0, y: parseFloat(parts[2]) || 0 };
    }

    if (type === 'end' && parts.length > 8) {
      // The end point of a Cubic Bezier curve is the last two numbers
      return {
        x: parseFloat(parts[parts.length - 2]) || 0,
        y: parseFloat(parts[parts.length - 1]) || 0
      };
    }

    return { x: 0, y: 0 };
  }, []);

  // Path calculation logic
  const updatePaths = useCallback(() => {
    if (!layoutWrapperRef.current || !tasksRef.current || !timerRefDiv.current || !vaultRef.current) {
      return;
    }

    // Get bounds relative to the main layout wrapper
    const wrapperRect = layoutWrapperRef.current.getBoundingClientRect();
    const tasksRect = tasksRef.current.getBoundingClientRect();
    const timerRect = timerRefDiv.current.getBoundingClientRect();
    const vaultRect = vaultRef.current.getBoundingClientRect();

    // Determine current scale used in CSS
    const currentScale = typeof window !== 'undefined' && window.innerWidth < 768 ? 1 : SCALE_FACTOR;

    // Function to calculate relative coordinates (adjusting for the dynamic scale)
    const relativeX = (rect: DOMRect) => (rect.left - wrapperRect.left) / currentScale;
    const relativeY = (rect: DOMRect) => (rect.top - wrapperRect.top) / currentScale;

    const getWidth = (rect: DOMRect) => rect.width / currentScale;
    const getHeight = (rect: DOMRect) => rect.height / currentScale;

    // Path 1: Tasks (Right Center) → Timer (Left Center)
    const startX1 = relativeX(tasksRect) + getWidth(tasksRect) - 4;
    const startY1 = relativeY(tasksRect) + getHeight(tasksRect) / 2;
    const endX1 = relativeX(timerRect) + 4;
    const endY1 = relativeY(timerRect) + getHeight(timerRect) / 2;

    const controlOffset1 = 60;
    const path1String = `M ${startX1} ${startY1} C ${startX1 + controlOffset1} ${startY1} ${endX1 - controlOffset1} ${endY1} ${endX1} ${endY1}`;
    setPath1(path1String);

    // Path 2: Timer (Right Center) → Vault (Left Center)
    const startX2 = relativeX(timerRect) + getWidth(timerRect) - 4;
    const startY2 = relativeY(timerRect) + getHeight(timerRect) / 2;
    const endX2 = relativeX(vaultRect) + 4;
    const endY2 = relativeY(vaultRect) + getHeight(vaultRect) / 2;

    const controlOffset2 = 60;
    const path2String = `M ${startX2} ${startY2} C ${startX2 + controlOffset2} ${startY2} ${endX2 - controlOffset2} ${endY2} ${endX2} ${endY2}`;
    setPath2(path2String);

  }, []);


  // Handler functions
  const handleStart = useCallback(async (overrideUserId?: string) => {
    console.log("[App] handleStart invoked. overrideUserId:", overrideUserId);
    const effectiveUserId = overrideUserId || currentUser?.id || null;

    if (elapsed >= duration) {
      setElapsed(0);
      setCurrentMetrics(null);
      setStatus(SessionStatus.IDLE);
      setInsight('Ready to initiate Deep Work sequence.');
      return;
    }

    console.log("[App] handleStart: status -> RUNNING, insight -> AI optimizing focus...");
    setCurrentMetrics(null);
    setStatus(SessionStatus.RUNNING);
    setInsight('AI optimizing focus...');

    if (!currentSessionId) {
      console.log("[App] Creating fresh session for user:", effectiveUserId);
      const sessionId = await databaseService.createSession(effectiveUserId, {
        duration_seconds: duration,
        type: 'FOCUS',
        focus_intensity: focusIntensity,
      });
      if (sessionId) {
        setCurrentSessionId(sessionId);
        if (!effectiveUserId) {
          localStorage.setItem(GHOST_SESSION_KEY, sessionId);
        }
      }
    } else {
      console.log("[App] Resuming existing session:", currentSessionId);
      await databaseService.updateSession(currentSessionId, {
        status: 'RUNNING',
      });
    }
  }, [currentUser, duration, focusIntensity, currentSessionId, elapsed]);
  const handlePause = async () => {
    // AUTH WALL: Intercept pause if not logged in
    if (!currentUser) {
      setIsAuthModalOpen(true);
      return;
    }

    setStatus(SessionStatus.PAUSED);
    // Update session status in database
    if (currentSessionId) {
      await databaseService.updateSession(currentSessionId, {
        status: 'PAUSED',
        elapsed_seconds: elapsed,
      });
    }
  };

  const handleReset = async () => {
    // Capture elapsed time for vault calculation before resetting
    const sessionElapsed = elapsed;

    setStatus(SessionStatus.IDLE);
    setElapsed(0);
    // CRITICAL: Reset fatigue metrics on full session reset
    setCurrentMetrics(null);
    setInsight('Ready to initiate Deep Work sequence.');

    // Mark session as completed in database
    if (currentSessionId) {
      await databaseService.updateSession(currentSessionId, {
        status: 'COMPLETED',
        elapsed_seconds: sessionElapsed,
        end_time: new Date().toISOString(),
      });

      // If it was a focus session, earn 1 bar per 10 minutes (600 seconds)
      if (mode === AppMode.FOCUS && currentUser) {
        const barsEarned = Math.floor(sessionElapsed / 600);
        if (barsEarned > 0) {
          await databaseService.incrementTotalReserve(currentUser.id, barsEarned);
          await refreshVaultStats();

          // Increment free sessions usage if not premium
          if (!isPremium && sessionElapsed > 600) {
            await databaseService.incrementFreeSessionsUsed(currentUser.id);
          }
        }
      }

      setCurrentSessionId(null);
    }
  };

  const handleSignOut = async () => {
    await authService.signOut();
    // State is handled by onAuthStateChange listener
  };

  const handleIntensityChange = (intensity: number) => {
    // Validate the intensity is within 1-10 range and update state
    const validatedIntensity = Math.max(1, Math.min(10, intensity));
    setFocusIntensity(validatedIntensity);

    // Dynamically update the hidden 'duration' goal based on the mapping
    const secretMinutes = INTENSITY_TIME_CAPS[validatedIntensity] || 60;
    setDuration(secretMinutes * 60);

    setInsight(`Focus Intensity set to ${validatedIntensity}/10. AI detection threshold adjusted.`);
  };

  const toggleTask = async (id: string) => {
    const task = tasks.find(t => t.id === id);
    if (!task) return;

    const newCompleted = !task.completed;
    setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: newCompleted } : t));

    // Update in database
    if (currentUser) {
      await databaseService.updateTask(id, { completed: newCompleted });
    }
  };

  const addTask = useCallback(async (title: string, overrideUserId?: string) => {
    console.log("[App] addTask invoked. Title:", title, "overrideUserId:", overrideUserId);
    const effectiveUserId = overrideUserId || currentUser?.id || null;
    console.log("[App] effectiveUserId:", effectiveUserId);

    if (!effectiveUserId) {
      console.log("[App] No user ID, adding task to local state only");
      const newTask = { id: Date.now().toString(), title, completed: false, priority: 'medium' as const };
      setTasks(prev => {
        console.log("[App] Previous tasks:", prev);
        const updated = [...prev, newTask];
        console.log("[App] Updated tasks:", updated);
        return updated;
      });
      console.log("[App] Local task added");
      return;
    }

    try {
      console.log("[App] User ID exists, creating task in database...");
      const dbTask = await databaseService.createTask(effectiveUserId, {
        title,
        priority: 'medium',
        session_id: currentSessionId || undefined,
      });

      if (dbTask) {
        const newTask = databaseService.dbTaskToTask(dbTask);
        setTasks(prev => [...prev, newTask]);
        console.log("[App] Database task added to state");
      } else {
        throw new Error("Database returned null");
      }
    } catch (e) {
      console.error("[App] Failed to create task in database, falling back to local state:", e);
      // FALLBACK: Add to local state anyway so user sees it
      const newTask = { id: Date.now().toString(), title, completed: false, priority: 'medium' as const };
      setTasks(prev => [...prev, newTask]);
    }
  }, [currentUser, currentSessionId]);

  // Layout observer (Preserved)
  // Layout observer
  useEffect(() => {
    if (!layoutWrapperRef.current) return;

    let animationFrameId: number;
    let startTime = Date.now();

    const tick = () => {
      updatePaths();
      // Run continuously for a short period to catch initial layout stabilization
      if (Date.now() - startTime < 1500) {
        animationFrameId = requestAnimationFrame(tick);
      }
    };

    tick();

    const handleResize = () => {
      updatePaths();
    };

    window.addEventListener('resize', handleResize);

    const resizeObserver = new ResizeObserver(() => {
      requestAnimationFrame(updatePaths);
    });

    // Observe the main wrapper that defines the coordinate system
    if (layoutWrapperRef.current) {
      resizeObserver.observe(layoutWrapperRef.current);
    }

    // Observe the components being connected
    if (tasksRef.current) resizeObserver.observe(tasksRef.current);
    if (timerRefDiv.current) resizeObserver.observe(timerRefDiv.current);
    if (vaultRef.current) resizeObserver.observe(vaultRef.current);

    return () => {
      window.removeEventListener('resize', handleResize);
      cancelAnimationFrame(animationFrameId);
      resizeObserver.disconnect();
    };
  }, [updatePaths, mode, tasks, hasEntered, isFocusMode]);

  // Load user tasks on mount and subscribe to changes
  useEffect(() => {
    let subscription: any;

    const loadUserData = async () => {
      if (currentUser) {
        // Load initial tasks from database
        const dbTasks = await databaseService.getTasks(currentUser.id, false);
        const appTasks = dbTasks.map(databaseService.dbTaskToTask);
        setTasks(appTasks);

        // Subscribe to real-time updates
        subscription = databaseService.subscribeToTasks(currentUser.id, (payload) => {
          if (payload.eventType === 'INSERT') {
            const newTask = databaseService.dbTaskToTask(payload.new as any);
            setTasks(prev => {
              // Avoid duplicates
              if (prev.some(t => t.id === newTask.id)) return prev;
              return [newTask, ...prev];
            });
          } else if (payload.eventType === 'UPDATE') {
            const updatedTask = databaseService.dbTaskToTask(payload.new as any);
            setTasks(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
          } else if (payload.eventType === 'DELETE') {
            setTasks(prev => prev.filter(t => t.id === payload.old.id));
          }
        });
      }
    };

    loadUserData();
    refreshVaultStats();

    return () => {
      if (subscription) subscription.unsubscribe();
    };
  }, [currentUser, refreshVaultStats]);

  // Save metrics periodically
  useEffect(() => {
    if (currentMetrics && currentSessionId && status === SessionStatus.RUNNING) {
      // Save metrics every 10 seconds
      const saveInterval = setInterval(async () => {
        if (currentMetrics) {
          await databaseService.saveMetrics(currentSessionId, currentMetrics);
        }
      }, 10000);

      return () => clearInterval(saveInterval);
    }
  }, [currentMetrics, currentSessionId, status]);

  // Update session elapsed time periodically
  useEffect(() => {
    if (currentSessionId && status === SessionStatus.RUNNING) {
      const updateInterval = setInterval(async () => {
        await databaseService.updateSession(currentSessionId, {
          elapsed_seconds: elapsed,
        });
      }, 30000); // Every 30 seconds

      return () => clearInterval(updateInterval);
    }
  }, [currentSessionId, status, elapsed]);

  // The pending session restoration is now handled directly in initAuth and onAuthStateChange
  // to prevent race conditions where hasEntered is set to true before this effect can run.
  useEffect(() => {
    // Primary restoration logic moved to initAuth and onAuthStateChange
  }, [currentUser, hasEntered]);

  // [NEW] Centralized effect to trigger the countdown after the dashboard mounts
  useEffect(() => {
    if (hasEntered && shouldTriggerCountdown) {
      console.log("[App] DEBUG: shouldTriggerCountdown is TRUE", { status, countdownRemaining });

      if (countdownRemaining === null) {
        setShouldTriggerCountdown(false);
        console.log("[App] Firing auto-start sequence...");

        const t = setTimeout(() => {
          console.log("[App] Setting countdownRemaining = 3");
          setCountdownRemaining(3);
        }, 1000);

        return () => clearTimeout(t);
      }
    }
  }, [hasEntered, shouldTriggerCountdown, countdownRemaining, status]);

  // Countdown Timer for session start from landing page
  useEffect(() => {
    if (countdownRemaining !== null && countdownRemaining > 0) {
      console.log(`[App] Countdown Tick: ${countdownRemaining}`);
      const timer = setTimeout(() => {
        setCountdownRemaining(prev => (prev !== null ? prev - 1 : null));
      }, 1000);
      return () => clearTimeout(timer);
    } else if (countdownRemaining === 0) {
      console.log("[App] Countdown hit zero! Starting session...");
      setCountdownRemaining(null);
      // Use the stored user ID for timer start
      handleStart(pendingStartUserId || undefined);
      // Clear the pending user ID after starting
      setPendingStartUserId(null);
    }
  }, [countdownRemaining, handleStart, pendingStartUserId]);

  if (isAuthLoading) {
    return (
      <div className="min-h-screen bg-[#09090b] flex flex-col items-center justify-center space-y-4">
        <div className="w-12 h-12 border-2 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin" />
        <p className="text-[10px] text-zinc-500 uppercase tracking-[0.2em] animate-pulse">Synchronizing auth state...</p>
      </div>
    );
  }

  // [URGENT] Move Notification to the VERY top level of the render to ensure visibility
  const CountdownOverlay = (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, zIndex: 9999, pointerEvents: 'none' }}>
      {countdownRemaining !== null && console.log("[App] Rendering CountdownOverlay with value:", countdownRemaining)}
      <AnimatePresence>
        {countdownRemaining !== null && (
          <div style={{ pointerEvents: 'auto' }}>
            <CountdownNotification countdown={countdownRemaining} />
          </div>
        )}
      </AnimatePresence>
    </div>
  );

  if (!hasEntered) {
    return (
      <>
        <div className="fixed bottom-2 right-2 text-[8px] text-white/20 z-[9999] pointer-events-none uppercase tracking-widest">
          Sync Engine v1.0.7-BUILD
        </div>
        {CountdownOverlay}
        <LandingPage onEnter={async (data: any) => {
          console.log("[App] onEnter called from LandingPage with data:", !!data);
          setHasEntered(true);
          if (data) {
            const userId = data.user?.id || currentUser?.id;
            console.log("[App] onEnter Processing: userId =", userId, "intensity =", data.intensity);

            if (data.user) setCurrentUser(data.user);

            handleIntensityChange(data.intensity);
            setInsight(data.insight);
            setElapsed(0);
            setCurrentMetrics(null);
            setStatus(SessionStatus.IDLE);
            setPendingStartUserId(userId || null);

            console.log("[App] onEnter: setting shouldTriggerCountdown = true");
            setShouldTriggerCountdown(true);

            // [FAILSAFE] In case the centralized useEffect misses the trigger due to 
            // rapid state updates, we add a decoupled backup trigger after 2 seconds.
            setTimeout(() => {
              setShouldTriggerCountdown(prev => {
                if (prev) {
                  console.warn("[App] Failsafe: shouldTriggerCountdown was still true. Forcing trigger...");
                  setCountdownRemaining(3);
                  return false;
                }
                return prev;
              });
            }, 2500);

            await addTask(data.task, userId);
          }
        }} />
      </>
    );
  }




  const path1Start = getPathCoords(path1, 'start');
  const path1End = getPathCoords(path1, 'end');
  const path2Start = getPathCoords(path2, 'start');
  const path2End = getPathCoords(path2, 'end');

  // Pre-calculate focus mode boolean for usage in the layout below
  // (Moved higher to avoid use-before-define)


  return (
    <div
      className={`h-screen bg-transparent text-gray-200 selection:bg-primary/30 relative overflow-hidden flex flex-col ${alienMode ? 'font-alien' : 'font-sans'}`}
    >
      {/* VERSION TAG FOR DEBUGGING */}
      <div className="fixed bottom-2 right-2 text-[8px] text-white/20 z-[9999] pointer-events-none uppercase tracking-widest">
        Sync Engine v1.0.7-BUILD
      </div>
      {CountdownOverlay}
      <Background />
      <CosmicParticles />
      <QuantumRippleBackground zIndex={5} />
      <AIWhisper />
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-indigo-500/5 blur-[120px] rounded-full pointer-events-none z-0" />
      <Sidebar
        currentMode={mode}
        setMode={setMode}
        alienMode={alienMode}
        toggleAlienMode={() => setAlienMode(!alienMode)}
        onSignOut={handleSignOut}
        user={currentUser}
      />

      <AuthModal
        isOpen={isAuthModalOpen}
        onClose={() => setIsAuthModalOpen(false)}
        onSuccess={(user) => {
          setCurrentUser(user);
          setIsAuthModalOpen(false);
          // Handshake logic is triggered by onAuthStateChange in useEffect
        }}
        intensityMode={insight.includes('Intensity') ? insight.split(' threshold')[0].replace('🚨 ', '') : 'Focus Mode'}
      />

      {/* AI Optimized Indicator displayed globally in the top right */}
      <AIOptimizedIndicator currentInsight={insight} />

      {/* Main Content Area */}
      <main
        className="flex-1 relative w-full h-full z-10 flex flex-col items-center justify-center md:pl-72"
        style={{ perspective: '1600px' }}
      >
        <AnimatePresence mode="wait">
          <MotionDiv
            key={mode}
            initial={{ opacity: 0, rotateY: 3, scale: 0.96, filter: 'blur(8px)', y: 15 }}
            animate={{
              opacity: 1,
              rotateY: 0,
              scale: 1,
              filter: 'blur(0px)',
              y: 0,
              transition: {
                duration: 0.7,
                ease: [0.22, 1, 0.36, 1],
                y: { type: 'spring', stiffness: 100, damping: 20 }
              }
            }}
            exit={{
              opacity: 0,
              rotateY: -3,
              scale: 0.96,
              filter: 'blur(8px)',
              y: -15,
              transition: { duration: 0.5, ease: "easeIn" }
            }}
            className="w-full max-w-[1800px] px-6 relative flex flex-col items-center justify-center"
            style={{ transformStyle: 'preserve-3d' }}
          >

            <div className="w-full h-full flex items-start justify-center pt-32 relative">
              {/* Scaled Layout Wrapper - SVG Parent */}
              <div
                ref={layoutWrapperRef}
                className="flex flex-col md:flex-row justify-start items-center md:items-start w-full max-w-[1600px] px-4 relative"
                style={{
                  transform: typeof window !== 'undefined' && window.innerWidth < 768 ? 'none' : `scale(${SCALE_FACTOR})`,
                  transformOrigin: 'center',
                  // CRITICAL FIX: Hide when not in FOCUS mode, but KEEP IT IN THE DOM
                  opacity: isFocusMode ? 1 : 0,
                  pointerEvents: isFocusMode ? 'auto' : 'none',
                  transition: 'opacity 0.5s ease-out'
                }}
              >
                {/* PRO DATABASE CONNECTION LINES - SVG REMAINS ALWAYS RENDERED */}
                <svg
                  className="absolute top-0 left-0 w-full h-full overflow-visible pointer-events-none z-40 hidden md:block"
                  style={{ isolation: 'isolate' }}
                >
                  <defs>
                    {/* High visibility gradient */}
                    <linearGradient id="connection-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#818cf8" stopOpacity="0.2" />
                      <stop offset="50%" stopColor="#c7d2fe" stopOpacity="0.4" />
                      <stop offset="100%" stopColor="#818cf8" stopOpacity="0.2" />
                    </linearGradient>

                    {/* Subtle Glow */}
                    <filter id="subtle-glow" x="-50%" y="-50%" width="200%" height="200%">
                      <feGaussianBlur in="SourceGraphic" stdDeviation="1" result="blur" />
                      <feMerge>
                        <feMergeNode in="blur" />
                        <feMergeNode in="SourceGraphic" />
                      </feMerge>
                    </filter>

                    {/* Perfect Geometric Arrow */}
                    <marker
                      id="arrow-head"
                      markerWidth="4"
                      markerHeight="4"
                      refX="3.5"
                      refY="2"
                      orient="auto"
                    >
                      <path
                        d="M0,0 L4,2 L0,4 Z"
                        fill="#c7d2fe"
                      />
                    </marker>
                  </defs>

                  {/* CONNECTION 1: Tasks → Timer */}
                  {path1 && (
                    <g filter="url(#subtle-glow)">
                      <path
                        d={path1}
                        fill="none"
                        stroke="url(#connection-gradient)"
                        strokeWidth="1.5"
                        strokeDasharray="8 8"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        markerEnd="url(#arrow-head)"
                        className="transition-all duration-500"
                      >
                        <animate
                          attributeName="stroke-dashoffset"
                          from="0"
                          to="8"
                          dur="3s"
                          repeatCount="indefinite"
                          calcMode="linear"
                        />
                      </path>
                      <circle r="1.5" fill="#e0e7ff" fillOpacity="0.8">
                        <animateMotion
                          dur="4s"
                          repeatCount="indefinite"
                          path={path1}
                          rotate="auto"
                        />
                      </circle>
                    </g>
                  )}

                  {/* CONNECTION 2: Timer → Vault */}
                  {path2 && (
                    <g filter="url(#subtle-glow)">
                      <path
                        d={path2}
                        fill="none"
                        stroke="url(#connection-gradient)"
                        strokeWidth="1.5"
                        strokeDasharray="8 8"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        markerEnd="url(#arrow-head)"
                        className="transition-all duration-500"
                      >
                        <animate
                          attributeName="stroke-dashoffset"
                          from="0"
                          to="8"
                          dur="3s"
                          repeatCount="indefinite"
                          calcMode="linear"
                          begin="1s"
                        />
                      </path>
                      <circle r="1.5" fill="#e0e7ff" fillOpacity="0.8">
                        <animateMotion
                          dur="4s"
                          repeatCount="indefinite"
                          path={path2}
                          rotate="auto"
                          begin="2s"
                        />
                      </circle>
                    </g>
                  )}
                </svg>

                {/* Main Dashboard Stacking Container */}
                {/* Main Dashboard Stacking Container */}
                <div className="flex flex-col md:flex-row items-center justify-center gap-12 md:gap-0 pt-20 md:pt-0">
                  {/* 1. Left Column: Contextual Tasks */}
                  <div ref={tasksRef} className={`w-full max-w-[16rem] min-h-[13rem] relative z-20 transition-opacity duration-700 ${isFocusMode ? 'opacity-100 animate-in slide-in-from-left-8 fade-in' : 'opacity-0'}`}>
                    {/* Only render TaskList content when in Focus mode */}
                    {isFocusMode ? (
                      <TaskList tasks={tasks} onToggle={toggleTask} onAdd={addTask} />
                    ) : (
                      <div className="h-full w-full" /> // Placeholder to maintain ref size/position
                    )}
                  </div>

                  {/* Connector 1 Placeholder - HIDDEN ON MOBILE */}
                  {!isMobile && <div className="w-[16rem] relative z-0 pointer-events-none" />}

                  {/* 2. Center Column: AI Optimized - RENDERED ALWAYS */}
                  <div ref={timerRefDiv} className={`w-full max-w-[20rem] h-[15rem] relative z-30 transition-opacity duration-1000 ${isFocusMode ? 'opacity-100 animate-in zoom-in-95 fade-in' : 'opacity-0'}`}>
                    {/* Only render FocusTimer content when in Focus mode */}
                    {isFocusMode ? (
                      <FocusTimer
                        status={status}
                        elapsedSeconds={elapsed}
                        durationSeconds={duration}
                        fatigueScore={currentMetrics?.fatigueScore || 0}
                        onStart={() => handleStart()}
                        onPause={handlePause}
                        onReset={handleReset}
                        onIntensityChange={handleIntensityChange}
                        currentIntensity={focusIntensity}
                        currentInsight={insight}
                      />
                    ) : (
                      <div className="h-full w-full" /> // Placeholder to maintain ref size/position
                    )}
                  </div>

                  {/* Connector 2 Placeholder - HIDDEN ON MOBILE */}
                  {!isMobile && <div className="w-[16rem] relative z-0 pointer-events-none" />}

                  {/* 3. Right Column: Gold Vault - RENDERED ALWAYS */}
                  <div ref={vaultRef} className={`w-full max-w-[16rem] h-[9.25rem] mt-0 md:mt-24 relative z-20 transition-opacity duration-700 ${isFocusMode ? 'opacity-100 animate-in slide-in-from-right-8 fade-in' : 'opacity-0'}`}>
                    {/* Only render GoldVault content when in Focus mode */}
                    {isFocusMode ? (
                      <GoldVault
                        progress={(elapsed / duration) * 100}
                        barsToday={barsToday}
                        totalBars={totalBars}
                      />
                    ) : (
                      <div className="h-full w-full" /> // Placeholder to maintain ref size/position
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* 2. ABSOLUTE CONTAINER for STATS and RELAX modes to overlay FocusLayout 
                 without causing layout shifts. 
            */}
            <div className={`absolute inset-0 flex items-center justify-center pointer-events-${mode !== AppMode.FOCUS ? 'auto' : 'none'}`}>

              <AnimatePresence>
                {mode === AppMode.RELAX && (
                  <MotionDiv
                    key="relax"
                    initial={{ opacity: 0, y: 50, scale: 0.9 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: -50, scale: 0.9 }}
                    transition={{ duration: 0.5 }}
                  >
                    <RelaxTimer
                      onComplete={() => {
                        setMode(AppMode.FOCUS);
                        setStatus(SessionStatus.IDLE);
                        setElapsed(0);
                        setDuration(DEFAULT_DURATION);
                      }}
                      fatigueScore={currentMetrics?.fatigueScore || 50}
                    />
                  </MotionDiv>
                )}
              </AnimatePresence>


              <AnimatePresence>
                {mode === AppMode.STATS && (
                  <MotionDiv
                    key="stats"
                    initial={{ opacity: 0, y: 50, scale: 0.9 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: -50, scale: 0.9 }}
                    transition={{ duration: 0.5 }}
                  >
                    <StatsView metricsHistory={metricsHistory} />
                  </MotionDiv>
                )}
              </AnimatePresence>

            </div>

          </MotionDiv>
        </AnimatePresence>
      </main>
    </div >
  );
};

export default App;
</file>

</files>
